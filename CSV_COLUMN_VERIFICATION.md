# 🔍 CSV Column Verification Report

**Analysis Date:** August 15, 2025  
**Based on:** Local pipeline test + Latest workflow logs

## ❌ **ISSUES FOUND**

### 1. **Backend SQL Error (Daily Workflow)**
```
Database connection failed: column "dynamic_league_tier" does not exist
LINE 5: COALESCE(dynamic_league_tier, league_tier) as tier,
```

**Problem:** `.github/workflows/daily.yml` line 198 references `dynamic_league_tier` but the `bets` table schema only has `tier`.

**Actual Schema:** `tier int` (not `dynamic_league_tier` or `league_tier`)

---

### 2. **Frontend vs CSV Column Mapping**

#### ✅ **CORRECT Mappings:**

**Frontend `parseMetrics()`:**
- ✅ Uses `row.metric` and `row.value` → Matches `metrics.csv` structure

**Frontend `parseBankrollSeries()`:**
- ✅ Uses `row.dt_gmt8` and `row.cum_bankroll` → Matches `bankroll_series_90d.csv`

**Frontend `parseRecommendations()`:**
- ✅ Uses `row.dt_gmt8`, `row.league`, `row.home`, `row.away`, `row.rec_text`, `row.line`, `row.odds`, `row.ev`, `row.confidence`
- ✅ Matches `latest_recommendations.csv` structure perfectly

**Frontend `parseSettledBets()`:**
- ✅ Uses `row.home`, `row.away` (was fixed from `row.home_team`, `row.away_team`)
- ✅ Uses `row.bet_type_refined_ah`, `row.line_betted_on_refined`, `row.odds_betted_on_refined`
- ✅ Matches `settled_bets.csv` structure

---

## 🔧 **FIXES NEEDED**

### **Fix 1: Backend SQL Column Reference**

**File:** `.github/workflows/daily.yml` line 198  
**Current:**
```sql
COALESCE(dynamic_league_tier, league_tier) as tier,
```

**Should be:**
```sql
COALESCE(tier, 1) as tier,
```

**Reason:** The `bets` table schema uses `tier int`, not `dynamic_league_tier` or `league_tier`.

---

## ✅ **VERIFICATION RESULTS**

### **CSV Files Frontend Accesses:**
1. `metrics.csv` → ✅ Correct columns
2. `pnl_by_month.csv` → ✅ Raw usage (no parsing issues)
3. `bankroll_series_90d.csv` → ✅ Correct columns
4. `latest_recommendations.csv` → ✅ Correct columns  
5. `roi_heatmap.csv` → ✅ Raw usage (no parsing issues)
6. `top_segments.csv` → ✅ Raw usage (no parsing issues)
7. `settled_bets.csv` → ✅ Correct columns (fixed previously)

### **Database Schema vs CSV Export:**
- ✅ Most columns align correctly
- ❌ One mismatch: `tier` vs `dynamic_league_tier`

---

## 📊 **Complete Column Cross-Reference**

### **`metrics.csv`** (Generated by workflow)
| CSV Column | Frontend Usage | Status |
|------------|----------------|---------|
| `metric` | `row.metric` | ✅ |
| `value` | `row.value` | ✅ |

### **`latest_recommendations.csv`** (Generated by workflow)
| CSV Column | Frontend Usage | Status |
|------------|----------------|---------|
| `dt_gmt8` | `row.dt_gmt8` | ✅ |
| `league` | `row.league` | ✅ |
| `home` | `row.home` | ✅ |
| `away` | `row.away` | ✅ |
| `rec_text` | `row.rec_text` | ✅ |
| `line` | `row.line` | ✅ |
| `odds` | `row.odds` | ✅ |
| `ev` | `row.ev` | ✅ |
| `confidence` | `row.confidence` | ✅ |

### **`settled_bets.csv`** (Generated by workflow)
| CSV Column | Frontend Usage | Status |
|------------|----------------|---------|
| `fixture_id` | Not used directly | ✅ |
| `league` | `row.league` | ✅ |
| `home` | `row.home` | ✅ |
| `away` | `row.away` | ✅ |
| `home_score` | Not used directly | ✅ |
| `away_score` | Not used directly | ✅ |
| `line_betted_on_refined` | `row.line_betted_on_refined` | ✅ |
| `bet_type_refined_ah` | `row.bet_type_refined_ah` | ✅ |
| `odds_betted_on_refined` | `row.odds_betted_on_refined` | ✅ |
| `stake` | `row.stake` | ✅ |
| `pl` | `row.pl` | ✅ |
| `status` | `row.status` | ✅ |
| `dt_gmt8` | `row.dt_gmt8` | ✅ |

### **`bankroll_series_90d.csv`** (Generated by workflow)
| CSV Column | Frontend Usage | Status |
|------------|----------------|---------|
| `dt_gmt8` | `row.dt_gmt8` | ✅ |
| `cum_bankroll` | `row.cum_bankroll` | ✅ |

---

## 🎯 **SUMMARY**

**Frontend Column Usage: 100% CORRECT** ✅  
**Backend SQL Issue: 1 column mismatch** ❌

The frontend is perfectly aligned with the CSV structures! The only issue is the backend SQL query using the wrong column name.

**Action Required:** Fix the SQL query in daily workflow.
