# Dashboard CSV Integration Guide

This document describes the CSV data contracts for integrating the Lovable dashboard with the GBM football betting model.

## Schema

This section documents the column schemas, types, and semantics for each CSV. Unless noted, numeric fields are decimal numbers; empty strings should be treated as null.

### metrics.csv
Columns:
- metric (string): metric name
- value (string/number): metric value; treat empty as null

Notes:
- poisson_home_loss, poisson_away_loss are losses (lower is better)
- pnl_30d, stake_30d are in stake currency units
- roi_30d_pct is percent (e.g., 13.28 means 13.28%)

### roi_heatmap.csv
Columns:
- tier (integer): league tier bucket (1–5)
- line (number): AH line binned to nearest 0.25 (e.g., -1.0, -0.75, 0, 0.25)
- roi_pct (number): ROI in percent for the cell
- n (integer): number of bets in the cell

Notes:
- Use tier and line for heatmap axes; color by roi_pct; show n as annotation/tooltip

### top_segments.csv
Columns:
- tier (integer)
- line (number)
- roi_pct (number)
- n (integer)

Notes:
- Filtered to segments with n >= 30, sorted by roi_pct desc

### latest_recommendations.csv
Columns (from database export):
- dt_gmt8 (datetime string): fixture datetime in GMT+8 (ISO-like)
- league (string)
- home (string)
- away (string)
- rec_text (string): recommendation text (e.g., "Arsenal -0.5"); may include minus signs
- line (number): recommended AH line
- odds (number): decimal odds for the recommended side
- ev (number): expected value per 1 stake unit
- confidence (string): one of High, Medium, Very Low

Notes:
- Display timezone as GMT+8; show EV as e.g., +8.7% (ev*100)

### pnl_by_month.csv
Columns:
- month (YYYY-MM string)
- league (string)
- pnl (number): profit/loss in stake currency units

Notes:
- Aggregate by month for charts; sum across leagues for a total series if needed

### bankroll_series_90d.csv
Columns:
- dt_gmt8 (datetime string): date/time in GMT+8
- cum_bankroll (number): cumulative bankroll value

Notes:
- Use as a time series; treat as monotone cumulative curve

### Additional columns (artifact recommendations CSV)
When reading the model’s artifact CSVs in `artifacts/latest/` (not the site DB export), recommendation rows may include:
- datetime_gmt8, league, home_name, away_name
- Recommendation (string), confidence_level (string)
- line_betted_on_refined (number), odds_betted_on_refined (number), ev_for_bet_refined (number)
- pred_home_goals, pred_away_goals (numbers)
- synth_ah_line_home_market_based (number)
- competition_type (string), league_tier (integer)
- shap_home_explanation, shap_away_explanation (strings; semi-colon delimited top features)

These are useful for richer tooltips and detail panels if you choose to read artifacts directly.

### CSV parsing
- Prefer a robust CSV parser (PapaParse or d3-dsv) to handle commas/quotes in team or league names
- Suggested: PapaParse with `header: true`, `dynamicTyping: true`

## Available CSV Files

All CSVs are generated by the daily workflow and available in the `site/` folder when deployed to GitHub Pages.

### 1. `metrics.csv` - Overview Metrics
**Purpose**: Key performance indicators for the dashboard overview
**Update Frequency**: Daily

```csv
metric,value
run_id,20250110_143022
started_at,2025-01-10 14:30:22
finished_at,2025-01-10 14:45:18
train_rows,15420
test_rows,3855
poisson_home_loss,0.7542
poisson_away_loss,0.8452
pnl_30d,245.67
stake_30d,1850.00
bets_30d,127
roi_30d_pct,13.28
```

**Usage Example**:
```javascript
// Dashboard Overview Component
const metrics = await fetch('/metrics.csv').then(parseCSV);
const roi30d = metrics.find(m => m.metric === 'roi_30d_pct')?.value || 0;
const totalBets = metrics.find(m => m.metric === 'bets_30d')?.value || 0;
```

### 2. `roi_heatmap.csv` - ROI by Tier and Line
**Purpose**: ROI performance heatmap for tier × AH line combinations
**Update Frequency**: Daily

```csv
tier,line,roi_pct,n
1,-1.0,18.45,87
1,-0.75,12.33,65
1,-0.5,8.92,142
1,-0.25,5.67,98
1,0.0,3.21,156
1,0.25,7.89,89
2,-1.0,15.67,45
2,-0.5,11.23,78
3,-0.25,9.45,32
```

**Usage Example**:
```javascript
// Heatmap Component with click-through filters
const heatmapData = await fetch('/roi_heatmap.csv').then(parseCSV);
const heatmapGrid = heatmapData.reduce((acc, row) => {
  acc[`${row.tier}-${row.line}`] = {
    roi: parseFloat(row.roi_pct),
    count: parseInt(row.n)
  };
  return acc;
}, {});
```

### 3. `top_segments.csv` - Best Performing Segments
**Purpose**: Top 50 tier-line combinations by ROI (min 30 bets)
**Update Frequency**: Daily

```csv
tier,line,roi_pct,n
1,-1.25,24.67,45
2,-0.75,22.13,38
1,0.75,19.89,52
3,-1.0,18.45,31
```

**Usage Example**:
```javascript
// Top Segments Table
const topSegments = await fetch('/top_segments.csv').then(parseCSV);
const bestROI = topSegments[0]; // Highest ROI segment
```

### 4. `latest_recommendations.csv` - Current Recommendations
**Purpose**: Active betting recommendations (last 7 days)
**Update Frequency**: Daily

```csv
dt_gmt8,league,home,away,rec_text,line,odds,ev,confidence
2025-01-10 19:00:00,England Premier League,Arsenal,Chelsea,Arsenal -0.5,2.15,0.087,High
2025-01-10 21:30:00,Spain La Liga,Real Madrid,Barcelona,Real Madrid -0.25,1.95,0.065,High
```

**Usage Example**:
```javascript
// Recommendations Component
const recommendations = await fetch('/latest_recommendations.csv').then(parseCSV);
const highConfidence = recommendations.filter(r => r.confidence === 'High');
```

### 5. `pnl_by_month.csv` - Historical P&L
**Purpose**: Monthly profit/loss breakdown by league
**Update Frequency**: Daily

```csv
month,league,pnl
2024-08,England Premier League,125.67
2024-08,Spain La Liga,89.34
2024-08,Germany Bundesliga,45.23
2024-09,England Premier League,156.89
```

**Usage Example**:
```javascript
// P&L Chart Component
const pnlData = await fetch('/pnl_by_month.csv').then(parseCSV);
const monthlyTotals = pnlData.reduce((acc, row) => {
  acc[row.month] = (acc[row.month] || 0) + parseFloat(row.pnl);
  return acc;
}, {});
```

### 6. `bankroll_series_90d.csv` - Bankroll History
**Purpose**: Daily bankroll progression (last 90 days)
**Update Frequency**: Daily

```csv
dt_gmt8,cum_bankroll
2024-10-12,1000.00
2024-10-13,1025.50
2024-10-14,1018.75
2024-10-15,1045.20
```

**Usage Example**:
```javascript
// Bankroll Chart Component
const bankrollData = await fetch('/bankroll_series_90d.csv').then(parseCSV);
const chartPoints = bankrollData.map(row => ({
  x: new Date(row.dt_gmt8),
  y: parseFloat(row.cum_bankroll)
}));
```

## Dashboard Design Integration

### Color Palette (Blue-Orange Gradient with Glassmorphism)
```css
:root {
  /* Primary gradient */
  --gradient-primary: linear-gradient(135deg, #2563eb 0%, #f97316 100%);
  --gradient-subtle: linear-gradient(135deg, #3b82f6 0%, #fb923c 100%);
  
  /* Glass effect */
  --glass-bg: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-backdrop: blur(10px);
  
  /* Colors for ROI visualization */
  --roi-positive: #10b981;  /* Green for positive ROI */
  --roi-negative: #ef4444;  /* Red for negative ROI */
  --roi-neutral: #6b7280;   /* Gray for neutral */
}

.glass-card {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  backdrop-filter: var(--glass-backdrop);
  border-radius: 16px;
}
```

### Key Components to Implement

1. **Overview Dashboard**
   - Metrics cards with glassmorphism
   - 30-day ROI percentage with trend
   - Total bets and win rate
   - Recent bankroll progression chart

2. **Analytics Page**
   - Interactive ROI heatmap (tier × line)
   - Clickable cells that filter other components
   - Monthly P&L breakdown chart
   - Top performing segments table

3. **Recommendations Page**
   - Live recommendations table
   - Confidence level indicators
   - SHAP explanations in tooltips
   - Filter by league/confidence

### URL-Synced Filters Implementation
```javascript
// URL state management for filters
const useURLFilters = () => {
  const [filters, setFilters] = useState({
    tier: null,
    line: null,
    league: null,
    confidence: null
  });
  
  // Sync with URL
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    setFilters({
      tier: params.get('tier'),
      line: params.get('line'),
      league: params.get('league'),
      confidence: params.get('confidence')
    });
  }, []);
  
  const updateFilter = (key, value) => {
    const newFilters = { ...filters, [key]: value };
    const params = new URLSearchParams();
    Object.entries(newFilters).forEach(([k, v]) => {
      if (v) params.set(k, v);
    });
    window.history.pushState({}, '', `?${params.toString()}`);
    setFilters(newFilters);
  };
  
  return [filters, updateFilter];
};
```

### CSV Parsing Utility
```javascript
// Reusable CSV parser
const parseCSV = async (response) => {
  const text = await response.text();
  const lines = text.split('\n').filter(line => line.trim());
  const headers = lines[0].split(',');
  
  return lines.slice(1).map(line => {
    const values = line.split(',');
    return headers.reduce((obj, header, index) => {
      obj[header] = values[index] || '';
      return obj;
    }, {});
  });
};
```

## Data Refresh Strategy

1. **Automatic Refresh**: CSVs update daily via GitHub Actions
2. **Cache Strategy**: Use browser cache with daily TTL
3. **Error Handling**: Graceful fallbacks for missing data
4. **Loading States**: Show skeletons while fetching

## GitHub Pages Deployment

The CSV files are automatically deployed to GitHub Pages at:
- Base URL: `https://[username].github.io/[repo-name]/`
- CSV Access: `https://[username].github.io/[repo-name]/metrics.csv`

## Testing Data Contracts

Run this script to validate CSV structure:
```javascript
const validateCSVStructure = async () => {
  const expectedFiles = [
    'metrics.csv',
    'roi_heatmap.csv', 
    'top_segments.csv',
    'latest_recommendations.csv',
    'pnl_by_month.csv',
    'bankroll_series_90d.csv'
  ];
  
  for (const file of expectedFiles) {
    try {
      const data = await fetch(`/${file}`).then(parseCSV);
      console.log(`✅ ${file}: ${data.length} rows`);
    } catch (error) {
      console.log(`❌ ${file}: ${error.message}`);
    }
  }
};
```

This integration provides all the data needed for a comprehensive football betting dashboard with the blue-orange gradient aesthetic and glassmorphism design patterns.
