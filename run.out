
--- Section 1 (Revised): Unified Data Fetching & Flagging ---
--- Fetching Historical & Current Season Match Data (including potential future fixtures) ---

Processing league: England Premier League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15050...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12325...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9660...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7704...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6135...

Processing league: Italy Serie A...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15068...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12530...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9697...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7608...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6198...

Processing league: Spain La Liga...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14956...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12316...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9665...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7665...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6211...

Processing league: Germany Bundesliga...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14968...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12529...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9655...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7664...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6192...

Processing league: France Ligue 1...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14932...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12337...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9674...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7500...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6019...

Processing league: Europe UEFA Champions League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14924...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12321...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9543...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7455...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5977...

Processing league: Europe UEFA Europa League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15002...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12327...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10210...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7985...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6218...

Processing league: Japan J1 League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13960...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10994...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8810...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6935...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5434...

Processing league: South Korea K League 1...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14069...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=11102...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8899...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7061...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5506...

Processing league: Brazil Serie A...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14231...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=11321...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9035...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7097...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5713...

Processing league: Argentina Primera División...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5220...
    Error fetching match data for season_id 5220 (Argentina Primera División): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=5220&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=2366...
    Error fetching match data for season_id 2366 (Argentina Primera División): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=2366&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=1712...
    Error fetching match data for season_id 1712 (Argentina Primera División): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=1712&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=196...
    Error fetching match data for season_id 196 (Argentina Primera División): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=196&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=114...
    Error fetching match data for season_id 114 (Argentina Primera División): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=114&include=stats

Processing league: Australia A-League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13703...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10505...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8008...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6639...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5361...

Processing league: USA MLS...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13973...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10977...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8777...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6969...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5674...

Processing league: Netherlands Eredivisie...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14936...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12322...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9653...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7482...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5951...

Processing league: Portugal Liga NOS...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15115...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12931...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9984...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7731...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6117...

Processing league: Belgium Pro League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14937...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12137...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9577...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7544...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6079...

Processing league: England FA Cup...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15238...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13698...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9759...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7836...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6068...

Processing league: Germany DFB Pokal...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15035...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12057...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9561...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7397...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6092...

Processing league: Italy Coppa Italia...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15037...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12579...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10107...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8596...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6194...

Processing league: Spain Copa del Rey...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13624...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10736...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8457...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6790...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5334...

Processing league: France Coupe de France...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13729...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10827...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8550...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8881...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5345...

Processing league: Brazil Copa do Brasil...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14210...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=11184...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9009...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7018...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5840...

Processing league: Argentina Copa Argentina...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=1654...
    Error fetching match data for season_id 1654 (Argentina Copa Argentina): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=1654&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15011...
    Error fetching match data for season_id 15011 (Argentina Copa Argentina): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=15011&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10985...
    Error fetching match data for season_id 10985 (Argentina Copa Argentina): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=10985&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8757...
    Error fetching match data for season_id 8757 (Argentina Copa Argentina): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=8757&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12685...
    Error fetching match data for season_id 12685 (Argentina Copa Argentina): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=12685&include=stats

Processing league: Asia AFC Champions League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14891...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13356...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9594...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7078...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5667...

Processing league: Austria Bundesliga...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14923...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12472...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9954...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7890...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6008...

Processing league: China Chinese Super League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14153...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=11217...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9186...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7356...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5728...

Processing league: Denmark Superliga...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15055...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12132...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9545...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7426...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5961...

Processing league: England League Cup...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15137...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12473...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9574...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7579...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7470...

Processing league: England Championship...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14930...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12451...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9663...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7593...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6089...

Processing league: Europe UEFA Europa Conference League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14904...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12278...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9600...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7480...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7322...

Processing league: Israel Israeli Premier League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14966...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12377...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9564...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7448...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6040...

Processing league: Japan Emperor Cup...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14727...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=11975...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9310...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8452...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5850...

Processing league: Malaysia Super League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15210...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=11438...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8939...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7044...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5624...

Processing league: Netherlands KNVB Cup...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12799...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10277...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7900...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6141...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=4747...

Processing league: Saudi Arabia Professional League...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12772...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9883...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8089...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6212...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5193...

Processing league: Scotland Premiership...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15000...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12455...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9636...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7494...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5992...

Processing league: South Korea Korean FA Cup...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14281...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=11302...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9044...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7138...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=5649...

Processing league: Turkey Süper Lig...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=14972...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=12641...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=9913...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7768...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6125...

Processing league: Turkey Turkish Cup...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=15447...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13549...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10704...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8364...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=6538...

Processing league: International FIFA Club World Cup...
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13878...
    Error fetching match data for season_id 13878 (International FIFA Club World Cup): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=13878&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=13557...
    Error fetching match data for season_id 13557 (International FIFA Club World Cup): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=13557&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=10958...
    Error fetching match data for season_id 10958 (International FIFA Club World Cup): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=10958&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=8830...
    Error fetching match data for season_id 8830 (International FIFA Club World Cup): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=8830&include=stats
    Fetching from URL: https://api.footystats.org/league-matches?season_id=7069...
    Error fetching match data for season_id 7069 (International FIFA Club World Cup): 417 Client Error: Condition Not Met for url: https://api.footystats.org/league-matches?key=76b520495072b8f1b1f6ca6a379f51d5dfab642f38f6f5f5d1f9f543378400fd&season_id=7069&include=stats

Total raw match entries fetched: 45554

Performing initial processing on all_data...
Datetime columns created.
Current reference time for 'is_future' flag (GMT+8): 2025-08-09 09:45:22.526569

'is_future' flag created. Future matches identified: 5122
Added 'competition_type' and 'league_tier' columns.
Final sorting of 'all_data' complete.

Sample of 'all_data' (tail, to check for future games if any were fetched):
            datetime_gmt8                  league  ... competition_type league_tier
45534 2026-05-24 23:00:00  England Premier League  ...           league           1
45535 2026-05-24 23:00:00  England Premier League  ...           league           1
45536 2026-05-24 23:00:00  England Premier League  ...           league           1
45537 2026-05-24 23:00:00  England Premier League  ...           league           1
45538 2026-05-24 23:00:00  England Premier League  ...           league           1
45539 2026-05-24 23:00:00  England Premier League  ...           league           1
45540 2026-05-24 23:00:00  England Premier League  ...           league           1
45541 2026-05-24 23:00:00  England Premier League  ...           league           1
45542 2026-05-24 23:00:00  England Premier League  ...           league           1
45543 2026-05-24 23:00:00  England Premier League  ...           league           1
45544 2026-05-24 23:00:00           Italy Serie A  ...           league           1
45545 2026-05-24 23:00:00           Italy Serie A  ...           league           1
45546 2026-05-24 23:00:00           Italy Serie A  ...           league           1
45547 2026-05-24 23:00:00           Italy Serie A  ...           league           1
45548 2026-05-24 23:00:00           Italy Serie A  ...           league           1
45549 2026-05-24 23:00:00           Italy Serie A  ...           league           1
45550 2026-05-24 23:00:00           Italy Serie A  ...           league           1
45551 2026-05-24 23:00:00           Italy Serie A  ...           league           1
45552 2026-05-24 23:00:00           Italy Serie A  ...           league           1
45553 2026-05-24 23:00:00           Italy Serie A  ...           league           1

[20 rows x 8 columns]

Value counts for 'is_future':
is_future
False    40432
True      5122
Name: count, dtype: int64

Value counts for 'competition_type':
competition_type
league    33519
cup       12035
Name: count, dtype: int64

Value counts for 'league_tier':
league_tier
2    17706
3    15085
1    12763
Name: count, dtype: int64

'all_data_unified' DataFrame created with 45554 total entries, ready for feature engineering.

--- End of Section 1 (Revised): Unified Data Fetching & Flagging ---
['complete' 'canceled' 'incomplete' 'suspended']

--- Section 2: Feature Engineering (xGA and Actual Outcome) on all_data_unified ---
Input DataFrame 'all_data_unified' has 45554 rows.

Calculating team_a_xga (using last 10 matches, decay 0.9)...
Calculating team_b_xga (using last 10 matches, decay 0.9)...
xGA calculations complete.

Calculating actual match outcomes (for non-future matches)...
Actual outcome calculation complete.

--- Sample of DataFrame with new xGA and Actual Outcome columns ---

Sample Head (likely historical):
        datetime_gmt8  is_future    status     home_name            away_name  homeGoalCount  awayGoalCount actual_outcome  team_a_xg  team_b_xg  team_a_xga  team_b_xga                league competition_type  league_tier
0 2020-08-29 20:30:00      False  complete          VVOG                  DEM              0              2       away_win       1.55       1.97         NaN         NaN  Netherlands KNVB Cup              cup            3
1 2020-08-29 20:30:00      False  complete  RKSV Cluzona       Sparta Nijkerk              0              4       away_win       0.00       0.00         NaN         NaN  Netherlands KNVB Cup              cup            3
2 2020-08-29 20:30:00      False  complete       DVS '33            VV Dongen              3              1       home_win       1.69       1.02         NaN         NaN  Netherlands KNVB Cup              cup            3
3 2020-08-29 20:30:00      False  complete       Capelle             Hoogland              4              0       home_win       0.00       0.00         NaN         NaN  Netherlands KNVB Cup              cup            3
4 2020-08-29 20:30:00      False  complete    Rijnvogels  JOS Watergraafsmeer              1              1           draw       0.00       0.00         NaN         NaN  Netherlands KNVB Cup              cup            3

Sample Tail (to see if future matches are processed):
            datetime_gmt8  is_future      status      home_name away_name  homeGoalCount  awayGoalCount actual_outcome  team_a_xg  team_b_xg  team_a_xga  team_b_xga         league competition_type  league_tier
45549 2026-05-24 23:00:00       True  incomplete  Hellas Verona      Roma              0              0           None        0.0        0.0         0.0         0.0  Italy Serie A           league            1
45550 2026-05-24 23:00:00       True  incomplete     Fiorentina  Atalanta              0              0           None        0.0        0.0         0.0         0.0  Italy Serie A           league            1
45551 2026-05-24 23:00:00       True  incomplete          Lecce     Genoa              0              0           None        0.0        0.0         0.0         0.0  Italy Serie A           league            1
45552 2026-05-24 23:00:00       True  incomplete       AC Milan  Cagliari              0              0           None        0.0        0.0         0.0         0.0  Italy Serie A           league            1
45553 2026-05-24 23:00:00       True  incomplete         Torino  Juventus              0              0           None        0.0        0.0         0.0         0.0  Italy Serie A           league            1

Checking for NaNs in new xGA columns (first 5 rows of the entire dataset):
   team_a_xga  team_b_xga
0         NaN         NaN
1         NaN         NaN
2         NaN         NaN
3         NaN         NaN
4         NaN         NaN

Value counts for 'actual_outcome':
actual_outcome
home_win    17834
away_win    13065
draw         9533
None         5122
Name: count, dtype: int64

--- End of Section 2: Feature Engineering (xGA and Actual Outcome) ---

--- Section 3 (Refactored): Rolling Features, Team Form, and Fixture Congestion on all_data_unified ---
Input 'all_data_unified' has 45554 rows.
Preparing team_game_stats DataFrame from historical data...
Using 40432 historical matches for team_game_stats.
team_game_stats (from historical) prepared with 80864 team-match entries.

Calculating 'days_since_last_match' for each team (based on historical context)...
Calculating rolling team form metrics (overall form over last 5 games)...

Merging team form and 'days_since_last_match' back to the main DataFrame...
Team form and 'days_since_last_match' metrics merged.

Calculating matches in last N days (this can be slow)...
Matches in last N days calculated.

Calculating rolling metrics for home/away specific performance (last 5 games in that role)...
Home/Away specific rolling metrics calculated.
No duplicate column names found in current_data_df. Excellent.

--- Sample of df_model_input with Rolling Features & Congestion ---
            datetime_gmt8  is_future      home_name    away_name actual_outcome competition_type  league_tier  days_since_last_match_home  days_since_last_match_away  home_matches_last_7d  away_matches_last_7d  home_rolling_xg_as_home  away_rolling_xg_as_away
45544 2026-05-24 23:00:00       True      Cremonese         Como           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0
45545 2026-05-24 23:00:00       True         Napoli      Udinese           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0
45546 2026-05-24 23:00:00       True        Bologna  Inter Milan           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0
45547 2026-05-24 23:00:00       True          Lazio         Pisa           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0
45548 2026-05-24 23:00:00       True          Parma     Sassuolo           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0
45549 2026-05-24 23:00:00       True  Hellas Verona         Roma           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0
45550 2026-05-24 23:00:00       True     Fiorentina     Atalanta           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0
45551 2026-05-24 23:00:00       True          Lecce        Genoa           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0
45552 2026-05-24 23:00:00       True       AC Milan     Cagliari           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0
45553 2026-05-24 23:00:00       True         Torino     Juventus           None           league            1                         NaN                         NaN                     1                     1                      0.0                      0.0

--- End of Section 3 (Refactored): Rolling Features, Team Form, and Fixture Congestion ---

--- Section 3.5 (Corrected): Advanced Feature Engineering - Granular Stats & Additional Odds ---
Input df_model_input to Section 3.5 has 45554 rows and 249 columns.

Preparing team_game_stats_granular (comprehensively for Sections 3.5 & 3.7)...
team_game_stats_granular prepared with 91108 entries and 'match_team_xga'.

Calculating rolling averages for granular stats (last 5 games)...
Rolling granular stats merged into df_model_input.

Calculating implied probabilities from other odds markets...
Implied market probabilities calculated.

--- Sample of df_model_input with new Advanced Features (first 5 rows) ---
      home_name            away_name  rolling_possession_form_home  rolling_possession_form_away  rolling_sot_for_form_home  rolling_sot_for_form_away  rolling_da_for_form_home  rolling_da_against_form_away  market_prob_btts_yes  market_prob_o25  market_prob_u25
0          VVOG                  DEM                           NaN                           NaN                        NaN                        NaN                       NaN                           NaN                   NaN         0.714286         0.347222
1  RKSV Cluzona       Sparta Nijkerk                           NaN                           NaN                        NaN                        NaN                       NaN                           NaN                   NaN              NaN              NaN
2       DVS '33            VV Dongen                           NaN                           NaN                        NaN                        NaN                       NaN                           NaN                   NaN         0.666667         0.400000
3       Capelle             Hoogland                           NaN                           NaN                        NaN                        NaN                       NaN                           NaN                   NaN              NaN              NaN
4    Rijnvogels  JOS Watergraafsmeer                           NaN                           NaN                        NaN                        NaN                       NaN                           NaN                   NaN              NaN              NaN

Checking for NaNs in new advanced feature columns (first 5 rows sample):
rolling_possession_form_home    5
rolling_possession_form_away    5
rolling_sot_for_form_home       5
rolling_sot_for_form_away       5
rolling_da_for_form_home        5
rolling_da_against_form_away    5
market_prob_btts_yes            5
market_prob_o25                 3
market_prob_u25                 3
dtype: int64

--- End of Section 3.5 (Corrected): Advanced Feature Engineering ---
['id', 'homeID', 'awayID', 'season', 'status', 'roundID', 'game_week', 'revised_game_week', 'homeGoals', 'awayGoals', 'homeGoalCount', 'awayGoalCount', 'totalGoalCount', 'team_a_corners', 'team_b_corners', 'totalCornerCount', 'team_a_offsides', 'team_b_offsides', 'team_a_yellow_cards', 'team_b_yellow_cards', 'team_a_red_cards', 'team_b_red_cards', 'team_a_shotsOnTarget', 'team_b_shotsOnTarget', 'team_a_shotsOffTarget', 'team_b_shotsOffTarget', 'team_a_shots', 'team_b_shots', 'team_a_fouls', 'team_b_fouls', 'team_a_possession', 'team_b_possession', 'refereeID', 'coach_a_ID', 'coach_b_ID', 'stadium_name', 'stadium_location', 'team_a_cards_num', 'team_b_cards_num', 'odds_ft_1', 'odds_ft_x', 'odds_ft_2', 'odds_ft_over05', 'odds_ft_over15', 'odds_ft_over25', 'odds_ft_over35', 'odds_ft_over45', 'odds_ft_under05', 'odds_ft_under15', 'odds_ft_under25', 'odds_ft_under35', 'odds_ft_under45', 'odds_btts_yes', 'odds_btts_no', 'odds_team_a_cs_yes', 'odds_team_a_cs_no', 'odds_team_b_cs_yes', 'odds_team_b_cs_no', 'odds_doublechance_1x', 'odds_doublechance_12', 'odds_doublechance_x2', 'odds_1st_half_result_1', 'odds_1st_half_result_x', 'odds_1st_half_result_2', 'odds_2nd_half_result_1', 'odds_2nd_half_result_x', 'odds_2nd_half_result_2', 'odds_dnb_1', 'odds_dnb_2', 'odds_corners_over_75', 'odds_corners_over_85', 'odds_corners_over_95', 'odds_corners_over_105', 'odds_corners_over_115', 'odds_corners_under_75', 'odds_corners_under_85', 'odds_corners_under_95', 'odds_corners_under_105', 'odds_corners_under_115', 'odds_corners_1', 'odds_corners_x', 'odds_corners_2', 'odds_team_to_score_first_1', 'odds_team_to_score_first_x', 'odds_team_to_score_first_2', 'odds_win_to_nil_1', 'odds_win_to_nil_2', 'odds_1st_half_over05', 'odds_1st_half_over15', 'odds_1st_half_over25', 'odds_1st_half_over35', 'odds_1st_half_under05', 'odds_1st_half_under15', 'odds_1st_half_under25', 'odds_1st_half_under35', 'odds_2nd_half_over05', 'odds_2nd_half_over15', 'odds_2nd_half_over25', 'odds_2nd_half_over35', 'odds_2nd_half_under05', 'odds_2nd_half_under15', 'odds_2nd_half_under25', 'odds_2nd_half_under35', 'odds_btts_1st_half_yes', 'odds_btts_1st_half_no', 'odds_btts_2nd_half_yes', 'odds_btts_2nd_half_no', 'overallGoalCount', 'ht_goals_team_a', 'ht_goals_team_b', 'goals_2hg_team_a', 'goals_2hg_team_b', 'GoalCount_2hg', 'HTGoalCount', 'date_unix', 'winningTeam', 'no_home_away', 'btts_potential', 'btts_fhg_potential', 'btts_2hg_potential', 'goalTimingDisabled', 'attendance', 'corner_timings_recorded', 'card_timings_recorded', 'team_a_fh_corners', 'team_b_fh_corners', 'team_a_2h_corners', 'team_b_2h_corners', 'corner_fh_count', 'corner_2h_count', 'team_a_fh_cards', 'team_b_fh_cards', 'team_a_2h_cards', 'team_b_2h_cards', 'total_fh_cards', 'total_2h_cards', 'attacks_recorded', 'team_a_dangerous_attacks', 'team_b_dangerous_attacks', 'team_a_attacks', 'team_b_attacks', 'team_a_xg', 'team_b_xg', 'total_xg', 'team_a_penalties_won', 'team_b_penalties_won', 'team_a_penalty_goals', 'team_b_penalty_goals', 'team_a_penalty_missed', 'team_b_penalty_missed', 'pens_recorded', 'goal_timings_recorded', 'team_a_0_10_min_goals', 'team_b_0_10_min_goals', 'team_a_corners_0_10_min', 'team_b_corners_0_10_min', 'team_a_cards_0_10_min', 'team_b_cards_0_10_min', 'throwins_recorded', 'team_a_throwins', 'team_b_throwins', 'freekicks_recorded', 'team_a_freekicks', 'team_b_freekicks', 'goalkicks_recorded', 'team_a_goalkicks', 'team_b_goalkicks', 'o45_potential', 'o35_potential', 'o25_potential', 'o15_potential', 'o05_potential', 'o15HT_potential', 'o05HT_potential', 'o05_2H_potential', 'o15_2H_potential', 'corners_potential', 'offsides_potential', 'cards_potential', 'avg_potential', 'home_url', 'home_image', 'home_name', 'away_url', 'away_image', 'away_name', 'home_ppg', 'away_ppg', 'pre_match_home_ppg', 'pre_match_away_ppg', 'pre_match_teamA_overall_ppg', 'pre_match_teamB_overall_ppg', 'u45_potential', 'u35_potential', 'u25_potential', 'u15_potential', 'u05_potential', 'corners_o85_potential', 'corners_o95_potential', 'corners_o105_potential', 'team_a_xg_prematch', 'team_b_xg_prematch', 'total_xg_prematch', 'match_url', 'competition_id', 'matches_completed_minimum', 'over05', 'over15', 'over25', 'over35', 'over45', 'over55', 'btts', 'homeGoals_timings', 'awayGoals_timings', 'season_id_fetched', 'league', 'datetime', 'datetime_gmt8', 'is_future', 'competition_type', 'league_tier', 'team_a_xga', 'team_b_xga', 'actual_outcome', 'days_since_last_match_home', 'rolling_goals_scored_form_home', 'rolling_goals_conceded_form_home', 'rolling_points_earned_form_home', 'rolling_xg_for_form_home', 'rolling_xga_against_form_home', 'days_since_last_match_away', 'rolling_goals_scored_form_away', 'rolling_goals_conceded_form_away', 'rolling_points_earned_form_away', 'rolling_xg_for_form_away', 'rolling_xga_against_form_away', 'home_matches_last_7d', 'home_matches_last_14d', 'away_matches_last_7d', 'away_matches_last_14d', 'home_rolling_xg_as_home', 'home_rolling_xga_as_home', 'home_rolling_goals_scored_as_home', 'home_rolling_goals_conceded_as_home', 'away_rolling_xg_as_away', 'away_rolling_xga_as_away', 'away_rolling_goals_scored_as_away', 'away_rolling_goals_conceded_as_away', 'rolling_possession_form_home', 'rolling_shots_for_form_home', 'rolling_shots_against_form_home', 'rolling_sot_for_form_home', 'rolling_sot_against_form_home', 'rolling_corners_for_form_home', 'rolling_corners_against_form_home', 'rolling_fouls_for_form_home', 'rolling_fouls_against_form_home', 'rolling_da_for_form_home', 'rolling_da_against_form_home', 'rolling_possession_form_away', 'rolling_shots_for_form_away', 'rolling_shots_against_form_away', 'rolling_sot_for_form_away', 'rolling_sot_against_form_away', 'rolling_corners_for_form_away', 'rolling_corners_against_form_away', 'rolling_fouls_for_form_away', 'rolling_fouls_against_form_away', 'rolling_da_for_form_away', 'rolling_da_against_form_away', 'market_prob_btts_yes', 'market_prob_o25', 'market_prob_u25']
Are there any truly duplicated column names? False

--- Section 3.6 (Corrected): Synthetic Feature Engineering ---

Preparing team_game_stats for synthetic feature calculation...
team_game_stats_for_synthetics prepared with 91108 entries.

Calculating raw synthetic features per team-match...

Calculating rolling averages for synthetic features (last 5 games)...
Rolling synthetic features merged into df_model_input.

--- Sample of df_model_input with new Rolling Synthetic Features (first 15 rows to see some non-NaNs) ---
          home_name            away_name  rolling_synth_goals_minus_xg_form_home  rolling_synth_goals_per_xg_ratio_form_home  rolling_synth_goals_per_shot_form_home  rolling_synth_goals_per_sot_form_home  rolling_synth_sot_per_shot_ratio_form_home  rolling_synth_goals_minus_xg_form_away  rolling_synth_goals_per_xg_ratio_form_away
0              VVOG                  DEM                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
1      RKSV Cluzona       Sparta Nijkerk                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
2           DVS '33            VV Dongen                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
3           Capelle             Hoogland                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
4        Rijnvogels  JOS Watergraafsmeer                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
5         Ter Leede            Hoogezand                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
6    Harkemase Boys         USV Hercules                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
7          HSV Hoek         OFC Oostzaan                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
8               ACV               Gemert                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
9         Hoogeveen                 DOVO                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
10   Roda '46 (Zat)              ADO '20                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
11        Staphorst              HSC '21                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
12           AFC II           GVV Unitas                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
13      Barendrecht                  Erp                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN
14  VV Scherpenzeel          Groene Ster                                     NaN                                         NaN                                     NaN                                    NaN                                         NaN                                     NaN                                         NaN

Checking for NaNs in new rolling synthetic feature columns (first 15 rows sample):
rolling_synth_goals_minus_xg_form_home        15
rolling_synth_goals_per_xg_ratio_form_home    15
rolling_synth_goals_per_shot_form_home        15
rolling_synth_goals_per_sot_form_home         15
rolling_synth_sot_per_shot_ratio_form_home    15
rolling_synth_goals_minus_xg_form_away        15
rolling_synth_goals_per_xg_ratio_form_away    15
dtype: int64

--- End of Section 3.6 (Corrected): Synthetic Feature Engineering ---

--- Section 3.7 (Corrected to use 'match_team_xga'): Advanced Defensive Synthetic Features ---
Using 'team_game_stats_granular' with 91108 entries.

Calculating raw defensive synthetic features per team-match...

Calculating rolling averages for defensive synthetic features (last 5 games)...
Rolling defensive synthetic features merged into df_model_input.

--- Sample of df_model_input with new Rolling Defensive Synthetic Features (first 15 rows) ---
          home_name            away_name  rolling_synth_xga_per_shot_conceded_form_home  rolling_synth_xga_per_sot_conceded_form_home  rolling_synth_xga_per_shot_conceded_form_away  rolling_synth_xga_per_sot_conceded_form_away
0              VVOG                  DEM                                            NaN                                           NaN                                            NaN                                           NaN
1      RKSV Cluzona       Sparta Nijkerk                                            NaN                                           NaN                                            NaN                                           NaN
2           DVS '33            VV Dongen                                            NaN                                           NaN                                            NaN                                           NaN
3           Capelle             Hoogland                                            NaN                                           NaN                                            NaN                                           NaN
4        Rijnvogels  JOS Watergraafsmeer                                            NaN                                           NaN                                            NaN                                           NaN
5         Ter Leede            Hoogezand                                            NaN                                           NaN                                            NaN                                           NaN
6    Harkemase Boys         USV Hercules                                            NaN                                           NaN                                            NaN                                           NaN
7          HSV Hoek         OFC Oostzaan                                            NaN                                           NaN                                            NaN                                           NaN
8               ACV               Gemert                                            NaN                                           NaN                                            NaN                                           NaN
9         Hoogeveen                 DOVO                                            NaN                                           NaN                                            NaN                                           NaN
10   Roda '46 (Zat)              ADO '20                                            NaN                                           NaN                                            NaN                                           NaN
11        Staphorst              HSC '21                                            NaN                                           NaN                                            NaN                                           NaN
12           AFC II           GVV Unitas                                            NaN                                           NaN                                            NaN                                           NaN
13      Barendrecht                  Erp                                            NaN                                           NaN                                            NaN                                           NaN
14  VV Scherpenzeel          Groene Ster                                            NaN                                           NaN                                            NaN                                           NaN

--- End of Section 3.7 (Corrected): Advanced Defensive Synthetic Features ---
['id', 'homeID', 'awayID', 'season', 'status', 'roundID', 'game_week', 'revised_game_week', 'homeGoals', 'awayGoals', 'homeGoalCount', 'awayGoalCount', 'totalGoalCount', 'team_a_corners', 'team_b_corners', 'totalCornerCount', 'team_a_offsides', 'team_b_offsides', 'team_a_yellow_cards', 'team_b_yellow_cards', 'team_a_red_cards', 'team_b_red_cards', 'team_a_shotsOnTarget', 'team_b_shotsOnTarget', 'team_a_shotsOffTarget', 'team_b_shotsOffTarget', 'team_a_shots', 'team_b_shots', 'team_a_fouls', 'team_b_fouls', 'team_a_possession', 'team_b_possession', 'refereeID', 'coach_a_ID', 'coach_b_ID', 'stadium_name', 'stadium_location', 'team_a_cards_num', 'team_b_cards_num', 'odds_ft_1', 'odds_ft_x', 'odds_ft_2', 'odds_ft_over05', 'odds_ft_over15', 'odds_ft_over25', 'odds_ft_over35', 'odds_ft_over45', 'odds_ft_under05', 'odds_ft_under15', 'odds_ft_under25', 'odds_ft_under35', 'odds_ft_under45', 'odds_btts_yes', 'odds_btts_no', 'odds_team_a_cs_yes', 'odds_team_a_cs_no', 'odds_team_b_cs_yes', 'odds_team_b_cs_no', 'odds_doublechance_1x', 'odds_doublechance_12', 'odds_doublechance_x2', 'odds_1st_half_result_1', 'odds_1st_half_result_x', 'odds_1st_half_result_2', 'odds_2nd_half_result_1', 'odds_2nd_half_result_x', 'odds_2nd_half_result_2', 'odds_dnb_1', 'odds_dnb_2', 'odds_corners_over_75', 'odds_corners_over_85', 'odds_corners_over_95', 'odds_corners_over_105', 'odds_corners_over_115', 'odds_corners_under_75', 'odds_corners_under_85', 'odds_corners_under_95', 'odds_corners_under_105', 'odds_corners_under_115', 'odds_corners_1', 'odds_corners_x', 'odds_corners_2', 'odds_team_to_score_first_1', 'odds_team_to_score_first_x', 'odds_team_to_score_first_2', 'odds_win_to_nil_1', 'odds_win_to_nil_2', 'odds_1st_half_over05', 'odds_1st_half_over15', 'odds_1st_half_over25', 'odds_1st_half_over35', 'odds_1st_half_under05', 'odds_1st_half_under15', 'odds_1st_half_under25', 'odds_1st_half_under35', 'odds_2nd_half_over05', 'odds_2nd_half_over15', 'odds_2nd_half_over25', 'odds_2nd_half_over35', 'odds_2nd_half_under05', 'odds_2nd_half_under15', 'odds_2nd_half_under25', 'odds_2nd_half_under35', 'odds_btts_1st_half_yes', 'odds_btts_1st_half_no', 'odds_btts_2nd_half_yes', 'odds_btts_2nd_half_no', 'overallGoalCount', 'ht_goals_team_a', 'ht_goals_team_b', 'goals_2hg_team_a', 'goals_2hg_team_b', 'GoalCount_2hg', 'HTGoalCount', 'date_unix', 'winningTeam', 'no_home_away', 'btts_potential', 'btts_fhg_potential', 'btts_2hg_potential', 'goalTimingDisabled', 'attendance', 'corner_timings_recorded', 'card_timings_recorded', 'team_a_fh_corners', 'team_b_fh_corners', 'team_a_2h_corners', 'team_b_2h_corners', 'corner_fh_count', 'corner_2h_count', 'team_a_fh_cards', 'team_b_fh_cards', 'team_a_2h_cards', 'team_b_2h_cards', 'total_fh_cards', 'total_2h_cards', 'attacks_recorded', 'team_a_dangerous_attacks', 'team_b_dangerous_attacks', 'team_a_attacks', 'team_b_attacks', 'team_a_xg', 'team_b_xg', 'total_xg', 'team_a_penalties_won', 'team_b_penalties_won', 'team_a_penalty_goals', 'team_b_penalty_goals', 'team_a_penalty_missed', 'team_b_penalty_missed', 'pens_recorded', 'goal_timings_recorded', 'team_a_0_10_min_goals', 'team_b_0_10_min_goals', 'team_a_corners_0_10_min', 'team_b_corners_0_10_min', 'team_a_cards_0_10_min', 'team_b_cards_0_10_min', 'throwins_recorded', 'team_a_throwins', 'team_b_throwins', 'freekicks_recorded', 'team_a_freekicks', 'team_b_freekicks', 'goalkicks_recorded', 'team_a_goalkicks', 'team_b_goalkicks', 'o45_potential', 'o35_potential', 'o25_potential', 'o15_potential', 'o05_potential', 'o15HT_potential', 'o05HT_potential', 'o05_2H_potential', 'o15_2H_potential', 'corners_potential', 'offsides_potential', 'cards_potential', 'avg_potential', 'home_url', 'home_image', 'home_name', 'away_url', 'away_image', 'away_name', 'home_ppg', 'away_ppg', 'pre_match_home_ppg', 'pre_match_away_ppg', 'pre_match_teamA_overall_ppg', 'pre_match_teamB_overall_ppg', 'u45_potential', 'u35_potential', 'u25_potential', 'u15_potential', 'u05_potential', 'corners_o85_potential', 'corners_o95_potential', 'corners_o105_potential', 'team_a_xg_prematch', 'team_b_xg_prematch', 'total_xg_prematch', 'match_url', 'competition_id', 'matches_completed_minimum', 'over05', 'over15', 'over25', 'over35', 'over45', 'over55', 'btts', 'homeGoals_timings', 'awayGoals_timings', 'season_id_fetched', 'league', 'datetime', 'datetime_gmt8', 'is_future', 'competition_type', 'league_tier', 'team_a_xga', 'team_b_xga', 'actual_outcome', 'days_since_last_match_home', 'rolling_goals_scored_form_home', 'rolling_goals_conceded_form_home', 'rolling_points_earned_form_home', 'rolling_xg_for_form_home', 'rolling_xga_against_form_home', 'days_since_last_match_away', 'rolling_goals_scored_form_away', 'rolling_goals_conceded_form_away', 'rolling_points_earned_form_away', 'rolling_xg_for_form_away', 'rolling_xga_against_form_away', 'home_matches_last_7d', 'home_matches_last_14d', 'away_matches_last_7d', 'away_matches_last_14d', 'home_rolling_xg_as_home', 'home_rolling_xga_as_home', 'home_rolling_goals_scored_as_home', 'home_rolling_goals_conceded_as_home', 'away_rolling_xg_as_away', 'away_rolling_xga_as_away', 'away_rolling_goals_scored_as_away', 'away_rolling_goals_conceded_as_away', 'rolling_possession_form_home', 'rolling_shots_for_form_home', 'rolling_shots_against_form_home', 'rolling_sot_for_form_home', 'rolling_sot_against_form_home', 'rolling_corners_for_form_home', 'rolling_corners_against_form_home', 'rolling_fouls_for_form_home', 'rolling_fouls_against_form_home', 'rolling_da_for_form_home', 'rolling_da_against_form_home', 'rolling_possession_form_away', 'rolling_shots_for_form_away', 'rolling_shots_against_form_away', 'rolling_sot_for_form_away', 'rolling_sot_against_form_away', 'rolling_corners_for_form_away', 'rolling_corners_against_form_away', 'rolling_fouls_for_form_away', 'rolling_fouls_against_form_away', 'rolling_da_for_form_away', 'rolling_da_against_form_away', 'market_prob_btts_yes', 'market_prob_o25', 'market_prob_u25', 'rolling_synth_goals_minus_xg_form_home', 'rolling_synth_goals_per_xg_ratio_form_home', 'rolling_synth_goals_per_shot_form_home', 'rolling_synth_goals_per_sot_form_home', 'rolling_synth_sot_per_shot_ratio_form_home', 'rolling_synth_goals_minus_xg_form_away', 'rolling_synth_goals_per_xg_ratio_form_away', 'rolling_synth_goals_per_shot_form_away', 'rolling_synth_goals_per_sot_form_away', 'rolling_synth_sot_per_shot_ratio_form_away', 'rolling_synth_xga_per_shot_conceded_form_home', 'rolling_synth_xga_per_sot_conceded_form_home', 'rolling_synth_xga_per_shot_conceded_form_away', 'rolling_synth_xga_per_sot_conceded_form_away']

--- Section 3.8 (NEW): Elo Rating Calculation ---
Elo ratings calculated and merged.

--- Section 3.9 (NEW): Dynamic League Quality Tiers (10 Levels) ---
Dynamic league tiers calculated based on average team Elo ratings.

--- Section 4: Data Preparation for Modeling (Incorporating All Engineered Features) ---
Historical matches for model training/testing: 40432
Future matches for generating recommendations: 5122
Target variables defined for 40432 historical matches.

Selected 75 final numerical features for modeling.
Selected 2 final categorical features for OHE: ['competition_type', 'dynamic_league_tier']

Historical data split into training and testing sets:
X_train_raw shape: (32345, 77), X_test_raw shape: (8087, 77)

Applying preprocessing (NaN imputation, OneHotEncoding, Scaling) to historical data...
Preprocessing of historical data complete.
Shape of processed X_train: (32345, 87)
Shape of processed X_test: (8087, 87)
Total features after OHE: 87

Sample of processed and scaled training data (X_train_processed_df first 5 rows):
   team_a_xg  team_b_xg  team_a_xga  team_b_xga  odds_ft_1  odds_ft_x  odds_ft_2  rolling_goals_scored_form_home  rolling_goals_conceded_form_home  rolling_points_earned_form_home  rolling_xg_for_form_home  rolling_xga_against_form_home  days_since_last_match_home  rolling_goals_scored_form_away  rolling_goals_conceded_form_away  rolling_points_earned_form_away  rolling_xg_for_form_away  rolling_xga_against_form_away  days_since_last_match_away  home_matches_last_7d  home_matches_last_14d  away_matches_last_7d  away_matches_last_14d  home_rolling_xg_as_home  home_rolling_xga_as_home  home_rolling_goals_scored_as_home  home_rolling_goals_conceded_as_home  away_rolling_xg_as_away  away_rolling_xga_as_away  away_rolling_goals_scored_as_away  away_rolling_goals_conceded_as_away  rolling_possession_form_home  rolling_shots_for_form_home  rolling_shots_against_form_home  rolling_sot_for_form_home  rolling_sot_against_form_home  rolling_corners_for_form_home  rolling_corners_against_form_home  rolling_fouls_for_form_home  rolling_fouls_against_form_home  rolling_da_for_form_home  rolling_da_against_form_home  rolling_possession_form_away  rolling_shots_for_form_away  rolling_shots_against_form_away  rolling_sot_for_form_away  rolling_sot_against_form_away  rolling_corners_for_form_away  rolling_corners_against_form_away  rolling_fouls_for_form_away  rolling_fouls_against_form_away  rolling_da_for_form_away  rolling_da_against_form_away  market_prob_btts_yes  market_prob_o25  market_prob_u25  rolling_synth_goals_minus_xg_form_home  rolling_synth_goals_per_xg_ratio_form_home  rolling_synth_goals_per_shot_form_home  rolling_synth_goals_per_sot_form_home  rolling_synth_sot_per_shot_ratio_form_home  rolling_synth_goals_minus_xg_form_away  rolling_synth_goals_per_xg_ratio_form_away  rolling_synth_goals_per_shot_form_away  rolling_synth_goals_per_sot_form_away  rolling_synth_sot_per_shot_ratio_form_away  rolling_synth_xga_per_shot_conceded_form_home  rolling_synth_xga_per_sot_conceded_form_home  rolling_synth_xga_per_shot_conceded_form_away  rolling_synth_xga_per_sot_conceded_form_away  pre_match_home_elo  pre_match_away_elo  elo_diff  elo_prob_home_win  dynamic_league_quality  competition_type_cup  competition_type_league  dynamic_league_tier_0  dynamic_league_tier_1  dynamic_league_tier_2  dynamic_league_tier_3  dynamic_league_tier_4  dynamic_league_tier_5  dynamic_league_tier_6  dynamic_league_tier_7  dynamic_league_tier_8  dynamic_league_tier_9
0   0.152107   1.145994    0.148508    0.146999   0.326896   0.181883  -0.532964                        -0.03991                           0.03015                        -0.017876                  0.114165                       0.140128                   -0.263688                       -0.088997                          -0.21542                        -0.071008                  0.106464                       0.141479                    -0.27564              -1.01444              -1.381686             -1.013201              -1.379679                  0.10089                  0.129521                          -0.107537                            -0.025334                 0.082413                  0.127983                          -0.136422                            -0.123077                      0.199287                       0.1137                         0.101165                   0.088534                       0.090922                       0.088174                           0.075249                     0.226962                          0.23236                  0.042319                      0.072137                      0.202422                     0.104953                         0.102501                   0.133787                       0.129651                        0.04345                           0.114559                     0.225309                          0.22285                  0.041447                      0.065651              0.015162         1.871271        -1.980253                                -0.15772                                   -0.057062                               -0.111059                              -0.044426                                   -0.059182                               -0.152792                                    -0.04832                                 -0.1113                               -0.04949                                   -0.069398                                      -0.098135                                     -0.029473                                      -0.098811                                     -0.031231           -0.387572           -0.386605 -0.000203           0.057179               -0.540486                   1.0                      0.0                    0.0                    0.0                    0.0                    1.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0
1  -2.011459  -1.934172    0.148508    0.146999  -0.746391  -1.942466  -0.981749                        -0.03991                           0.03015                        -0.017876                  0.114165                       0.140128                   -0.263688                       -0.088997                          -0.21542                        -0.071008                  0.106464                       0.141479                    -0.27564              -1.01444              -1.381686             -1.013201              -1.379679                  0.10089                  0.129521                          -0.107537                            -0.025334                 0.082413                  0.127983                          -0.136422                            -0.123077                      0.199287                       0.1137                         0.101165                   0.088534                       0.090922                       0.088174                           0.075249                     0.226962                          0.23236                  0.042319                      0.072137                      0.202422                     0.104953                         0.102501                   0.133787                       0.129651                        0.04345                           0.114559                     0.225309                          0.22285                  0.041447                      0.065651              0.015162        -0.041680         0.051503                                -0.15772                                   -0.057062                               -0.111059                              -0.044426                                   -0.059182                               -0.152792                                    -0.04832                                 -0.1113                               -0.04949                                   -0.069398                                      -0.098135                                     -0.029473                                      -0.098811                                     -0.031231           -0.387572           -0.386605 -0.000203           0.057179               -0.540486                   1.0                      0.0                    0.0                    0.0                    0.0                    1.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0
2   0.347526  -0.339365    0.148508    0.146999  -0.102419   0.049111  -0.321772                        -0.03991                           0.03015                        -0.017876                  0.114165                       0.140128                   -0.263688                       -0.088997                          -0.21542                        -0.071008                  0.106464                       0.141479                    -0.27564              -1.01444              -1.381686             -1.013201              -1.379679                  0.10089                  0.129521                          -0.107537                            -0.025334                 0.082413                  0.127983                          -0.136422                            -0.123077                      0.199287                       0.1137                         0.101165                   0.088534                       0.090922                       0.088174                           0.075249                     0.226962                          0.23236                  0.042319                      0.072137                      0.202422                     0.104953                         0.102501                   0.133787                       0.129651                        0.04345                           0.114559                     0.225309                          0.22285                  0.041447                      0.065651              0.015162         1.297386        -1.332712                                -0.15772                                   -0.057062                               -0.111059                              -0.044426                                   -0.059182                               -0.152792                                    -0.04832                                 -0.1113                               -0.04949                                   -0.069398                                      -0.098135                                     -0.029473                                      -0.098811                                     -0.031231           -0.387572           -0.386605 -0.000203           0.057179               -0.540486                   1.0                      0.0                    0.0                    0.0                    0.0                    1.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0
3  -2.011459  -1.934172    0.148508    0.146999  -0.746391  -1.942466  -0.981749                        -0.03991                           0.03015                        -0.017876                  0.114165                       0.140128                   -0.263688                       -0.088997                          -0.21542                        -0.071008                  0.106464                       0.141479                    -0.27564              -1.01444              -1.381686             -1.013201              -1.379679                  0.10089                  0.129521                          -0.107537                            -0.025334                 0.082413                  0.127983                          -0.136422                            -0.123077                      0.199287                       0.1137                         0.101165                   0.088534                       0.090922                       0.088174                           0.075249                     0.226962                          0.23236                  0.042319                      0.072137                      0.202422                     0.104953                         0.102501                   0.133787                       0.129651                        0.04345                           0.114559                     0.225309                          0.22285                  0.041447                      0.065651              0.015162        -0.041680         0.051503                                -0.15772                                   -0.057062                               -0.111059                              -0.044426                                   -0.059182                               -0.152792                                    -0.04832                                 -0.1113                               -0.04949                                   -0.069398                                      -0.098135                                     -0.029473                                      -0.098811                                     -0.031231           -0.387572           -0.386605 -0.000203           0.057179               -0.540486                   1.0                      0.0                    0.0                    0.0                    0.0                    1.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0
4  -2.011459  -1.934172    0.148508    0.146999  -0.746391  -1.942466  -0.981749                        -0.03991                           0.03015                        -0.017876                  0.114165                       0.140128                   -0.263688                       -0.088997                          -0.21542                        -0.071008                  0.106464                       0.141479                    -0.27564              -1.01444              -1.381686             -1.013201              -1.379679                  0.10089                  0.129521                          -0.107537                            -0.025334                 0.082413                  0.127983                          -0.136422                            -0.123077                      0.199287                       0.1137                         0.101165                   0.088534                       0.090922                       0.088174                           0.075249                     0.226962                          0.23236                  0.042319                      0.072137                      0.202422                     0.104953                         0.102501                   0.133787                       0.129651                        0.04345                           0.114559                     0.225309                          0.22285                  0.041447                      0.065651              0.015162        -0.041680         0.051503                                -0.15772                                   -0.057062                               -0.111059                              -0.044426                                   -0.059182                               -0.152792                                    -0.04832                                 -0.1113                               -0.04949                                   -0.069398                                      -0.098135                                     -0.029473                                      -0.098811                                     -0.031231           -0.387572           -0.386605 -0.000203           0.057179               -0.540486                   1.0                      0.0                    0.0                    0.0                    0.0                    1.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0

Preprocessing future data (5122 matches)...
Shape of processed X_future_processed_df: (5122, 87)

--- End of Section 4: Data Preparation for Modeling ---

Sample of processed and scaled training data (last 5 rows):
       team_a_xg  team_b_xg  team_a_xga  team_b_xga  odds_ft_1  odds_ft_x  odds_ft_2  rolling_goals_scored_form_home  rolling_goals_conceded_form_home  rolling_points_earned_form_home  rolling_xg_for_form_home  rolling_xga_against_form_home  days_since_last_match_home  rolling_goals_scored_form_away  rolling_goals_conceded_form_away  rolling_points_earned_form_away  rolling_xg_for_form_away  rolling_xga_against_form_away  days_since_last_match_away  home_matches_last_7d  home_matches_last_14d  away_matches_last_7d  away_matches_last_14d  home_rolling_xg_as_home  home_rolling_xga_as_home  home_rolling_goals_scored_as_home  home_rolling_goals_conceded_as_home  away_rolling_xg_as_away  away_rolling_xga_as_away  away_rolling_goals_scored_as_away  away_rolling_goals_conceded_as_away  rolling_possession_form_home  rolling_shots_for_form_home  rolling_shots_against_form_home  rolling_sot_for_form_home  rolling_sot_against_form_home  rolling_corners_for_form_home  rolling_corners_against_form_home  rolling_fouls_for_form_home  rolling_fouls_against_form_home  rolling_da_for_form_home  rolling_da_against_form_home  rolling_possession_form_away  rolling_shots_for_form_away  rolling_shots_against_form_away  rolling_sot_for_form_away  rolling_sot_against_form_away  rolling_corners_for_form_away  rolling_corners_against_form_away  rolling_fouls_for_form_away  rolling_fouls_against_form_away  rolling_da_for_form_away  rolling_da_against_form_away  market_prob_btts_yes  market_prob_o25  market_prob_u25  rolling_synth_goals_minus_xg_form_home  rolling_synth_goals_per_xg_ratio_form_home  rolling_synth_goals_per_shot_form_home  rolling_synth_goals_per_sot_form_home  rolling_synth_sot_per_shot_ratio_form_home  rolling_synth_goals_minus_xg_form_away  rolling_synth_goals_per_xg_ratio_form_away  rolling_synth_goals_per_shot_form_away  rolling_synth_goals_per_sot_form_away  rolling_synth_sot_per_shot_ratio_form_away  rolling_synth_xga_per_shot_conceded_form_home  rolling_synth_xga_per_sot_conceded_form_home  rolling_synth_xga_per_shot_conceded_form_away  rolling_synth_xga_per_sot_conceded_form_away  pre_match_home_elo  pre_match_away_elo  elo_diff  elo_prob_home_win  dynamic_league_quality  competition_type_cup  competition_type_league  dynamic_league_tier_0  dynamic_league_tier_1  dynamic_league_tier_2  dynamic_league_tier_3  dynamic_league_tier_4  dynamic_league_tier_5  dynamic_league_tier_6  dynamic_league_tier_7  dynamic_league_tier_8  dynamic_league_tier_9
32340   2.566927  -1.074227   -0.448258   -0.289600  -0.411526   2.916983   3.770088                        2.779777                          0.030150                         1.403461                  0.603456                       0.053806                   -0.295416                        0.452862                         -0.215420                         0.784672                 -0.114690                      -0.767252                   -0.120187              0.536518              -0.445482             -1.013201              -1.379679                -0.138431                 -0.260246                           0.277739                            -0.940801                 0.114063                 -0.708107                          -0.136422                            -0.402791                      1.506492                     0.278665                        -0.436480                   1.133951                      -0.588069                       0.573657                          -0.893836                     0.226962                         0.190503                  0.637705                     -0.832401                     -0.257640                    -0.424539                        -0.358845                   0.227809                      -0.464306                       0.139506                           0.510398                     0.767673                         0.264600                 -0.245803                      0.215639             -0.668259         2.324339        -2.406266                                2.129071                                    2.329682                                2.546436                               2.269012                                    1.270602                                0.481010                                    0.961526                                1.473430                               1.620141                                    0.957459                                       1.411598                                      3.737178                                       0.265225                                     -0.647743            2.890600            1.066271  1.459658           1.460774                2.291165                   1.0                      0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    1.0
32341  -0.838946   1.724502   -0.591760   -0.551023   0.146584   0.128774  -0.379850                        1.369933                          0.620295                        -0.302143                  0.921495                      -0.360032                   -0.295416                        0.452862                         -1.726499                         1.355126                  1.284609                      -0.276797                   -0.308951              0.536518              -0.445482              0.550497              -0.440249                 1.219026                 -0.389065                           2.332544                             0.890134                 1.190143                 -0.348179                           0.990688                            -0.123077                      1.019767                     0.691079                        -0.643267                   1.038913                      -0.200074                       2.127203                          -0.796928                     0.059989                        -0.018780                  0.637705                     -1.171603                      1.094664                     1.204667                        -1.239595                   1.074008                      -0.959269                       1.484288                          -0.677118                     0.642512                        -0.361646                  1.245684                     -0.568914              1.316708         0.702245        -0.787415                                0.662073                                    1.224101                                1.362719                               0.990958                                    0.724018                               -0.373886                                    0.263680                                0.433769                               0.969031                                    0.182273                                       0.971077                                      0.169545                                       2.137611                                      1.682622            1.541877            3.199332 -1.332294          -1.479593                2.291165                   1.0                      0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    1.0
32342  -0.057270  -1.042956   -1.441177   -0.370971  -0.162523   0.075666   0.021417                        3.343714                         -1.445211                         2.256263                  1.023431                      -1.328408                   -0.295416                       -0.359926                         -0.215420                        -0.356234                 -0.062417                      -0.476726                   -0.297848              0.536518              -0.445482              0.550497              -0.440249                 0.858084                 -1.232641                           1.561992                            -1.551113                 0.181883                 -0.309318                          -0.136422                            -0.682505                      1.089299                     0.814803                        -1.387699                   1.228989                      -1.170061                       0.185271                          -1.087653                     0.018245                         1.027638                  0.042319                     -1.612565                      0.787956                    -0.668920                        -0.568547                   0.039765                      -0.068335                       0.139506                          -1.072957                     0.350470                         0.849096                  0.682234                     -0.615064              0.269004        -0.078671        -0.196453                                2.375263                                    2.447131                                2.224870                               2.351442                                    0.519707                               -0.287905                                   -0.003642                                0.611437                              -0.328537                                    1.863307                                       1.063056                                      1.837233                                       0.442145                                      0.321109            3.643106            2.033208  1.286478           1.327082                2.291165                   1.0                      0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    1.0
32343   0.459194   0.723839   -0.338486   -0.375148  -0.365732   1.371519   1.565764                        0.524027                         -1.445211                         1.119193                  0.815482                       0.024985                   -0.295416                        2.349369                          0.086796                         0.784672                  0.890554                      -0.421059                   -0.308951              0.536518              -0.445482              0.550497              -0.440249                 0.975783                  0.142285                           1.048291                            -1.551113                 0.331087                 -0.390791                           1.554243                            -0.402791                      0.950235                     0.031217                        -1.056840                   1.038913                      -1.170061                       0.864947                           0.172158                    -0.065242                         0.943925                  1.255559                      0.094750                      1.275900                     0.675175                        -0.149142                   1.638141                       0.228644                       0.907953                           0.015599                    -0.150173                         0.181101                  0.151927                     -0.788127              0.537778         2.124456        -2.282585                               -0.033355                                    0.296953                                0.870464                               0.008730                                    1.883070                                1.586479                                    1.527285                                1.765867                               1.524024                                    1.202937                                       1.937734                                      2.010371                                      -0.240808                                     -1.439937            4.414904            2.362991  1.640032           1.589848                2.291165                   1.0                      0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    1.0
32344  -0.141021  -0.401907   -0.028630   -0.185331  -0.131040   0.022557  -0.163377                        1.087964                         -0.264922                         1.687728                  0.403662                       0.009158                   -0.284840                        0.723792                          0.086796                         0.499446                  0.761883                      -0.315904                   -0.286744              0.536518              -0.445482              0.550497              -0.440249                 0.175432                 -0.096787                           0.791440                             0.584978                 0.882692                 -0.023628                           0.990688                             0.156637                      0.338351                    -0.092507                        -0.064264                   0.373648                      -0.782066                       0.573657                          -0.215476                    -0.524420                        -0.939628                  1.424064                      0.908834                      0.801897                     1.123206                         0.270263                   1.074008                       0.228644                       1.772456                          -0.182320                    -0.191893                         0.181101                  0.660138                     -0.395851              1.792056         1.139849        -1.085267                                0.730601                                    1.206999                                1.521432                               1.600676                                    0.613916                                0.191132                                    0.511492                                0.301510                               0.285366                                   -0.088372                                       0.038168                                      1.622747                                      -0.762945                                     -0.553047            1.598113            0.825353  0.617739           0.722488                0.645058                   1.0                      0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    0.0                    1.0                    0.0                    0.0

--- Section 5: Model Training (LightGBM for Goal Prediction) ---

Training LightGBM model for Home Goals...
Training until validation scores don't improve for 100 rounds
Early stopping, best iteration is:
[179]	valid_0's poisson: 0.747335
Home Goals model training complete.

Training LightGBM model for Away Goals...
Training until validation scores don't improve for 100 rounds
Early stopping, best iteration is:
[129]	valid_0's poisson: 0.849741
Away Goals model training complete.

--- Model Evaluation (Goal Predictions on Test Set) ---
Home Goals Model - Test Poisson Deviance (from training): 0.7473
Home Goals Model - Test RMSE: 1.1884, Test MAE: 0.9249
Away Goals Model - Test Poisson Deviance (from training): 0.8497
Away Goals Model - Test RMSE: 1.0998, Test MAE: 0.8521
Predictions stored in df_model_input for the test set.

Plotting feature importances...

--- End of Section 5: Model Training (LightGBM for Goal Prediction) ---

--- Section 5.1: Hyperparameter Tuning for LightGBM Goal Models ---

Tuning Home Goals Model with Optuna...
Best hyperparameters for Home Goals Model: {'n_estimators': 2800, 'learning_rate': 0.023439426404959718, 'num_leaves': 107, 'max_depth': 4, 'min_child_samples': 67, 'feature_fraction': 0.8208294187543781, 'bagging_fraction': 0.7845359808244037, 'bagging_freq': 5, 'lambda_l1': 0.04607169351467253, 'lambda_l2': 0.2918805218482033}

Tuning Away Goals Model with Optuna...
Best hyperparameters for Away Goals Model: {'n_estimators': 700, 'learning_rate': 0.02973272010807008, 'num_leaves': 220, 'max_depth': 4, 'min_child_samples': 65, 'feature_fraction': 0.6043276023665759, 'bagging_fraction': 0.7504002710071848, 'bagging_freq': 6, 'lambda_l1': 0.0024154015993141996, 'lambda_l2': 0.0014029307411282236}
Adjusted n_estimators for Home Model to best_iteration: 570
Adjusted n_estimators for Away Model to best_iteration: 493

--- End of Section 5 Addendum: Hyperparameter Tuning ---

--- Section 5.2: Training Final Models with Optimal Hyperparameters ---
Using optimal parameters found by Optuna (Section 5.1) for final model training.

Training Final LightGBM model for Home Goals with Optimal Parameters...
Final Home Goals model training complete.

Training Final LightGBM model for Away Goals with Optimal Parameters...
Training until validation scores don't improve for 100 rounds
Early stopping, best iteration is:
[228]	valid_0's poisson: 0.852275	valid_0's l2: 1.21381
Final Away Goals model training complete.

--- Tuned Model Evaluation (Goal Predictions on Test Set) ---
TUNED Home Goals Model - Test Poisson Deviance (from training): 0.7491
TUNED Home Goals Model - Test RMSE: 1.1886, Test MAE: 0.9277
TUNED Away Goals Model - Test Poisson Deviance (from training): 0.8523
TUNED Away Goals Model - Test RMSE: 1.1017, Test MAE: 0.8539
TUNED predictions stored in df_model_input for the test set.

Plotting feature importances for TUNED models...

--- End of Section 5.2: Training Final Models with Optimal Hyperparameters ---

--- Section 6: Deriving Scoreline Probabilities (Bivariate Poisson Layer) ---
Generating LightGBM mean goal predictions for the TRAINING set...

Optimizing for the covariance parameter 'phi' using the training set...
Number of clean training samples for phi optimization after initial NaN filter: 32345
Number of training samples for phi optimization after lambda filter: 32340
Dynamically optimized phi by segment: {'low_scoring': 0.023742924973224267, 'medium_scoring': 5.923432572319995e-06, 'high_scoring': 5.923432572319995e-06}

Generating scoreline probability matrices for test set matches...
Scoreline probability matrices generated for 8087 test matches.

Sample Scoreline Matrix (first test match, if available):
          0         1         2         3         4         5         6             7
0  0.064256  0.079858  0.049624  0.020558  0.006387  0.001588  0.000329  5.838530e-05
1  0.096531  0.119970  0.074550  0.030884  0.009596  0.002385  0.000494  8.771315e-05
2  0.072509  0.090115  0.055998  0.023198  0.007208  0.001792  0.000371  6.588642e-05
3  0.036309  0.045126  0.028042  0.011617  0.003609  0.000897  0.000186  3.299407e-05
4  0.013637  0.016948  0.010532  0.004363  0.001356  0.000337  0.000070  1.239188e-05
5  0.004097  0.005092  0.003164  0.001311  0.000407  0.000101  0.000021  3.723303e-06
6  0.001026  0.001275  0.000792  0.000328  0.000102  0.000025  0.000005  9.322628e-07
7  0.000220  0.000274  0.000170  0.000070  0.000022  0.000005  0.000001  2.000790e-07

Sample 1X2 probabilities derived from Bivariate Poisson scoreline matrices:
              home_name           away_name  model_prob_home_win_biv  model_prob_draw_biv  model_prob_away_win_biv
32345    Nagoya Grampus     Albirex Niigata                 0.432495             0.253303                 0.314202
32346       Kyoto Sanga          JEF United                 0.594112             0.224520                 0.181368
32347     Shanghai SIPG  Johor Darul Ta'zim                 0.632859             0.200027                 0.167114
32348  Maccabi Tel Aviv      Hapoel Katamon                 0.759410             0.145909                 0.094681
32349      Sparta Praha            Salzburg                 0.508116             0.281470                 0.210414

Re-calculating Expected Value (EV) using Bivariate Poisson probabilities...
EV calculations with Bivariate Poisson probabilities complete.
       ev_home_win_biv  ev_draw_biv  ev_away_win_biv
32345         0.016362    -0.189430        -0.057393
32346         0.841747    -0.214179        -0.637265
32347        -0.031725    -0.049872        -0.164431
32348        -0.020361    -0.328817        -0.147872
32349         0.168667     0.013293        -0.394008

--- End of Section 6: Deriving Scoreline Probabilities (Bivariate Poisson Layer) ---

--- Section 6.5 (NEW): Asian Handicap (AH) Probability Calculation ---
Calculating Asian Handicap probabilities for 8087 test matches.
Asian Handicap outcome probabilities calculated for various lines.

--- Sample of Test Matches with Asian Handicap Probabilities ---
              home_name           away_name  p_home_win_ah_-0p5  p_home_win_ah_0  p_home_win_ah_0p5  p_home_covers_ah_-0p75  p_home_covers_ah_-0p25
32345    Nagoya Grampus     Albirex Niigata            0.432495         0.432495           0.685798                0.322752                0.305843
32346       Kyoto Sanga          JEF United            0.594112         0.594112           0.818632                0.470184                0.481852
32347     Shanghai SIPG  Johor Darul Ta'zim            0.632859         0.632859           0.832886                0.515353                0.532846
32348  Maccabi Tel Aviv      Hapoel Katamon            0.759410         0.759410           0.905319                0.654315                0.686455
32349      Sparta Praha            Salzburg            0.508116         0.508116           0.789586                0.376409                0.367381

--- End of Section 6.5 (NEW): Asian Handicap (AH) Probability Calculation ---

--- Section 6.8 (Revised): Synthetic AH Odds/Lines from Market 1X2 Odds ---
Generating synthetic AH lines and odds from 1X2 market odds for 8087 test matches.
Optimizing market-implied lambdas for each match (can take time)...
Market-implied lambdas calculated.
Synthetic Asian Handicap lines and odds (market-based) generated.

--- Sample of Test Matches with Market-Based Synthetic Asian Handicap Data ---
              home_name           away_name  odds_ft_1  odds_ft_x  odds_ft_2  market_lambda_h  market_lambda_a  market_pred_goal_diff  synth_ah_line_home_market_based  synth_ah_odds_home_market_based  synth_ah_odds_away_market_based
32345    Nagoya Grampus     Albirex Niigata       2.35       3.20       3.00         1.174175         1.003685               0.170491                            -0.25                            1.925                            1.925
32346       Kyoto Sanga          JEF United       3.10       3.50       2.00         1.140730         1.485849              -0.345119                             0.25                            1.925                            1.925
32347     Shanghai SIPG  Johor Darul Ta'zim       1.53       4.75       5.00         2.212964         1.147700               1.065264                            -1.00                            1.925                            1.925
32348  Maccabi Tel Aviv      Hapoel Katamon       1.29       4.60       9.00         1.968676         0.585595               1.383081                            -1.50                            1.925                            1.925
32349      Sparta Praha            Salzburg       2.30       3.60       2.88         1.393729         1.216748               0.176981                            -0.25                            1.925                            1.925

--- End of Section 6.8 (Revised): Synthetic AH Odds/Lines from Market 1X2 Odds ---

--- Section 7: Betting Strategy and Backtesting for Asian Handicaps ---
Starting Asian Handicap backtesting for 8087 test matches.

Calculating EV for market-derived main AH lines...
EV calculations for synthetic main AH lines complete.

Running initial AH backtest...

--- AH Backtest Results (EV Threshold = 0.05, Stake = 1.0) ---
Total Matches in Test Set: 8087
Number of AH Bets Placed: 3851
Total Wagered (on resolved bets): 3851.00
Total Profit/Loss: 320.19 units
Return on Investment (ROI): 8.31%
Win Rate (bets with positive profit): 54.56%
Non-Losing Bet Rate (pushes or better): 58.06%

Optimizing EV Threshold for AH Betting...

--- AH EV Threshold Optimization Results ---
Best ROI for AH: 37.59% at EV Threshold = 0.45
  Number of Bets: 115.0
  Profit/Loss: 43.22 units

--- End of Section 7: Betting Strategy and Backtesting for Asian Handicaps ---

--- Section 7.1 (Extended): Granular Backtesting Analysis (Combined Segments) ---
Further analyzing 3851 placed AH bets with combined segments...


--- Combined Analysis: AH Line Performance by League Tier ---

League Tier: 1
                Num Bets  Total P/L  Total Wagered  ROI (%)  Win Rate (+P/L %)  Non-Losing Rate (%)
line_betted_on                                                                                     
 1.25               47.0      16.83           47.0    35.80              78.72                78.72
 0.75               79.0      16.20           79.0    20.51              55.70                55.70
-0.75              111.0      18.11          111.0    16.32              67.57                67.57
 1.50               40.0       6.20           40.0    15.50              60.00                60.00
 0.50              119.0      15.75          119.0    13.24              58.82                58.82
 0.25              118.0      14.58          118.0    12.35              66.10                66.10
-0.25              125.0       8.42          125.0     6.74              48.80                48.80
 1.00               60.0       3.20           60.0     5.33              40.00                68.33
-0.50               96.0       2.18           96.0     2.27              53.12                53.12
-1.00               82.0      -1.62           82.0    -1.98              42.68                58.54
-1.50               42.0      -1.58           42.0    -3.75              50.00                50.00
-1.25               54.0      -9.00           54.0   -16.67              37.04                37.04

League Tier: 2
                Num Bets  Total P/L  Total Wagered  ROI (%)  Win Rate (+P/L %)  Non-Losing Rate (%)
line_betted_on                                                                                     
 1.50               54.0       9.53           54.0    17.64              61.11                61.11
 1.00               99.0      16.62           99.0    16.79              45.45                74.75
 0.50              175.0      19.43          175.0    11.10              57.71                57.71
-1.50               50.0       3.90           50.0     7.80              56.00                56.00
-0.75              155.0      10.76          155.0     6.94              61.29                61.29
-0.25              235.0      14.75          235.0     6.28              46.81                46.81
-0.50              169.0      10.02          169.0     5.93              55.03                55.03
-1.00              107.0       5.70          107.0     5.33              41.12                67.29
 0.75              155.0       6.60          155.0     4.26              46.45                46.45
 1.25               71.0       2.60           71.0     3.66              61.97                61.97
 0.25              228.0       3.74          228.0     1.64              59.65                59.65
-1.25               61.0      -0.60           61.0    -0.98              45.90                45.90

League Tier: 3
                Num Bets  Total P/L  Total Wagered  ROI (%)  Win Rate (+P/L %)  Non-Losing Rate (%)
line_betted_on                                                                                     
 0.25              223.0      40.85          223.0    18.32              67.71                67.71
-0.25              185.0      29.00          185.0    15.68              54.05                54.05
-0.50              149.0      20.40          149.0    13.69              59.06                59.06
 0.50              156.0      19.17          156.0    12.29              58.33                58.33
 1.50               31.0       3.65           31.0    11.77              58.06                58.06
 1.00               68.0       6.98           68.0    10.26              39.71                73.53
-1.50               51.0       4.82           51.0     9.46              56.86                56.86
 0.75              111.0       8.45          111.0     7.61              48.65                48.65
-1.00               90.0       2.38           90.0     2.64              38.89                66.67
-0.75              151.0       1.29          151.0     0.85              58.28                58.28
 1.25               57.0      -2.26           57.0    -3.97              57.89                57.89
-1.25               47.0      -6.85           47.0   -14.57              38.30                38.30


--- Combined Analysis: AH Line Performance by Competition Type ---

Competition Type: cup
                Num Bets  Total P/L  Total Wagered  ROI (%)  Win Rate (+P/L %)  Non-Losing Rate (%)
line_betted_on                                                                                     
 1.00               60.0      11.75           60.0    19.58              50.00                73.33
-0.75               89.0      13.48           89.0    15.14              66.29                66.29
 0.25              106.0      15.73          106.0    14.83              65.09                65.09
-0.25               90.0      12.48           90.0    13.86              52.22                52.22
-1.00               67.0       8.68           67.0    12.95              46.27                70.15
 0.75               84.0      10.70           84.0    12.74              52.38                52.38
-1.50               45.0       5.05           45.0    11.22              57.78                57.78
 0.50               97.0      10.80           97.0    11.13              57.73                57.73
-0.50               82.0       8.48           82.0    10.34              57.32                57.32
 1.50               40.0       2.35           40.0     5.88              55.00                55.00
 1.25               62.0       1.90           62.0     3.06              61.29                61.29
-1.25               40.0      -2.27           40.0    -5.69              42.50                42.50

Competition Type: league
                Num Bets  Total P/L  Total Wagered  ROI (%)  Win Rate (+P/L %)  Non-Losing Rate (%)
line_betted_on                                                                                     
 1.50               85.0      17.03           85.0    20.03              62.35                62.35
 1.25              113.0      15.26          113.0    13.51              67.26                67.26
 0.50              353.0      43.55          353.0    12.34              58.36                58.36
 0.25              463.0      43.44          463.0     9.38              63.93                63.93
 1.00              167.0      15.05          167.0     9.01              39.52                72.46
-0.25              455.0      39.70          455.0     8.73              49.23                49.23
 0.75              261.0      20.55          261.0     7.87              48.28                48.28
-0.50              332.0      24.12          332.0     7.27              55.72                55.72
-0.75              328.0      16.69          328.0     5.09              60.67                60.67
-1.50               98.0       2.10           98.0     2.14              53.06                53.06
-1.00              212.0      -2.23          212.0    -1.05              39.15                62.74
-1.25              122.0     -14.18          122.0   -11.62              40.16                40.16


--- Combined Analysis: League Tier by Competition Type ---
                              Num Bets  Total P/L  Total Wagered  ROI (%)  Win Rate (+P/L %)  Non-Losing Rate (%)
league_tier competition_type                                                                                     
3           cup                  214.0      51.09          214.0    23.87              63.55                67.76
1           cup                  132.0      25.72          132.0    19.49              62.88                63.64
2           league              1043.0      80.76         1043.0     7.74              53.88                57.43
1           league               841.0      63.54          841.0     7.55              54.34                57.79
3           league              1105.0      76.79         1105.0     6.95              53.94                57.47
2           cup                  516.0      22.29          516.0     4.32              51.74                55.62

--- End of Section 7.1 (Extended): Granular Backtesting Analysis ---

--- Section 7.1.1 (NEW): Visualizing Granular Performance ---

--- Plot 1: ROI by Asian Handicap Line, Grouped by League Tier ---

--- Plot 2: Heatmap of ROI (%) - League Tier vs. Asian Handicap Line ---

--- Plot 3: ROI by Aggregated Strategic Segments ---

--- Performance by Aggregated Strategic Segments ---
                                                           Num Bets  Total P/L  Total Wagered  ROI (%)  Win Rate (+P/L %)  Non-Losing Rate (%)
league_tier position                  line_magnitude                                                                                          
1           Underdog (Betting on "+") Large Line (>= 1.0)     147.0      26.22          147.0    17.84              57.82                69.39
                                      Small Line (< 1.0)      316.0      46.53          316.0    14.72              60.76                60.76
3           Underdog (Betting on "+") Small Line (< 1.0)      490.0      68.47          490.0    13.97              60.41                60.41
2           Underdog (Betting on "+") Large Line (>= 1.0)     224.0      28.75          224.0    12.83              54.46                67.41
3           Favorite (Betting on "-") Small Line (< 1.0)      485.0      50.69          485.0    10.45              56.91                56.91
1           Favorite (Betting on "-") Small Line (< 1.0)      332.0      28.71          332.0     8.65              56.33                56.33
2           Favorite (Betting on "-") Small Line (< 1.0)      559.0      35.54          559.0     6.36              53.31                53.31
3           Underdog (Betting on "+") Large Line (>= 1.0)     156.0       8.36          156.0     5.36              50.00                64.74
2           Underdog (Betting on "+") Small Line (< 1.0)      558.0      29.76          558.0     5.33              55.38                55.38
            Favorite (Betting on "-") Large Line (>= 1.0)     218.0       9.00          218.0     4.13              45.87                58.72
3           Favorite (Betting on "-") Large Line (>= 1.0)     188.0       0.35          188.0     0.19              43.62                56.91
1           Favorite (Betting on "-") Large Line (>= 1.0)     178.0     -12.20          178.0    -6.85              42.70                50.00

--- End of Section 7.1.1: Visualizing Granular Performance ---

--- Section 7.2 (NEW): Automated Policy Generation & Refined AH Backtest ---
Starting refined AH backtest for 8087 matches.

Defining meta-rules for automated policy generation...

Automated Betting Policy Generated.

Running REFINED AH backtest with AUTOMATED Segmented Policy...

--- AUTOMATED REFINED AH Backtest Results (Segmented Policy, Stake = 1.0) ---
Number of AH Bets Placed: 2395
Total Wagered: 2395.00
Total Profit/Loss: 78273285.27 units
Return on Investment (ROI): 3268195.63%
Win Rate (bets with positive profit): 58.20%
Non-Losing Bet Rate: 62.30%

--- End of Section 7.2 (NEW): Automated Policy Generation & Refined AH Backtest ---

--- Section 8 (Final & Complete): Generating Future Match Recommendations & Outputting to Google Sheet ---

Filtering for matches in the next 7 days...
Current reference time for filtering (GMT+8, naive): 2025-08-10 10:06:45.806386
Processing 396 future matches for the upcoming period...
  Predicting mean goals for upcoming matches...
  Deriving scoreline probabilities...
  Calculating AH outcome probabilities...
  Generating synthetic AH lines/odds for upcoming matches...
  Calculating EV for main synthetic AH line...
  Applying refined betting policy...
Generated 36 betting recommendations.

--- Recommended Bets for Upcoming Period (Sorted) ---
