class ParlayKing{constructor(){this.cache=new Map,this.data={metrics:{},pnlByMonth:[],bankrollSeries:[],recommendations:[],roiHeatmap:[],topSegments:[],settledBets:[],parlayWins:[]},this.filters=this.getFiltersFromURL(),this.version=window.__PK_VERSION||"latest",this.parlayPage=0,this.uiState={viewMode:window.innerWidth<=768?"mobile":"desktop",expandedCards:new Set,activeFilters:{dateRange:"30",league:"all",minEV:0,confidence:"all"},currentDay:"today",filtersDrawerOpen:!1,renderedGames:20,virtualScrollOffset:0},this.renderQueue=[],this.isRendering=!1,this.cardInstances=new Map,this.dayNavigator=new DayNavigator(this),this.filterManager=new FilterManager(this.uiState.activeFilters),this.analyticsManager=new AnalyticsManager(this.data),this.init()}parseParlayWins(e){return Array.isArray(e)&&0!==e.length?e.map(e=>{var t=parseFloat(e.stake||100),a=parseFloat(e.total_odds||e.odds||1),i=parseFloat(e.payout||t*a),n=parseFloat(e.profit||i-t),s=(e.legs||e.legs_str||"").toString().split(" || ").filter(Boolean).map(e=>{var[e,t]=e.split(" | "),[e,a]=(e||"").split(" vs ").map(e=>(e||"").trim());let i=t||"",n=1;t=i.lastIndexOf("@");return-1!==t&&(n=parseFloat(i.slice(t+1))||1,i=i.slice(0,t).trim()),{home:e,away:a,recommendation:i,odds:n}}),r=this.parseDateTimeSafe(e.window_start||e.start_dt||e.start),d=this.parseDateTimeSafe(e.window_end||e.end_dt||e.end);return{legs:s,legCount:parseInt(e.leg_count||s.length||0),totalOdds:a,stake:t,totalPayout:i,profit:n,returnPercent:n/Math.max(t,1)*100,dateRange:r&&d?this.isSameDay(r,d)?this.formatDate(r):this.formatDate(r)+" - "+this.formatDate(d):"--",startDate:r||null,endDate:d||null}}):[]}async init(){this.showLoading(!0),await this.loadAllData(),this.initializeUI(),this.updateUI(),this.showLoading(!1)}async loadCSV(t,a=!0){window.Papa||await new Promise(e=>{var t=document.createElement("script");t.src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js",t.onload=e,document.head.appendChild(t)});var i="csv_"+t;if(a&&this.cache.has(i))return this.cache.get(i);try{var n,s,r,d=this.cache.has(i),l=a&&d?{"If-None-Match":localStorage.getItem("etag_"+t)||""}:{};let e=await fetch(t+"?t="+Date.now(),{headers:l});if((e=304!==e.status||d?e:await fetch(t+"?t="+Date.now(),{cache:"no-store"})).ok)return n=await e.text(),s=Papa.parse(n,{header:!0,dynamicTyping:!0,skipEmptyLines:!0}).data,this.cache.set(i,s),(r=e.headers.get("ETag"))&&localStorage.setItem("etag_"+t,r),s;throw new Error(`Failed to load ${t}: `+e.status)}catch(e){return console.warn(`Failed to load ${t}:`,e),this.cache.get(i)||[]}}async loadAllData(){try{var[e,t,a,i,n,s,r,d,l]=await Promise.all([this.loadCSV("metrics.csv"),this.loadCSV("pnl_by_month.csv"),this.loadCSV("bankroll_series_90d.csv"),this.loadCSV("latest_recommendations.csv"),this.loadCSV("roi_heatmap.csv"),this.loadCSV("top_segments.csv"),this.loadCSV("settled_bets.csv"),this.loadCSV("parlay_wins.csv").catch(()=>[]),this.loadCSV("unified_games.csv").catch(e=>(console.warn("Unified games CSV not available:",e),[]))]),o=(this.data={metrics:this.parseMetrics(e),pnlByMonth:t,bankrollSeries:this.parseBankrollSeries(a),recommendations:this.parseRecommendations(i),roiHeatmap:n,topSegments:s,settledBets:this.parseSettledBets(r),unifiedGames:this.parseUnifiedGames(l)},this.parseParlayWins(d||[]));this.data.parlayWins=o&&0<o.length?o:this.calculateParlayWinsFromBets(),this.populateFilterOptions(),document.querySelectorAll(".lazy-load").forEach(e=>{e.classList.add("loaded")})}catch(e){console.error("Failed to load data:",e),this.showError("Failed to load dashboard data. Please try refreshing the page.")}}parseMetrics(e){let t={};return Array.isArray(e)&&e.forEach(e=>{e&&e.metric&&null!=e.value&&""!==e.value&&(t[e.metric]=e.value)}),t}parseDateTimeSafe(e){if(!e)return null;if(e instanceof Date)return isNaN(e)?null:e;try{var t,a,i,n,s,r,d,l,o,c=String(e).replace(" ","T"),m=new Date(c);return isNaN(m)?(m=new Date(c+"Z"),isNaN(m)?([t,a]=String(e).split(" "),[i,n,s]=t.split("-").map(Number),[r=0,d=0,l=0]=(a||"").split(":").map(Number),o=new Date(i,(n||1)-1,s||1,r,d,l),isNaN(o)?null:o):m):m}catch(e){return null}}parseGmt8(t){if(!t)return null;try{var[e,a="00:00:00"]=String(t).split(" "),[i,n,s]=e.split("-").map(Number),[r,d,l]=a.split(":").map(Number),o=Date.UTC(i,(n||1)-1,s||1,(r||0)-8,d||0,l||0);return new Date(o)}catch(e){return this.parseDateTimeSafe(t)}}parseBankrollSeries(e){return Array.isArray(e)?e.filter(e=>e&&e.dt_gmt8&&void 0!==e.cum_bankroll).map(e=>({date:this.parseDateTimeSafe(e.dt_gmt8),bankroll:parseFloat(e.cum_bankroll)||0})).sort((e,t)=>e.date-t.date):[]}parseRecommendations(e){return Array.isArray(e)?e.filter(e=>e&&e.dt_gmt8&&e.home&&e.away).map(e=>{var t=this.parseGmt8(e.dt_gmt8)||this.parseDateTimeSafe(e.dt_gmt8);return t?{datetime:t,league:e.league||"",home:e.home,away:e.away,recommendation:e.rec_text||e.recommendation||"",line:parseFloat(e.line)||0,odds:parseFloat(e.odds)||0,ev:parseFloat(e.ev)||0,confidence:e.confidence||"Medium",kingsCall:e.kings_call_insight||"No additional insights available."}:(console.warn("Invalid date for recommendation: "+e.dt_gmt8),null)}).filter(Boolean).sort((e,t)=>{var a=e.datetime-t.datetime;return console.log(`Sorting: ${e.home} vs ${e.away} (${e.datetime}) vs ${t.home} vs ${t.away} (${t.datetime}) = `+a),a}):[]}parseSettledBets(e){return Array.isArray(e)?e.filter(e=>e&&e.home&&e.away).map(e=>{var t=(e.bet_type_refined_ah||e.bet_type||"").toString(),a=parseFloat(e.line_betted_on_refined||e.line||0),i=parseFloat(e.odds_betted_on_refined||e.odds||0),n=parseFloat(e.pl||0),s=(e.status||"").toString().toLowerCase(),s=0<n||"won"===s||"win"===s,r=0===n,d=!r&&i||1,l=t.toLowerCase();let o;return o=l.includes("away")?e.away+" "+(0<=a?"+":"")+(isFinite(a)?a.toFixed(2):"0.00"):l.includes("home")?e.home+" "+(0<=a?"+":"")+(isFinite(a)?a.toFixed(2):"0.00"):t?t+" "+(0<=a?"+":"")+(isFinite(a)?a.toFixed(2):"0.00"):"AH "+(0<=a?"+":"")+(isFinite(a)?a.toFixed(2):"0.00"),{fixture_id:e.fixture_id,league:e.league||"",home:e.home,away:e.away,home_score:parseInt(e.home_score||0),away_score:parseInt(e.away_score||0),bet_type:t,line:a,odds:i||1,effectiveOdds:d,stake:parseFloat(e.stake||0),pl:n,isWin:s,isPush:r,recommendation:o,status:e.status||"",datetime:this.parseGmt8(e.dt_gmt8)||this.parseDateTimeSafe(e.dt_gmt8)}}).sort((e,t)=>(t.datetime||0)-(e.datetime||0)):[]}parseUnifiedGames(e){return Array.isArray(e)&&0!==e.length?e.filter(e=>e&&e.datetime_gmt8&&e.home_name&&e.away_name).map(e=>{var t=this.parseGmt8(e.datetime_gmt8)||this.parseDateTimeSafe(e.datetime_gmt8);return t?{datetime:t,league:e.league||"",leagueShort:e.league_short||e.league||"",leagueFlag:e.league_flag||"⚽",leagueColor:e.league_color||"#666666",home:e.home_name,away:e.away_name,odds1:parseFloat(e.odds_1)||0,oddsX:parseFloat(e.odds_x)||0,odds2:parseFloat(e.odds_2)||0,tier:parseInt(e.league_tier)||3,competitionType:e.competition_type||"league",isFuture:"True"===e.is_future||!0===e.is_future||"true"===e.is_future,status:e.status||"",hasRecommendation:"True"===e.has_recommendation||!0===e.has_recommendation||"true"===e.has_recommendation,recText:e.rec_text||"",line:parseFloat(e.line)||0,recOdds:parseFloat(e.rec_odds)||0,ev:parseFloat(e.ev)||0,confidence:e.confidence||"",kingsCall:e.kings_call||"",kingsCallAgreement:e.kings_call_agreement||"",primarySignal:e.primary_signal||"",secondarySignal:e.secondary_signal||""}:(console.warn("Invalid date for game: "+e.datetime_gmt8),null)}).filter(Boolean).map(e=>{var t=this.parseAsianHandicapData(e);return{...e,...t}}).sort((e,t)=>e.datetime-t.datetime):(console.log("No unified games data available - will use fallback recommendations"),[])}parseAsianHandicapData(e){let t=null,a=null,i=null,n=!1;var s,r;return void 0!==e.ah_line_home&&void 0!==e.ah_line_away?(a=parseFloat(e.ah_line_home),i=parseFloat(e.ah_line_away),e.hasRecommendation&&e.recText&&(s=e.recText.match(/^(.+?)\s+([-+]?\d*\.?\d+)$/))&&(r=s[1].trim(),s=parseFloat(s[2]),r===e.home&&Math.abs(s-a)<.01?t=e.home:r===e.away&&Math.abs(s-i)<.01?t=e.away:(e.home.includes(r)||r.includes(e.home))&&Math.abs(s-a)<.01?t=e.home:(e.away.includes(r)||r.includes(e.away))&&Math.abs(s-i)<.01&&(t=e.away))):e.hasRecommendation&&e.recText?(r=e.recText.match(/^(.+?)\s+([-+]?\d*\.?\d+)$/))&&(t=r[1].trim(),s=parseFloat(r[2]),t===e.home?(a=s,i=-s):t===e.away?(i=s,a=-s):e.home.includes(t)||t.includes(e.home)?(a=s,i=-s,t=e.home):(e.away.includes(t)||t.includes(e.away))&&(i=s,a=-s,t=e.away)):0<e.odds1&&0<e.oddsX&&0<e.odds2&&(console.warn("Using 1X2 estimation for AH lines - CSV data should be authoritative"),e=2.5*((r=1/e.odds1)/(r=r+1/e.oddsX+(s=1/e.odds2))-s/r),a=1.875<e?-2:1.625<e?-1.75:1.375<e?-1.5:1.125<e?-1.25:.875<e?-1:.625<e?-.75:.375<e?-.5:.125<e?-.25:-.125<e?0:-.375<e?.25:-.625<e?.5:-.875<e?.75:-1.125<e?1:-1.375<e?1.25:-1.625<e?1.5:-1.875<e?1.75:2,i=-a),null!==a&&null!==i&&(n=0===a&&0===i,a=Math.round(4*a)/4,i=Math.round(4*i)/4),{recommendedTeam:t,homeLine:a,awayLine:i,isPk:n,hasAhData:null!==a&&null!==i}}calculateParlayWinsFromBets(){var e=this.data.settledBets||[],e=this.groupBetsByWindow(e,12);let a=[];return e.forEach(e=>{var t=e.filter(e=>e.isWin||e.isPush);for(let e=3;e<=Math.min(6,t.length);e++)this.getCombinations(t,e).sort((e,t)=>this.calculateParlayOdds(t)-this.calculateParlayOdds(e)).slice(0,2).forEach(e=>a.push(this.createParlayItem(e)))}),a.sort((e,t)=>t.totalPayout-e.totalPayout).slice(0,6)}groupBetsByWindow(e,t=0){let a=new Map,s=(e,t,a,i)=>new Date(Date.UTC(e,t-1,a,i-8,0,0)),i=e=>{var e=new Date(e.getTime()+288e5),t=e.getUTCFullYear(),a=e.getUTCMonth()+1,i=e.getUTCDate(),n=e.getUTCHours();return 5<=n&&n<17?s(t,a,i,5):17<=n?s(t,a,i,17):(n=new Date(e.getTime()-864e5),s(n.getUTCFullYear(),n.getUTCMonth()+1,n.getUTCDate(),17))};return e.forEach(e=>{var t;e.datetime&&(t=i(e.datetime).getTime(),a.has(t)||a.set(t,[]),a.get(t).push(e))}),Array.from(a.values())}getCombinations(a,e){if(1===e)return a.map(e=>[e]);if(e>a.length)return[];let i=[];for(let t=0;t<a.length-e+1;t++)this.getCombinations(a.slice(t+1),e-1).forEach(e=>{i.push([a[t],...e])});return i}calculateParlayOdds(e){return e.reduce((e,t)=>e*(t.effectiveOdds||t.odds||1),1)}createParlayItem(e){var t=this.calculateParlayOdds(e),a=100*t,i=a-100;return{legs:e,legCount:e.length,totalOdds:t,stake:100,totalPayout:a,profit:i,returnPercent:i/100*100,dateRange:this.getParlayDateRange(e)}}getParlayDateRange(e){var e=e.map(e=>e.datetime).sort(),t=e[0],e=e[e.length-1];return this.isSameDay(t,e)?this.formatDate(t):this.formatDate(t)+" - "+this.formatDate(e)}isSameDay(e,t){return e.toDateString()===t.toDateString()}createCustomChart(p,g,u={}){let v=document.getElementById(p);if(v)if(v.innerHTML="",g&&Array.isArray(g)&&0!==g.length){let h=g.filter(e=>e&&"number"==typeof e.value&&!isNaN(e.value));if(0!==h.length){var p=document.createElementNS("http://www.w3.org/2000/svg","svg"),g=(p.setAttribute("class","chart-svg"),p.setAttribute("viewBox","0 0 800 400"),p.setAttribute("preserveAspectRatio","xMidYMid meet"),document.createElementNS("http://www.w3.org/2000/svg","defs")),f=document.createElementNS("http://www.w3.org/2000/svg","linearGradient"),y=(f.setAttribute("id","chartGradient"),f.setAttribute("x1","0%"),f.setAttribute("y1","0%"),f.setAttribute("x2","0%"),f.setAttribute("y2","100%"),document.createElementNS("http://www.w3.org/2000/svg","stop")),w=(y.setAttribute("offset","0%"),y.setAttribute("stop-color","#FF7A45"),y.setAttribute("stop-opacity","0.3"),document.createElementNS("http://www.w3.org/2000/svg","stop"));w.setAttribute("offset","100%"),w.setAttribute("stop-color","#FF7A45"),w.setAttribute("stop-opacity","0.05"),f.appendChild(y),f.appendChild(w),g.appendChild(f),p.appendChild(g);let a={top:20,right:30,bottom:40,left:60},i=800-a.left-a.right,n=400-a.top-a.bottom,s=e=>a.left+e/Math.max(h.length-1,1)*i,t=Math.min(...h.map(e=>e.value)),r=Math.max(...h.map(e=>e.value)),d=.1*(r-t),l=e=>a.top+n-(e-(t-d))/(r+d-(t-d))*n;var b=document.createElementNS("http://www.w3.org/2000/svg","g");for(let t=0;t<=5;t++){var x=a.top+t/5*n;let e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1",a.left),e.setAttribute("y1",x),e.setAttribute("x2",a.left+i),e.setAttribute("y2",x),e.setAttribute("class","chart-grid-line"),b.appendChild(e)}p.appendChild(b);let o=`M ${a.left} `+(a.top+n);h.forEach((e,t)=>{o+=` L ${s(t)} `+l(e.value)}),o+=` L ${a.left+i} ${a.top+n} Z`;y=document.createElementNS("http://www.w3.org/2000/svg","path");y.setAttribute("d",o),y.setAttribute("class","chart-area"),p.appendChild(y);let c=`M ${s(0)} `+l(h[0].value),e=(h.slice(1).forEach((e,t)=>{c+=` L ${s(t+1)} `+l(e.value)}),document.createElementNS("http://www.w3.org/2000/svg","path")),m=(e.setAttribute("d",c),e.setAttribute("class","chart-line"),p.appendChild(e),document.createElementNS("http://www.w3.org/2000/svg","g"));h.forEach((t,e)=>{var a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",s(e)),a.setAttribute("cy",l(t.value)),a.setAttribute("r","4"),a.setAttribute("class","chart-point"),a.setAttribute("data-index",e),a.addEventListener("mouseenter",e=>this.showChartTooltip(e,t,v)),a.addEventListener("mouseleave",()=>this.hideChartTooltip(v)),m.appendChild(a)}),p.appendChild(m);var E=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e=0;e<=5;e++){var L=t+(r-t)*(e/5),$=document.createElementNS("http://www.w3.org/2000/svg","text");$.setAttribute("x",a.left-10),$.setAttribute("y",a.top+n-e/5*n+4),$.setAttribute("text-anchor","end"),$.setAttribute("class","chart-axis-text"),$.textContent=u.formatY?u.formatY(L):L.toFixed(1),E.appendChild($)}p.appendChild(E),v.appendChild(p);w=document.createElement("div");return w.className="chart-tooltip",v.appendChild(w),p}v.innerHTML='<div class="chart-error">No valid data points</div>'}else v.innerHTML='<div class="chart-error">No data available</div>'}showChartTooltip(e,t,a){a=a.querySelector(".chart-tooltip");a.innerHTML=`
            <strong>${this.formatDate(t.date)}</strong><br>
            Value: ${this.formatCurrency(t.value)}
        `,a.style.left=e.pageX+10+"px",a.style.top=e.pageY-10+"px",a.classList.add("visible")}hideChartTooltip(e){e.querySelector(".chart-tooltip").classList.remove("visible")}getFiltersFromURL(){var e=new URLSearchParams(window.location.search);return{dateRange:e.get("dateRange")||"30",league:e.get("league")||"all",minEV:parseFloat(e.get("minEV"))||0,confidence:e.get("confidence")||"all"}}updateURL(){let a=new URLSearchParams;Object.entries(this.filters).forEach(([e,t])=>{"all"!==t&&0!==t&&"30"!==t&&a.set(e,t)});var e=""+window.location.pathname+(a.toString()?"?"+a.toString():"");window.history.replaceState({},"",e)}populateFilterOptions(){var e=[...new Set(this.data.recommendations.map(e=>e.league))].filter(Boolean).sort();let a=document.getElementById("league-filter");for(;1<a.children.length;)a.removeChild(a.lastChild);e.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)})}initializeUI(){this.setupEventListeners(),this.setFilterValues(),this.setupChartResize()}setupEventListeners(){var e=document.getElementById("date-range"),e=(e&&e.addEventListener("change",e=>{this.filters.dateRange=e.target.value,this.updateURL(),this.updateUI()}),document.getElementById("league-filter")),e=(e&&e.addEventListener("change",e=>{this.filters.league=e.target.value,this.updateURL(),this.updateUI()}),document.getElementById("min-ev")),e=(e&&e.addEventListener("input",e=>{this.filters.minEV=parseFloat(e.target.value)||0,this.updateURL(),this.updateUI()}),document.getElementById("confidence-filter")),e=(e&&e.addEventListener("change",e=>{this.filters.confidence=e.target.value,this.updateURL(),this.updateUI()}),document.getElementById("reset-filters")),e=(e&&e.addEventListener("click",()=>{this.resetFilters()}),document.querySelectorAll(".toggle-btn[data-mode]").forEach(e=>{e.addEventListener("click",e=>{document.querySelectorAll(".toggle-btn[data-mode]").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),this.updateChart()})}),document.querySelectorAll(".range-btn[data-range]").forEach(e=>{e.addEventListener("click",e=>{document.querySelectorAll(".range-btn[data-range]").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),this.updateChart()})}),document.getElementById("export-recommendations"));e&&e.addEventListener("click",()=>{this.exportFilteredRecommendations()}),this.initScheduleFilters(),window.location.search.includes("debug=true")&&this.initMobileCardV2Controls()}initScheduleFilters(){document.getElementById("unified-games-container")&&(this.filters.gameTimeFilter||(this.filters.gameTimeFilter="all"),document.querySelectorAll(".filter-tab").forEach(e=>{e.addEventListener("click",e=>{var t=e.target.dataset.filter;document.querySelectorAll(".filter-tab").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),this.filters.gameTimeFilter=t,this.renderUnifiedSchedule(),this.featureFlags.mobile_card_v2&&this.trackEvent("schedule_filter_changed",{filter:t})})}),window.innerWidth<=768||this.featureFlags.mobile_card_v2)&&this.initFiltersDrawer()}initFiltersDrawer(){var e=document.getElementById("filters-drawer-btn"),t=document.getElementById("filters-drawer"),a=document.getElementById("filters-drawer-overlay"),i=document.getElementById("filters-drawer-close");e&&t&&(e.addEventListener("click",()=>{this.openFiltersDrawer()}),i&&i.addEventListener("click",()=>{this.closeFiltersDrawer()}),a&&a.addEventListener("click",()=>{this.closeFiltersDrawer()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.mobileState.filtersDrawerOpen&&this.closeFiltersDrawer()}),this.syncDrawerFilters())}openFiltersDrawer(){var e=document.getElementById("filters-drawer");e&&(e.classList.add("open"),this.mobileState.filtersDrawerOpen=!0,document.body.style.overflow="hidden")}closeFiltersDrawer(){var e=document.getElementById("filters-drawer");e&&(e.classList.remove("open"),this.mobileState.filtersDrawerOpen=!1,document.body.style.overflow="")}syncDrawerFilters(){var e=document.getElementById("drawer-date-range"),t=document.getElementById("drawer-league"),a=document.getElementById("drawer-min-ev"),i=document.getElementById("drawer-confidence"),e=(e&&(e.value=this.filters.dateRange),t&&(t.value=this.filters.league),a&&(a.value=this.filters.minEV),i&&(i.value=this.filters.confidence),this.updateRangeValue(),a&&a.addEventListener("input",()=>this.updateRangeValue()),document.getElementById("drawer-apply-filters")),t=(e&&e.addEventListener("click",()=>{this.applyDrawerFilters()}),document.getElementById("drawer-reset-filters"));t&&t.addEventListener("click",()=>{this.resetDrawerFilters()})}updateRangeValue(){var e=document.getElementById("drawer-min-ev"),t=document.getElementById("drawer-min-ev-value");e&&t&&(t.textContent=e.value+"%")}applyDrawerFilters(){var e=document.getElementById("drawer-date-range"),t=document.getElementById("drawer-league"),a=document.getElementById("drawer-min-ev"),i=document.getElementById("drawer-confidence");e&&(this.filters.dateRange=e.value),t&&(this.filters.league=t.value),a&&(this.filters.minEV=parseInt(a.value)),i&&(this.filters.confidence=i.value),this.updateUI(),this.closeFiltersDrawer(),this.trackEvent("filters_applied_from_drawer",{dateRange:this.filters.dateRange,league:this.filters.league,minEV:this.filters.minEV,confidence:this.filters.confidence})}resetDrawerFilters(){this.filters={...this.filters,dateRange:"last30",league:"all",minEV:0,confidence:"all"},this.syncDrawerFilters(),this.updateUI(),this.trackEvent("filters_reset_from_drawer")}trackEvent(e,t={}){console.log("Analytics: "+e,t)}initMobileCardV2Controls(){window.location.search.includes("debug=true")&&this.addMobileCardV2Toggle()}addMobileCardV2Toggle(){var e=`
            <div style="position: fixed; top: 10px; right: 10px; z-index: 9999; background: var(--panel); border: 1px solid var(--border); border-radius: 4px; padding: 8px; font-size: 12px;">
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <input type="checkbox" id="mobile-card-v2-toggle" ${this.featureFlags.mobile_card_v2?"checked":""}>
                    Mobile Card V2
                </label>
            </div>
        `,e=(document.body.insertAdjacentHTML("beforeend",e),document.getElementById("mobile-card-v2-toggle"));e&&e.addEventListener("change",e=>{this.featureFlags.mobile_card_v2=e.target.checked,localStorage.setItem("mobile_card_v2",e.target.checked),this.mobileState.isInfiniteScrollEnabled=e.target.checked,this.renderUnifiedSchedule(),console.log("Mobile Card V2: "+(e.target.checked?"Enabled":"Disabled"))})}renderGamesProgressively(e,t){this.mobileState.renderedGames=20;var a=this.groupGamesByImportance(t),i=this.getInitialGamesBatch(a,this.mobileState.renderedGames);e.innerHTML=`
            ${Object.entries(i).map(([e,t])=>this.renderTierGroup(e,t)).join("")}
            ${t.length>this.mobileState.renderedGames?'<div class="loading-sentinel" id="loading-sentinel">Loading more games...</div>':""}
        `,this.setupInfiniteScrollObserver(e,a,t)}getInitialGamesBatch(e,t){var a,i,n={};let s=0;for([a,i]of Object.entries(e)){var r=t-s;if(r<=0)break;n[a]=i.slice(0,r),s+=n[a].length}return n}setupInfiniteScrollObserver(t,a,i){this.infiniteScrollObserver&&this.infiniteScrollObserver.disconnect();var e=document.getElementById("loading-sentinel");!e||i.length<=this.mobileState.renderedGames||(this.infiniteScrollObserver=new IntersectionObserver(e=>{var[e]=e;e.isIntersecting&&this.loadMoreGames(t,a,i)},{rootMargin:"100px"}),this.infiniteScrollObserver.observe(e))}loadMoreGames(n,e,t){let s=this.mobileState.renderedGames;this.mobileState.renderedGames=Math.min(t.length,s+10);var e=this.getGamesBatch(e,s,this.mobileState.renderedGames),a=document.getElementById("loading-sentinel");a&&a.remove(),Object.entries(e).forEach(([t,e])=>{var a,i;0!==e.length&&((i=Array.from(n.querySelectorAll(".tier-group")).find(e=>e.querySelector(".tier-group-header h4")?.textContent===t))?(i=i.querySelector(".games-list"))&&(a=e.map((e,t)=>this.renderGameCard(e,s+t)).join(""),i.insertAdjacentHTML("beforeend",a)):(i=this.renderTierGroup(t,e),n.insertAdjacentHTML("beforeend",i)))}),this.mobileState.renderedGames<t.length&&(n.insertAdjacentHTML("beforeend",'<div class="loading-sentinel" id="loading-sentinel">Loading more games...</div>'),a=document.getElementById("loading-sentinel"))&&this.infiniteScrollObserver&&this.infiniteScrollObserver.observe(a),this.initGameCardInteractions()}getGamesBatch(e,t,a){var i,n,s={};let r=0;for([i,n]of Object.entries(e)){if(r>=a)break;var d=Math.max(0,t-r),l=Math.min(n.length,a-r);d<l&&(s[i]=n.slice(d,l)),r+=n.length}return s}renderSkeletonCards(e){var t=Array.from({length:6},(e,t)=>`
            <div class="game-card game-card--skeleton" aria-hidden="true">
                <div class="game-row ${this.featureFlags.mobile_card_v2?"game-row--v2":""}">
                    ${this.featureFlags.mobile_card_v2?this.renderSkeletonCardV2():this.renderSkeletonCardLegacy()}
                </div>
            </div>
        `).join("");e.innerHTML=`
            <div class="tier-group">
                <div class="tier-group-header skeleton-header">
                    <div class="skeleton-text skeleton-text--title"></div>
                    <div class="skeleton-text skeleton-text--count"></div>
                </div>
                <div class="games-list">
                    ${t}
                </div>
            </div>
        `}renderSkeletonCardV2(){return`
            <div class="game-meta">
                <div class="skeleton-text skeleton-text--time"></div>
                <div class="skeleton-text skeleton-text--league"></div>
            </div>
            
            <div class="game-matchup">
                <div class="team-row">
                    <div class="skeleton-text skeleton-text--team"></div>
                    <div class="skeleton-chip"></div>
                </div>
                <div class="vs-separator">vs</div>
                <div class="team-row">
                    <div class="skeleton-text skeleton-text--team"></div>
                    <div class="skeleton-chip"></div>
                </div>
            </div>
            
            <div class="game-actions">
                <div class="skeleton-pill"></div>
                <div class="skeleton-chevron"></div>
            </div>
        `}renderSkeletonCardLegacy(){return`
            <div class="skeleton-text skeleton-text--time"></div>
            <div class="skeleton-signal"></div>
            <div class="skeleton-text skeleton-text--teams"></div>
            <div class="skeleton-text skeleton-text--league"></div>
            <div class="skeleton-text skeleton-text--odds"></div>
            <div class="skeleton-chevron"></div>
        `}setFilterValues(){var e=document.getElementById("date-range"),e=(e&&(e.value=this.filters.dateRange),document.getElementById("league-filter")),e=(e&&(e.value=this.filters.league),document.getElementById("min-ev")),e=(e&&(e.value=this.filters.minEV),document.getElementById("confidence-filter"));e&&(e.value=this.filters.confidence)}resetFilters(){this.filters={dateRange:"30",league:"all",minEV:0,confidence:"all"},this.setFilterValues(),this.updateURL(),this.updateUI()}updateUI(){this.updateKPIs(),this.updateParlayWins(),this.updateChart(),this.updateRecommendationsTable(),this.renderUnifiedSchedule(),this.updateLastRunStatus()}updateKPIs(){var e,t;this.data&&(t=this.data.metrics||{},parseFloat(t.bets_30d),t=this.data.recommendations?.length||0,(e=document.getElementById("win-rate"))&&(e.textContent=64.91.toFixed(1)+"%"),(e=document.getElementById("roi-performance"))&&(e.textContent=`+${23.81.toFixed(1)}%`),(e=document.getElementById("non-losing-rate"))&&(e.textContent=68.15.toFixed(1)+"%"),(e=document.getElementById("total-bets"))&&(e.textContent=this.formatNumber(t)),(e=document.querySelector("#win-rate")?.parentElement?.querySelector(".kpi-subtitle"))&&(e.textContent="expected win rate"),(t=document.querySelector("#roi-performance")?.parentElement?.querySelector(".kpi-subtitle"))&&(t.textContent="projected return"),(e=document.querySelector("#non-losing-rate")?.parentElement?.querySelector(".kpi-subtitle"))&&(e.textContent="model accuracy"),(t=document.querySelector("#total-bets")?.parentElement?.querySelector(".kpi-subtitle"))&&(t.textContent="active recommendations"),this.updateMarketingTrend("win-rate-trend",64.91,"win"),this.updateMarketingTrend("roi-trend",23.81,"roi"),this.updateMarketingTrend("non-losing-trend",68.15,"nonlosing"),this.updateTrendIndicator("bets-trend",this.data.metrics&&this.data.metrics.bets_30d||0))}updateMarketingTrend(e,t,a){e=document.getElementById(e);e&&("win"===a&&60<=t?(e.textContent="🔥 Elite",e.className="kpi-trend positive"):"win"===a&&55<=t?(e.textContent="📈 Strong",e.className="kpi-trend positive"):"roi"===a&&15<=t?(e.textContent="💎 Premium",e.className="kpi-trend positive"):"roi"===a&&10<=t?(e.textContent="📊 Solid",e.className="kpi-trend positive"):"nonlosing"===a&&65<=t?(e.textContent="🛡️ Safe",e.className="kpi-trend positive"):0<t?(e.textContent="✅ Positive",e.className="kpi-trend positive"):(e.textContent="📊 Tracking",e.className="kpi-trend"))}updateTrendIndicator(e,t){e=document.getElementById(e);e&&(0<t?(e.textContent=`▲ ${Math.abs(t).toFixed(1)}%`,e.className="kpi-trend positive"):t<0?(e.textContent=`▼ ${Math.abs(t).toFixed(1)}%`,e.className="kpi-trend negative"):(e.textContent="━ 0.0%",e.className="kpi-trend"))}updateLastRunStatus(){var e=this.data.metrics.finished_at||this.data.metrics.started_at;e&&(document.getElementById("last-update").textContent="Last run: "+this.formatTimeAgo(e))}updateParlayWins(){var e=this.data.parlayWins||[];let t=new Date;t.setDate(t.getDate()-14);var a,e=e.filter(e=>((e.endDate instanceof Date&&!isNaN(e.endDate)?e.endDate:(e=(e.dateRange||"").split(" - "),(e=this.parseDateTimeSafe(e[e.length-1]))&&!isNaN(e)?e:null))||new Date)>=t),i=(document.getElementById("total-parlays").textContent=e.length,0<e.length?Math.max(...e.map(e=>e.returnPercent)):0);document.getElementById("max-payout").textContent=i.toFixed(0)+"%";let n=document.getElementById("parlay-grid");n.innerHTML="",0===e.length?n.innerHTML='<div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: var(--space-2xl);">No winning parlays found in recent data</div>':(i=window.innerWidth<=768?4:6,a=this.parlayPage*i,e.slice(a,a+i).forEach(e=>{var t=document.createElement("div");t.className="parlay-item",t.innerHTML=`
                <div class="parlay-header">
                    <span class="parlay-type">${e.legCount}-Leg Parlay</span>
                    <span class="parlay-date">${e.dateRange}</span>
                </div>
                <div class="parlay-legs">
                    ${e.legs.map(e=>`
                        <div class="parlay-leg">
                            <div class="leg-result">✓</div>
                            <div class="leg-details">
                                <div class="leg-match">${e.home} vs ${e.away}</div>
                                <div class="leg-bet">${e.recommendation}</div>
                            </div>
                            <div class="leg-odds">@${e.odds.toFixed(2)}</div>
                        </div>
                    `).join("")}
                </div>
                <div class="parlay-payout">
                    <div class="payout-calculation">$${e.stake} → $${e.totalPayout.toFixed(0)}</div>
                    <div class="payout-return">+${e.returnPercent.toFixed(0)}%</div>
                </div>
            `,n.appendChild(t)}),a=Math.ceil(e.length/i),(e=document.createElement("div")).style.gridColumn="1 / -1",e.style.display="flex",e.style.justifyContent="center",e.style.gap="12px",e.style.marginTop="12px",0<this.parlayPage&&((i=document.createElement("button")).className="action-btn",i.textContent="Previous",i.onclick=()=>{--this.parlayPage,this.updateParlayWins()},e.appendChild(i)),this.parlayPage<a-1&&((i=document.createElement("button")).className="action-btn primary",i.textContent="Load more",i.onclick=()=>{this.parlayPage+=1,this.updateParlayWins()},e.appendChild(i)),1<a&&n.appendChild(e))}updateChart(e=0){var t=document.querySelector(".toggle-btn.active")?.dataset.mode||"bankroll",a=document.querySelector(".range-btn.active")?.dataset.range||"30";let i=[...this.data.bankrollSeries];if("all"!==a){a=parseInt(a);let t=new Date;t.setDate(t.getDate()-a),i=i.filter(e=>e.date>=t)}let n;if("roi"===t){let t=i[0]?.bankroll||0;n=i.map(e=>({date:e.date,value:(e.bankroll-t)/Math.max(t,1)*100}))}else n=i.map(e=>({date:e.date,value:e.bankroll}));this.createCustomChart("bankroll-chart",n,{formatY:"roi"===t?e=>e.toFixed(1)+"%":e=>this.formatCurrency(e)})}setupChartResize(){let e;var t=()=>{clearTimeout(e),e=setTimeout(()=>{var e;this.data.bankrollSeries&&0<this.data.bankrollSeries.length&&(e=window.innerWidth<=768,this.updateChart({simplified:e})),document.getElementById("roi-heatmap")&&this.renderROIHeatmap(),document.getElementById("pnl-chart")&&this.renderPnLChart()},150)};window.addEventListener("resize",t),window.addEventListener("orientationchange",t),"screen"in window&&"orientation"in window.screen&&window.screen.orientation.addEventListener("change",t)}updateRecommendationsTable(){let a=document.getElementById("recommendations-tbody");var e;a&&(e=this.getFilteredRecommendations().sort((e,t)=>{var a=(e.datetime||0).getTime(),i=(t.datetime||0).getTime();return a!==i?a-i:parseFloat(t.ev)-parseFloat(e.ev)}).slice(0,10),a.innerHTML="",0===e.length?a.innerHTML='<tr><td colspan="7" style="text-align: center; color: var(--muted);">No recommendations found</td></tr>':e.forEach(e=>{var t=document.createElement("tr");t.innerHTML=`
                <td><strong>${e.home}</strong> vs ${e.away}</td>
                <td><span class="league-badge">${e.league}</span></td>
                <td><strong>${e.recommendation}</strong></td>
                <td>${parseFloat(e.odds).toFixed(2)}</td>
                <td class="${0<=e.ev?"positive":"negative"}">${0<=e.ev?"+":""}${(100*parseFloat(e.ev)).toFixed(1)}%</td>
                <td><span class="confidence-chip confidence-${e.confidence.toLowerCase()}">${e.confidence}</span></td>
                <td>${this.formatDateTime(e.datetime)}</td>
            `,a.appendChild(t)}))}getFilteredRecommendations(){let e=[...this.data.recommendations],t=new Date;if(e=e.filter(e=>e.datetime>t),"all"!==this.filters.league&&(e=e.filter(e=>e.league===this.filters.league)),"all"!==this.filters.confidence&&(e=e.filter(e=>e.confidence===this.filters.confidence)),0<this.filters.minEV&&(e=e.filter(e=>e.ev>=this.filters.minEV)),"all"!==this.filters.dateRange){var a=parseInt(this.filters.dateRange);let t=new Date;t.setDate(t.getDate()-a),e=e.filter(e=>e.datetime>=t)}return e}exportFilteredRecommendations(){var e=this.getFilteredRecommendations(),e=this.arrayToCSV(e,["datetime","league","home","away","recommendation","line","odds","ev","confidence"]);this.downloadCSV(e,"parlayking_recommendations.csv")}arrayToCSV(e,a){let i=[];return i.push(a.join(",")),e.forEach(t=>{var e=a.map(e=>{e=t[e];return"string"==typeof e?`"${e}"`:e});i.push(e.join(","))}),i.join("\n")}downloadCSV(e,t){var e=new Blob([e],{type:"text/csv"}),e=window.URL.createObjectURL(e),a=document.createElement("a");a.href=e,a.download=t,a.click(),window.URL.revokeObjectURL(e)}getFilteredGames(){let e=[...this.data.unifiedGames||[]],t=new Date;return e=e.filter(e=>e.datetime>t),"tier1"===this.filters.gameTimeFilter?e=e.filter(e=>1===e.tier):"recommendations"===this.filters.gameTimeFilter&&(e=e.filter(e=>e.hasRecommendation)),(e="all"!==this.filters.league?e.filter(e=>e.league===this.filters.league):e).sort((e,t)=>e.hasRecommendation!==t.hasRecommendation?t.hasRecommendation-e.hasRecommendation:e.tier!==t.tier?e.tier-t.tier:e.datetime-t.datetime)}groupGamesByImportance(e){let t={"Premier Matches":[],"Top Leagues":[],"Other Leagues":[]};return e.forEach(e=>{(e.hasRecommendation&&1===e.tier?t["Premier Matches"]:1===e.tier?t["Top Leagues"]:t["Other Leagues"]).push(e)}),Object.keys(t).forEach(e=>{0===t[e].length&&delete t[e]}),t}renderTierGroup(e,t){return`
            <div class="tier-group">
                <div class="tier-group-header">
                    <h4>${e}</h4>
                    <span class="game-count">${t.length} games</span>
                </div>
                <div class="games-list">
                    ${t.map((e,t)=>this.renderGameCard(e,t)).join("")}
                </div>
            </div>
        `}renderGameCard(e,t){return this.renderMobileGameCardV2(e,t)}renderMobileGameCardV2(e,t){var a=e.hasRecommendation||e.kingsCall,i=this.formatGameTime(e.datetime),{homeChip:n,awayChip:s}=this.renderAhChips(e),r=this.renderGameHints(e);return`
            <div class="game-card game-card--v2" 
                 data-game-index="${t}"
                 data-signal="${e.primarySignal}"
                 data-expandable="${a}"
                 data-is-future="${e.isFuture}">
                
                <div class="game-row game-row--v2">
                    <div class="game-meta">
                        <div class="game-time">${i}</div>
                    </div>
                    
                    <div class="game-matchup">
                        <div class="team-row">
                            <span class="team-name home">${e.home}</span>
                            ${n}
                        </div>
                        <div class="vs-separator">vs</div>
                        <div class="team-row">
                            <span class="team-name away">${e.away}</span>
                            ${s}
                        </div>
                    </div>
                    
                    <div class="game-actions">
                        <div class="game-hints">${r}</div>
                        <div class="expand-btn" ${a?'role="button" tabindex="0" aria-label="Expand game details"':""}>${a?"▼":""}</div>
                    </div>
                </div>
                
                ${a?this.renderExpandedContent(e):""}
            </div>
        `}renderAhChips(e){var t,a,i,n,s,r,d;return e.hasAhData?(t=e=>0===e?"PK":0<e?"+"+e:(""+e).replace("-","−"),a=e.hasRecommendation&&e.recommendedTeam===e.home,i=e.hasRecommendation&&e.recommendedTeam===e.away,n=["ah-chip",e.homeLine<0?"ah-chip--neg":0<e.homeLine?"ah-chip--pos":"ah-chip--pk",a?"ah-chip--selected":""].filter(Boolean).join(" "),s=["ah-chip",e.awayLine<0?"ah-chip--neg":0<e.awayLine?"ah-chip--pos":"ah-chip--pk",i?"ah-chip--selected":""].filter(Boolean).join(" "),r=`Home ${t(e.homeLine)} Asian handicap`+(a?", recommended":""),d=`Away ${t(e.awayLine)} Asian handicap`+(i?", recommended":""),{homeChip:`
            <div class="ah-chip-container">
                <span class="${n}" aria-label="${r}">
                    ${t(e.homeLine)}
                    ${a?'<span class="signal-crown" title="Has pick" aria-label="Has pick">👑</span>':""}
                </span>
            </div>
        `,awayChip:`
            <div class="ah-chip-container">
                <span class="${s}" aria-label="${d}">
                    ${t(e.awayLine)}
                    ${i?'<span class="signal-crown" title="Has pick" aria-label="Has pick">👑</span>':""}
                </span>
            </div>
        `}):{homeChip:'<span class="ah-chip ah-chip--empty" aria-label="No Asian handicap data">AH —</span>',awayChip:'<span class="ah-chip ah-chip--empty" aria-label="No Asian handicap data">AH —</span>'}}renderEvPill(e){if(!e.hasRecommendation||!e.ev)return"";var e=(100*e.ev).toFixed(1),t=parseFloat(e);let a="ev-pill";return`<span class="${a+=25<=t?" ev-pill--strong":10<=t?" ev-pill--medium":" ev-pill--neutral"}" title="Expected Value: ${e}%" aria-label="Expected value ${e} percent">EV ${e}%</span>`}renderGameHints(e){var t=[];return e.hasRecommendation&&e.ev&&5<=100*e.ev&&t.push('<span class="game-hint game-hint--value" title="High value bet">💎</span>'),t.join("")}getSignalIcon(e){return{"kings-call":"👑","high-ev":"📈","hot-pick":"🔥","value-bet":"💎"}[e]||""}getSignalTitle(e){return{"kings-call":"Analysis Available","high-ev":"High Expected Value","hot-pick":"Hot Pick - High Confidence","value-bet":"Value Bet Opportunity"}[e]||""}formatGameTime(e){return e?e.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",hour12:!1}):"--:--"}formatOddsCompact(e){return e.hasRecommendation&&e.line&&e.recOdds?`AH ${0<=e.line?"+"+e.line.toFixed(2):e.line.toFixed(2)} @ `+e.recOdds.toFixed(2):e.odds1&&e.oddsX&&e.odds2?`${e.odds1.toFixed(2)} ${e.oddsX.toFixed(2)} `+e.odds2.toFixed(2):"TBD"}renderExpandedContent(e){var t="High"===e.confidence?"👑":"Medium"===e.confidence?"⭐":"⚪";return`
            <div class="expanded-details hidden expanded-large">
                <div class="expanded-row recommendation-row">
                    <strong>Our Pick:</strong> ${e.recText} @ ${e.recOdds.toFixed(2)}
                    <span class="ev-badge">EV: ${(100*e.ev).toFixed(1)}%</span>
                </div>
                
                <div class="expanded-row stats-row">
                    <span class="stat-pill">Confidence: ${t}</span>
                    <span class="stat-pill">Tier: ${e.tier}</span>
                    <span class="odds-display">1X2: ${this.format1X2Odds(e)}</span>
                </div>
                
                ${e.kingsCall?`
                    <button class="analysis-toggle" aria-expanded="false">Show Analysis ▼</button>
                    <div class="kings-call-row hidden">
                        <span class="kings-call-text">${e.kingsCall}</span>
                    </div>
                `:""}
                
                <div class="expanded-actions">
                    <button class="action-btn-compact secondary" onclick="parlayKing.shareGame(${e.datetime.getTime()})">📤 Share</button>
                    <button class="action-btn-compact primary" onclick="parlayKing.exportGame(${e.datetime.getTime()})">📊 Export</button>
                </div>
            </div>
        `}format1X2Odds(e){return e.odds1&&e.oddsX&&e.odds2?`${e.odds1.toFixed(2)} ${e.oddsX.toFixed(2)} `+e.odds2.toFixed(2):"TBD"}initGameCardInteractions(){setTimeout(()=>{document.querySelectorAll(".game-card").forEach(t=>{"true"===t.dataset.expandable&&(t.addEventListener("click",e=>{e.target.closest(".expanded-actions")||e.target.closest(".action-btn")||e.target.closest(".ah-chip")||e.target.closest(".ev-pill")||e.target.closest(".game-hint")||this.toggleGameExpansion(t)}),t.style.cursor="pointer")})},100)}toggleGameExpansion(e){var t=e.querySelector(".expanded-details"),a=e.querySelector(".expand-btn");t&&a&&(!t.classList.contains("hidden")?(t.classList.add("hidden"),a.textContent="▼",e.classList.remove("expanded"),e.setAttribute("data-expanded","false"),a.setAttribute("aria-expanded","false")):(t.classList.remove("hidden"),a.textContent="▲",e.classList.add("expanded"),e.setAttribute("data-expanded","true"),a.setAttribute("aria-expanded","true"),this.trackEvent("card_expanded",{signal:e.dataset.signal,league:e.querySelector(".league-short")?.textContent||e.querySelector(".game-league")?.textContent,tier:e.dataset.tier,has_pick:""!==e.dataset.signal,ev_band:this.getEvBand(e)})))}getEvBand(e){e=e.querySelector(".ev-pill");return e?e.classList.contains("ev-pill--strong")?"high":e.classList.contains("ev-pill--medium")?"medium":"low":"none"}shareGame(t){var e=this.data.unifiedGames.find(e=>e.datetime.getTime()===t);e&&(e=e.hasRecommendation?`🎯 ${e.recText} @ ${e.recOdds.toFixed(2)} odds (EV: ${(100*e.ev).toFixed(1)}%) - ${e.home} vs `+e.away:`⚽ ${e.home} vs ${e.away} - `+this.formatDateTime(e.datetime),navigator.share?navigator.share({title:"ParlayKing Betting Pick",text:e,url:window.location.href}):navigator.clipboard.writeText(e).then(()=>{alert("Shared text copied to clipboard!")}))}exportGame(t){var e,a=this.data.unifiedGames.find(e=>e.datetime.getTime()===t);a&&a.hasRecommendation&&(e=[["Date/Time","League","Match","Recommendation","Odds","EV (%)","Confidence","Analysis"],[this.formatDateTime(a.datetime),a.league,a.home+" vs "+a.away,a.recText,a.recOdds.toFixed(2),(100*a.ev).toFixed(1)+"%",a.confidence,a.kingsCall]].map(e=>e.join(",")).join("\n"),this.downloadCSV(e,`pick_${a.home.replace(/\s+/g,"")}_vs_${a.away.replace(/\s+/g,"")}.csv`))}formatNumber(e){return(new Intl.NumberFormat).format(e)}formatCurrency(e,t=!1){t=t&&0<=e?"+":"";return 1e3<=Math.abs(e)?t+(e/1e3).toFixed(1)+"k":t+e.toFixed(2)}formatDate(e){e=e instanceof Date?e:this.parseDateTimeSafe(e);return e?new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",timeZone:"Asia/Singapore"}).format(e):"--"}formatDateTime(e){e=e instanceof Date?e:this.parseDateTimeSafe(e);return e?new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"Asia/Singapore"}).format(e):"--"}formatTimeAgo(e){var t;return e?(e=new Date(e),t=new Date,(t=Math.floor((t-e)/36e5))<1?"Just now":t<24?t+"h ago":Math.floor(t/24)+"d ago"):"--"}showLoading(e){var t=document.getElementById("loading-overlay");e?t.classList.remove("hidden"):t.classList.add("hidden")}showError(e){console.error(e)}initAnalyticsPage(){this.showLoading(!0),this.loadAllData().then(()=>{var e=document.getElementById("tier-select"),e=(e&&e.addEventListener("change",()=>this.renderROIHeatmap()),document.querySelectorAll(".range-btn[data-min-bets]").forEach(e=>{e.addEventListener("click",e=>{document.querySelectorAll(".range-btn[data-min-bets]").forEach(e=>e.classList.remove("active")),e.currentTarget.classList.add("active"),this.renderROIHeatmap()})}),document.getElementById("segments-tier-select"));e&&e.addEventListener("change",()=>this.renderTopSegments()),document.querySelectorAll(".toggle-btn[data-view]").forEach(e=>{e.addEventListener("click",e=>{var t=e.currentTarget.parentElement;t&&(t.querySelectorAll(".toggle-btn").forEach(e=>e.classList.remove("active")),e.currentTarget.classList.add("active"),this.renderPnLChart())})}),this.renderROIHeatmap(),this.renderPnLChart(),this.renderTopSegments(),this.updateLastRunStatus(),this.showLoading(!1)}).catch(e=>{console.error("Failed to load analytics data:",e),this.showError("Failed to load analytics data"),this.showLoading(!1)})}renderROIHeatmap(){var e=document.getElementById("roi-heatmap");if(e){let t=parseInt(document.querySelector(".range-btn.active[data-min-bets]")?.dataset.minBets||"30",10),r=parseInt(document.getElementById("tier-select")?.value||"1",10);let d=(Array.isArray(this.data.roiHeatmap)&&0<this.data.roiHeatmap.length?this.data.roiHeatmap.map(e=>({tier:+e.tier,line:+e.line,roi_pct:+e.roi_pct,n:+e.n})):this.getBacktestROIHeatmapFallback()).filter(e=>e.tier===r&&e.n>=t);var a=[...new Set(d.map(e=>e.line))].sort((e,t)=>e-t);if(0===a.length)e.innerHTML='<div class="chart-placeholder">No segments meet the selected filters</div>';else if(a.length<4){let s='<div class="segments-pills">';a.forEach(t=>{var e=d.find(e=>e.line===t)||{roi_pct:0,n:0},a=e.roi_pct,i=this.classForRoi(a),n=this.createSparklineFromRoi(a,`hm-${r}-`+t);s+=`
                    <div class="segment-pill">
                        <div class="pill-top">
                            <span class="roi-pill ${i}">${a.toFixed(1)}%</span>
                            <span class="line-text">${0<=t?"+":""}${t.toFixed(2)}</span>
                        </div>
                        <div class="pill-bottom">${n}<span class="bets-text">${this.formatNumber(e.n)} bets</span></div>
                    </div>`}),s+="</div>",void(e.innerHTML=s)}else{let n=`<div class="heatmap-grid" style="grid-template-columns: repeat(${Math.max(a.length,1)}, 1fr);">`;a.forEach(t=>{var e=d.find(e=>e.line===t)||{roi_pct:0,n:0},a=e.roi_pct,i=10<=a?"heat-pos":3<=a?"heat-mid":"heat-neg";n+=`
                <div class="heatmap-cell ${i}">
                    <div class="heatmap-value">${a.toFixed(1)}%</div>
                    <div class="heatmap-meta">${0<=t?"+":""}${t.toFixed(2)} · ${this.formatNumber(e.n)} bets</div>
                </div>`}),n+="</div>",e.innerHTML=n}}}getBacktestROIHeatmapFallback(){return[{tier:1,line:-.5,roi:28.4,bets:67},{tier:1,line:-.25,roi:25.1,bets:54},{tier:1,line:0,roi:22.7,bets:89},{tier:1,line:.25,roi:19.8,bets:43},{tier:1,line:.5,roi:24.3,bets:31},{tier:2,line:-.5,roi:21.6,bets:39},{tier:2,line:-.25,roi:18.9,bets:45},{tier:2,line:0,roi:20.4,bets:67},{tier:2,line:.25,roi:17.2,bets:38},{tier:3,line:0,roi:15.8,bets:20}].map(e=>({tier:e.tier,line:e.line,roi_pct:e.roi,n:e.bets}))}renderPnLChart(){var c=document.getElementById("pnl-chart");if(c){let e=Array.isArray(this.data.pnlByMonth)&&0<this.data.pnlByMonth.length?this.data.pnlByMonth:[{month:"2024-03",league:"England Premier League",pnl:1247.32},{month:"2024-03",league:"Spain La Liga",pnl:891.45},{month:"2024-04",league:"England Premier League",pnl:1534.67},{month:"2024-04",league:"Germany Bundesliga",pnl:1123.89},{month:"2024-04",league:"Italy Serie A",pnl:678.23},{month:"2024-05",league:"England Premier League",pnl:1789.34},{month:"2024-05",league:"Spain La Liga",pnl:1345.78},{month:"2024-05",league:"France Ligue 1",pnl:867.89}];var u=[...new Set(e.map(e=>String(e.month)))].sort();let i=[...new Set(e.map(e=>String(e.league)))].map(t=>({league:t,total:e.filter(e=>e.league===t).reduce((e,t)=>e+(parseFloat(t.pnl)||0),0)})).sort((e,t)=>Math.abs(t.total)-Math.abs(e.total)).slice(0,6).map(e=>e.league);var v=u.map(t=>{let a={};return i.forEach(e=>a[e]=0),e.filter(e=>String(e.month)===t&&i.includes(String(e.league))).forEach(e=>{a[String(e.league)]+=parseFloat(e.pnl)||0}),{month:t,byLeague:a}});let n=0,s=0,a=(v.forEach(e=>{let t=0,a=0;Object.values(e.byLeague).forEach(e=>{0<=e?t+=e:a+=e}),s=Math.max(s,t),n=Math.min(n,a)}),0===s&&0===n&&(s=1),c.innerHTML="",document.createElementNS("http://www.w3.org/2000/svg","svg")),r=(a.setAttribute("class","chart-svg"),a.setAttribute("viewBox","0 0 800 400"),a.setAttribute("preserveAspectRatio","xMidYMid meet"),{top:20,right:24,bottom:48,left:64});var f=800-r.left-r.right;let d=400-r.top-r.bottom,m=f/Math.max(u.length,1),h=e=>r.top+d-(e-n)/(s-n)*d;var y=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e=0;e<=5;e++){var w=r.top+e/5*d,b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("x1",r.left),b.setAttribute("y1",w),b.setAttribute("x2",r.left+f),b.setAttribute("y2",w),b.setAttribute("class","chart-grid-line"),y.appendChild(b)}a.appendChild(y);let t=["#FF7A45","#3A7BD5","#2ECC71","#F39C12","#9B59B6","#00C2A8"],p=e=>t[i.indexOf(e)%t.length],l=document.querySelector(".toggle-btn.active[data-view]")?.dataset.view||"stacked",g=document.createElementNS("http://www.w3.org/2000/svg","g");v.forEach((o,e)=>{let c=r.left+e*m;if("separated"===l){let s=Math.max(6,(m-16)/Math.max(i.length,1));i.forEach((e,t)=>{var a=o.byLeague[e]||0,t=c+8+t*s,i=Math.min(h(0),h(a)),a=Math.abs(h(a)-h(0)),n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",t.toFixed(1)),n.setAttribute("y",i.toFixed(1)),n.setAttribute("width",Math.max(4,s-2).toFixed(1)),n.setAttribute("height",Math.max(0,a).toFixed(1)),n.setAttribute("fill",p(e)),n.setAttribute("rx","3"),g.appendChild(n)})}else{let r=Math.max(10,m-16),d=0,l=0;i.forEach(e=>{var t,a,i,n,s=o.byLeague[e]||0;0!==s&&(t=(a=0<=s?d:l)+s,a=h(a),i=h(t),(n=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("x",(c+(m-r)/2).toFixed(1)),n.setAttribute("y",Math.min(a,i).toFixed(1)),n.setAttribute("width",r.toFixed(1)),n.setAttribute("height",Math.abs(i-a).toFixed(1)),n.setAttribute("fill",p(e)),n.setAttribute("rx","4"),g.appendChild(n),0<=s?d=t:l=t)})}var e=document.createElementNS("http://www.w3.org/2000/svg","text"),t=(e.setAttribute("x",(c+m/2).toFixed(1)),e.setAttribute("y",(r.top+d+24).toFixed(1)),e.setAttribute("text-anchor","middle"),e.setAttribute("class","chart-axis-text"),new Date(o.month+"-01"));e.textContent=t.toLocaleString("en-US",{month:"short"}),a.appendChild(e)}),a.appendChild(g);var x=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e=0;e<=5;e++){var E=n+(s-n)*(e/5),L=r.top+d-e/5*d+4,$=document.createElementNS("http://www.w3.org/2000/svg","text");$.setAttribute("x",r.left-10),$.setAttribute("y",L),$.setAttribute("text-anchor","end"),$.setAttribute("class","chart-axis-text"),$.textContent=this.formatCurrency(E,!0),x.appendChild($)}a.appendChild(x),c.appendChild(a);let o=document.createElement("div");o.className="chart-legend",i.forEach(e=>{var t=document.createElement("div");t.className="legend-item",t.innerHTML=`<span class="legend-swatch" style="background:${p(e)}"></span><span class="legend-label">${e}</span>`,o.appendChild(t)}),c.appendChild(o)}}createBacktestPnLChart(e){var t=[{month:"2024-03",pnl:1247.32,league:"England Premier League"},{month:"2024-03",pnl:891.45,league:"Spain La Liga"},{month:"2024-04",pnl:1534.67,league:"England Premier League"},{month:"2024-04",pnl:1123.89,league:"Germany Bundesliga"},{month:"2024-04",pnl:678.23,league:"Italy Serie A"},{month:"2024-05",pnl:1789.34,league:"England Premier League"},{month:"2024-05",pnl:1345.78,league:"Spain La Liga"},{month:"2024-05",pnl:867.89,league:"France Ligue 1"}],a=t.reduce((e,t)=>(e[t.month]||(e[t.month]=0),e[t.month]+=t.pnl,e),{}),a=Object.entries(a).map(([e,t])=>({date:new Date(e+"-01"),value:t})).sort((e,t)=>e.date-t.date);let i=0,n=a.map(e=>(i+=e.value,{date:e.date,value:i}));e.innerHTML='<div id="backtest-pnl-chart" class="custom-chart" style="height: 300px;"></div>',setTimeout(()=>{this.createCustomChart("backtest-pnl-chart",n,{formatY:e=>this.formatCurrency(e,!0)})},100),e.innerHTML+=`
            <div style="padding: 16px; text-align: center; color: var(--muted); font-size: 0.9em;">
                📈 Cumulative P&L from Backtest Period (${t.length} leagues, 493 total bets)
            </div>
        `}seededRandom(t){let a=2166136261;for(let e=0;e<t.length;e++)a^=t.charCodeAt(e),a=Math.imul(a,16777619);return()=>{a+=1831565813;var e=Math.imul(a^a>>>15,1|a);return(((e^=e+Math.imul(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296}}createSparklineFromRoi(n,e){let s=this.seededRandom(String(e));e=Array.from({length:8},(e,t)=>{var a=.45+n/100*.3,i=.2*(s()-.5);return Math.max(.1,Math.min(.9,a+i))});let a=76/(e.length-1);var t=e.map((e,t)=>[2+t*a,22-20*e]);let i=`M ${t[0][0]} `+t[0][1];for(let e=1;e<t.length;e++)i+=` L ${t[e][0]} `+t[e][1];return`<svg class="spark-svg" width="80" height="24" viewBox="0 0 80 24" preserveAspectRatio="none" aria-hidden="true">
      <path d="${""+i+` L ${t[t.length-1][0]} 22 L ${t[0][0]} 22 Z`}" class="spark-area"></path>
      <path d="${i}" class="spark-line"></path>
    </svg>`}classForRoi(e){return 10<=e?"excellent":3<=e?"good":"moderate"}renderTopSegments(){let r=document.getElementById("segments-tbody");if(r){r.innerHTML="";let t=parseInt(document.getElementById("segments-tier-select")?.value||"1",10);this.data.topSegments&&0!==this.data.topSegments.length?this.data.topSegments.filter(e=>parseInt(e.tier)===t).sort((e,t)=>parseFloat(t.roi_pct)-parseFloat(e.roi_pct)).forEach(e=>{var t=document.createElement("tr"),a=parseFloat(e.roi_pct),i=parseFloat(e.line),n=this.classForRoi(a),s=this.createSparklineFromRoi(a,e.tier+"-"+i);t.innerHTML=`
                    <td>Tier ${e.tier}</td>
                    <td>${0<i?"+":""}${i.toFixed(2)}</td>
                    <td class="roi-cell"><span class="roi-pill ${n}">${a.toFixed(1)}%</span></td>
                    <td>${this.formatNumber(e.n)}</td>
                    <td>
                        <div class="row-performance">
                            ${s}
                            <span class="performance-badge ${10<a?"excellent":5<a?"good":"moderate"}">
                                ${10<a?"Excellent":5<a?"Good":"Moderate"}
                            </span>
                        </div>
                    </td>`,r.appendChild(t)}):this.renderBacktestTopSegments(r,t)}}renderBacktestTopSegments(r,t=1){[{tier:1,line:-.5,roi_pct:28.4,n:67},{tier:1,line:.5,roi_pct:24.3,n:31},{tier:1,line:-.25,roi_pct:25.1,n:54},{tier:1,line:0,roi_pct:22.7,n:89},{tier:2,line:-.5,roi_pct:21.6,n:39},{tier:2,line:0,roi_pct:20.4,n:67},{tier:1,line:.25,roi_pct:19.8,n:43},{tier:2,line:-.25,roi_pct:18.9,n:45},{tier:2,line:.25,roi_pct:17.2,n:38},{tier:3,line:0,roi_pct:15.8,n:20}].filter(e=>e.tier===t).sort((e,t)=>t.roi_pct-e.roi_pct).forEach(e=>{var t=document.createElement("tr"),a=parseFloat(e.roi_pct),i=parseFloat(e.line),n=this.classForRoi(a),s=this.createSparklineFromRoi(a,`bt-${e.tier}-`+i);t.innerHTML=`
                    <td>Tier ${e.tier}</td>
                    <td>${0<i?"+":""}${i.toFixed(2)}</td>
                    <td class="roi-cell"><span class="roi-pill ${n}">${a.toFixed(1)}%</span></td>
                    <td>${this.formatNumber(e.n)}</td>
                    <td>
                        <div class="row-performance">
                            ${s}
                            <span class="performance-badge ${20<a?"excellent":15<a?"good":"moderate"}">
                                ${20<a?"Excellent":15<a?"Good":"Moderate"}
                            </span>
                        </div>
                    </td>`,r.appendChild(t)})}renderRecommendationsCards(){let a=document.getElementById("recommendations-cards");a&&this.data.recommendations&&(a.innerHTML="",this.getFilteredRecommendations().sort((e,t)=>e.datetime.getTime()!==t.datetime.getTime()?e.datetime-t.datetime:parseFloat(t.ev)-parseFloat(e.ev)).forEach(e=>{var t=document.createElement("div");t.className="rec-card",t.innerHTML=`
                <div class="card-header">
                    <span class="card-date">${this.formatDateTime(e.datetime)}</span>
                    <span class="confidence-badge ${e.confidence.toLowerCase()}">${e.confidence}</span>
                </div>
                <h3 class="card-match">${e.home} vs ${e.away}</h3>
                <p class="card-league">League: ${e.league}</p>
                <p class="card-recommendation">Bet: ${e.recommendation}</p>
                <div class="card-odds">
                    <span>Odds: ${parseFloat(e.odds).toFixed(2)}</span>
                    <span class="ev ${0<e.ev?"positive":"negative"}">
                        EV: ${0<=e.ev?"+":""}${(100*parseFloat(e.ev)).toFixed(1)}%
                    </span>
                </div>
                <div class="card-actions">
                    <button class="action-btn-sm" onclick="parlayKing.shareRec('${e.home} vs ${e.away}', '${e.recommendation}')">Share</button>
                    <button class="action-btn-sm expand-btn">Show Analysis</button>
                </div>
                <div class="kings-call hidden">${e.kingsCall||"No additional insights available."}</div>
            `,a.appendChild(t)}),a.querySelectorAll(".expand-btn").forEach(t=>{t.addEventListener("click",e=>{e=e.target.closest(".rec-card").querySelector(".kings-call").classList.toggle("hidden");t.textContent=e?"Show Analysis":"Hide Analysis"})}))}initViewToggle(){let e=document.querySelector('[data-view="table"]'),t=document.querySelector('[data-view="cards"]'),a=document.getElementById("table-view"),i=document.getElementById("cards-view");e&&t&&a&&i?(e.addEventListener("click",()=>{e.classList.add("active"),t.classList.remove("active"),a.classList.remove("hidden"),i.classList.add("hidden")}),t.addEventListener("click",()=>{t.classList.add("active"),e.classList.remove("active"),i.classList.remove("hidden"),a.classList.add("hidden")})):console.warn("View toggle elements not found")}initRecommendationsPage(){this.showLoading(!0),this.loadAllData().then(()=>{var e;this.renderRecommendationsTable(),this.renderRecommendationsCards(),this.initRecommendationsFilters(),this.initViewToggle(),window.innerWidth<=768&&(e=document.querySelector('[data-view="cards"]'))&&e.click();let a=document.getElementById("toggle-more-filters");a&&a.addEventListener("click",()=>{let t="true"===a.getAttribute("aria-expanded");document.querySelectorAll(".optional-filter").forEach(e=>e.style.display=t?"none":""),a.setAttribute("aria-expanded",String(!t)),a.textContent=t?"More filters":"Fewer filters"}),this.updateLastRunStatus(),this.showLoading(!1)}).catch(e=>{console.error("Failed to load recommendations data:",e),this.showError("Failed to load recommendations data"),this.showLoading(!1)}),this.selectedRecs=[],document.querySelectorAll(".rec-select").forEach(e=>{e.addEventListener("change",e=>{let t=e.target.dataset.id;e.target.checked?this.selectedRecs.push(this.data.recommendations.find(e=>e.id===t)):this.selectedRecs=this.selectedRecs.filter(e=>e.id!==t),this.updateParlayCalculator()})}),document.querySelectorAll(".share-btn").forEach(e=>{e.addEventListener("click",t=>{var e=this.data.recommendations.find(e=>e.id===t.target.dataset.id),e=`Check out this betting recommendation: ${e.home} vs ${e.away} - ${e.rec_text} @ `+e.odds;navigator.share({text:e})})});let t=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(this.renderCharts(),t.unobserve(e.target))})});document.querySelectorAll(".chart-container").forEach(e=>t.observe(e))}renderRecommendationsTable(){let a=document.getElementById("recommendations-tbody-full");a&&this.data.recommendations&&(a.innerHTML="",this.getFilteredRecommendations().sort((e,t)=>e.datetime.getTime()!==t.datetime.getTime()?e.datetime-t.datetime:parseFloat(t.ev)-parseFloat(e.ev)).forEach(e=>{var t=document.createElement("tr");t.innerHTML=`
                <td data-label="Time">${this.formatDateTime(e.datetime||e.dt_gmt8)}</td>
                <td data-label="Match"><strong>${e.home}</strong> vs <strong>${e.away}</strong></td>
                <td data-label="League">${e.league}</td>
                <td data-label="Recommendation">${e.recommendation||e.rec_text||"N/A"}</td>
                <td data-label="Odds">${parseFloat(e.odds).toFixed(2)}</td>
                <td data-label="EV" class="${0<e.ev?"positive":"negative"}">${0<=e.ev?"+":""}${(100*parseFloat(e.ev)).toFixed(1)}%</td>
                <td data-label="Confidence">
                    <span class="confidence-badge ${e.confidence.toLowerCase()}">${e.confidence}</span>
                </td>
                <td data-label="Actions">
                    <button class="action-btn-sm share-btn" onclick="parlayKing.shareRec('${e.home} vs ${e.away}', '${e.recommendation}')">Share</button>
                </td>
            `,a.appendChild(t)}))}initRecommendationsFilters(){let e=((t,a)=>{let i;return(...e)=>{clearTimeout(i),i=setTimeout(()=>t(...e),a)}})(()=>{this.renderRecommendationsTable(),this.renderRecommendationsCards()},300);document.getElementById("date-range-recs").addEventListener("change",e),document.getElementById("league-filter-recs").addEventListener("change",e),document.getElementById("min-ev-recs").addEventListener("input",e),document.getElementById("confidence-filter-recs").addEventListener("change",e),document.getElementById("reset-filters-recs").addEventListener("click",()=>{this.resetFilters(),e()});var t=localStorage.getItem("recDateRange"),t=(t&&(document.getElementById("date-range-recs").value=t),localStorage.getItem("recLeagueFilter")),t=(t&&(document.getElementById("league-filter-recs").value=t),localStorage.getItem("recMinEVFilter")),t=(t&&(document.getElementById("min-ev-recs").value=t),localStorage.getItem("recConfidenceFilter"));t&&(document.getElementById("confidence-filter-recs").value=t)}renderFilterSummary(){var e,t=document.getElementById("filter-summary");t&&((e=[]).push({7:"Next 7 days",30:"Last 30 days",90:"Last 90 days",all:"All time"}[this.filters.dateRange]||"Selected"),e.push("all"===this.filters.league?"All leagues":this.filters.league),e.push("EV ≥ "+(this.filters.minEV||0)),e.push("all"===this.filters.confidence?"All":this.filters.confidence),t.innerHTML=e.length?`<span>${e.join(" • ")}</span><button class="edit-btn" id="edit-filters">Edit</button>`:"",t=document.getElementById("edit-filters"))&&(t.onclick=()=>document.getElementById("date-range-recs")?.scrollIntoView({behavior:"smooth",block:"center"}))}shareRec(e,t){var a=window.location.origin+"/recommendations.html#"+encodeURIComponent(e);navigator.share?navigator.share({title:e,text:t,url:a}):(navigator.clipboard.writeText(a),alert("Link copied!"))}updateParlayCalculator(){var e=this.selectedRecs.reduce((e,t)=>e*parseFloat(t.odds),1),t=100*e;document.getElementById("parlay-odds").textContent=e.toFixed(2),document.getElementById("parlay-payout").textContent=t.toFixed(2)}groupGamesByDayLeagueTime(e){let i={},a=e=>{var t=new Date,a=new Date(t);return a.setDate(a.getDate()+1),this.isSameDay(e,t)?"Today":this.isSameDay(e,a)?"Tomorrow":this.formatDate(e)};return e.sort((e,t)=>e.datetime-t.datetime).forEach(e=>{var t=a(e.datetime);i[t]||(i[t]=[]),i[t].push(e)}),Object.keys(i).forEach(e=>{let n=i[e],a={};[...new Set(n.map(e=>e.league))].sort((t,a)=>{var e,i;return"England Premier League"===t?-1:"England Premier League"===a?1:(e=n.find(e=>e.league===t)?.tier||3)!==(i=n.find(e=>e.league===a)?.tier||3)?e-i:t.localeCompare(a)}).forEach(t=>{a[t]=n.filter(e=>e.league===t).sort((e,t)=>e.datetime-t.datetime)}),i[e]=a}),i}renderUnifiedSchedule(){let a=document.getElementById("unified-games-container");if(a){var e,t=a.closest(".unified-schedule-section");if(t&&!t.querySelector(".day-navigator")&&(e=this.dayNavigator.render(),t.insertAdjacentHTML("afterbegin",e)),this.data.unifiedGames)if(0===this.data.unifiedGames.length)this.renderFallbackRecommendations(a);else{let t=this.getFilteredGamesByDay();0===t.length?a.innerHTML='<div class="no-games">No games found for the selected day.</div>':this.scheduleRender(()=>{var e=this.groupGamesByLeague(t);a.innerHTML=this.renderLeagueGroups(e),this.initGameCardInteractions()})}else this.renderSkeletonCards(a)}else console.log("Unified games container not found - skipping schedule render")}getFilteredGamesByDay(){var e=[...this.data.unifiedGames||[]],e=this.filterByDay(e,this.uiState.currentDay);return(e=this.filterManager.applyFilters(e,"games")).sort((e,t)=>e.datetime-t.datetime)}filterByDay(e,t){let a=new Date,i=new Date(a),n=(i.setDate(i.getDate()+1),new Date(a));switch(n.setDate(n.getDate()+2),t){case"today":return e.filter(e=>this.isSameDay(e.datetime,a));case"tomorrow":return e.filter(e=>this.isSameDay(e.datetime,i));case"dayafter":return e.filter(e=>this.isSameDay(e.datetime,n));default:return e}}groupGamesByLeague(n){let e={};return[...new Set(n.map(e=>e.league))].sort((t,a)=>{var e,i;return"England Premier League"===t?-1:"England Premier League"===a?1:(e=n.find(e=>e.league===t)?.tier||3)!==(i=n.find(e=>e.league===a)?.tier||3)?e-i:t.localeCompare(a)}).forEach(t=>{e[t]=n.filter(e=>e.league===t).sort((e,t)=>e.datetime-t.datetime)}),e}renderLeagueGroups(e){return Object.entries(e).map(([e,t])=>this.renderTierGroup(e,t)).join("")}renderGameHints(e){var t=[];return e.hasRecommendation&&e.ev&&25<=100*e.ev&&t.push('<span class="game-hint game-hint--value" title="High value bet">💎</span>'),t.join("")}renderFallbackRecommendations(e){var t=this.getFilteredRecommendations().slice(0,10);0===t.length?e.innerHTML='<div class="no-games">No upcoming recommendations available.</div>':(e.innerHTML=`
            <div class="time-group">
                <div class="time-group-header">
                    <h4>Our Latest Recommendations</h4>
                    <span class="game-count">${t.length} picks</span>
                </div>
                <div class="games-list">
                    ${t.map((e,t)=>this.renderRecommendationAsGameCard(e,t)).join("")}
                </div>
            </div>
        `,this.initGameCardInteractions())}renderRecommendationAsGameCard(e,t){return`
            <div class="game-card" data-signal="kings-call" data-expandable="true">
                <div class="game-row">
                    <div class="game-time">${this.formatGameTime(e.datetime)}</div>
                    <div class="signal-container">
                        <span class="signal-icon kings-call" title="King's Call Available">👑</span>
                    </div>
                    <div class="game-teams">
                        <span class="league-flag">⚽</span>
                        <div class="teams-text">
                            <span class="home">${e.home}</span>
                            <span class="vs">vs</span>
                            <span class="away">${e.away}</span>
                        </div>
                    </div>
                    <div class="game-league mobile-hidden">${e.league}</div>
                    <div class="game-odds mobile-hidden">${e.odds.toFixed(2)}</div>
                    <div class="expand-btn">▼</div>
                </div>
                
                <div class="expanded-details hidden">
                    <div class="expanded-row recommendation-row">
                        <strong>Our Pick:</strong> ${e.recommendation}
                        <span class="ev-badge">EV: ${(100*e.ev).toFixed(1)}%</span>
                    </div>
                    ${e.kingsCall?`
                        <div class="expanded-row kings-call-row">
                            <strong>Analysis:</strong> 
                            <span class="kings-call-text">${e.kingsCall}</span>
                        </div>
                    `:""}
                    <div class="expanded-row stats-row">
                        <span>Confidence: ${e.confidence}</span>
                        <span>League: ${e.league}</span>
                    </div>
                </div>
            </div>
        `}groupGamesByImportance(e){let t={"Premier Matches":[],"Top Leagues":[],"Other Leagues":[]};return e.forEach(e=>{(e.hasRecommendation&&1===e.tier?t["Premier Matches"]:1===e.tier?t["Top Leagues"]:t["Other Leagues"]).push(e)}),Object.keys(t).forEach(e=>{0===t[e].length&&delete t[e]}),t}renderTierGroup(e,t){return`
            <div class="tier-group">
                <div class="tier-group-header">
                    <h4>${e}</h4>
                    <span class="game-count">${t.length} games</span>
                </div>
                <div class="games-list">
                    ${t.map((e,t)=>this.renderGameCard(e,t)).join("")}
                </div>
            </div>
        `}renderGameCard(e,t){return this.renderMobileGameCardV2(e,t)}renderMobileGameCardV2(e,t){var a=e.hasRecommendation||e.kingsCall,i=this.formatGameTime(e.datetime),{homeChip:n,awayChip:s}=this.renderAhChips(e),r=this.renderGameHints(e);return`
            <div class="game-card game-card--v2" 
                 data-game-index="${t}"
                 data-signal="${e.primarySignal}"
                 data-expandable="${a}"
                 data-is-future="${e.isFuture}">
                
                <div class="game-row game-row--v2">
                    <div class="game-meta">
                        <div class="game-time">${i}</div>
                    </div>
                    
                    <div class="game-matchup">
                        <div class="team-row">
                            <span class="team-name home">${e.home}</span>
                            ${n}
                        </div>
                        <div class="vs-separator">vs</div>
                        <div class="team-row">
                            <span class="team-name away">${e.away}</span>
                            ${s}
                        </div>
                    </div>
                    
                    <div class="game-actions">
                        <div class="game-hints">${r}</div>
                        <div class="expand-btn" ${a?'role="button" tabindex="0" aria-label="Expand game details"':""}>${a?"▼":""}</div>
                    </div>
                </div>
                
                ${a?this.renderExpandedContent(e):""}
            </div>
        `}renderAhChips(e){var t,a,i,n,s,r,d;return e.hasAhData?(t=e=>0===e?"PK":0<e?"+"+e:(""+e).replace("-","−"),a=e.hasRecommendation&&e.recommendedTeam===e.home,i=e.hasRecommendation&&e.recommendedTeam===e.away,n=["ah-chip",e.homeLine<0?"ah-chip--neg":0<e.homeLine?"ah-chip--pos":"ah-chip--pk",a?"ah-chip--selected":""].filter(Boolean).join(" "),s=["ah-chip",e.awayLine<0?"ah-chip--neg":0<e.awayLine?"ah-chip--pos":"ah-chip--pk",i?"ah-chip--selected":""].filter(Boolean).join(" "),r=`Home ${t(e.homeLine)} Asian handicap`+(a?", recommended":""),d=`Away ${t(e.awayLine)} Asian handicap`+(i?", recommended":""),{homeChip:`
            <div class="ah-chip-container">
                <span class="${n}" aria-label="${r}">
                    ${t(e.homeLine)}
                    ${a?'<span class="signal-crown" title="Has pick" aria-label="Has pick">👑</span>':""}
                </span>
            </div>
        `,awayChip:`
            <div class="ah-chip-container">
                <span class="${s}" aria-label="${d}">
                    ${t(e.awayLine)}
                    ${i?'<span class="signal-crown" title="Has pick" aria-label="Has pick">👑</span>':""}
                </span>
            </div>
        `}):{homeChip:'<span class="ah-chip ah-chip--empty" aria-label="No Asian handicap data">AH —</span>',awayChip:'<span class="ah-chip ah-chip--empty" aria-label="No Asian handicap data">AH —</span>'}}renderEvPill(e){if(!e.hasRecommendation||!e.ev)return"";var e=(100*e.ev).toFixed(1),t=parseFloat(e);let a="ev-pill";return`<span class="${a+=25<=t?" ev-pill--strong":10<=t?" ev-pill--medium":" ev-pill--neutral"}" title="Expected Value: ${e}%" aria-label="Expected value ${e} percent">EV ${e}%</span>`}getSignalIcon(e){return{"kings-call":"👑","high-ev":"📈","hot-pick":"🔥","value-bet":"💎"}[e]||""}getSignalTitle(e){return{"kings-call":"Analysis Available","high-ev":"High Expected Value","hot-pick":"Hot Pick - High Confidence","value-bet":"Value Bet Opportunity"}[e]||""}formatGameTime(e){return e?e.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",hour12:!1}):"--:--"}formatOddsCompact(e){return e.hasRecommendation&&e.line&&e.recOdds?`AH ${0<=e.line?"+"+e.line.toFixed(2):e.line.toFixed(2)} @ `+e.recOdds.toFixed(2):e.odds1&&e.oddsX&&e.odds2?`${e.odds1.toFixed(2)} ${e.oddsX.toFixed(2)} `+e.odds2.toFixed(2):"TBD"}renderExpandedContent(e){var t="High"===e.confidence?"👑":"Medium"===e.confidence?"⭐":"⚪";return`
            <div class="expanded-details hidden expanded-large">
                <div class="expanded-row recommendation-row">
                    <strong>Our Pick:</strong> ${e.recText} @ ${e.recOdds.toFixed(2)}
                    <span class="ev-badge">EV: ${(100*e.ev).toFixed(1)}%</span>
                </div>
                
                <div class="expanded-row stats-row">
                    <span class="stat-pill">Confidence: ${t}</span>
                    <span class="stat-pill">Tier: ${e.tier}</span>
                    <span class="odds-display">1X2: ${this.format1X2Odds(e)}</span>
                </div>
                
                ${e.kingsCall?`
                    <button class="analysis-toggle" aria-expanded="false">Show Analysis ▼</button>
                    <div class="kings-call-row hidden">
                        <span class="kings-call-text">${e.kingsCall}</span>
                    </div>
                `:""}
                
                <div class="expanded-actions">
                    <button class="action-btn-compact secondary" onclick="parlayKing.shareGame(${e.datetime.getTime()})">📤 Share</button>
                    <button class="action-btn-compact primary" onclick="parlayKing.exportGame(${e.datetime.getTime()})">📊 Export</button>
                </div>
            </div>
        `}format1X2Odds(e){return e.odds1&&e.oddsX&&e.odds2?`${e.odds1.toFixed(2)} ${e.oddsX.toFixed(2)} `+e.odds2.toFixed(2):"TBD"}initGameCardInteractions(){setTimeout(()=>{document.querySelectorAll(".game-card").forEach(t=>{"true"===t.dataset.expandable&&(t.addEventListener("click",e=>{e.target.closest(".expanded-actions")||e.target.closest(".action-btn")||e.target.closest(".ah-chip")||e.target.closest(".ev-pill")||e.target.closest(".game-hint")||this.toggleGameExpansion(t)}),t.style.cursor="pointer")})},100)}toggleGameExpansion(e){var t=e.querySelector(".expanded-details"),a=e.querySelector(".expand-btn");t&&a&&(!t.classList.contains("hidden")?(t.classList.add("hidden"),a.textContent="▼",e.classList.remove("expanded"),e.setAttribute("data-expanded","false"),a.setAttribute("aria-expanded","false")):(t.classList.remove("hidden"),a.textContent="▲",e.classList.add("expanded"),e.setAttribute("data-expanded","true"),a.setAttribute("aria-expanded","true"),this.trackEvent("card_expanded",{signal:e.dataset.signal,league:e.querySelector(".league-short")?.textContent||e.querySelector(".game-league")?.textContent,tier:e.dataset.tier,has_pick:""!==e.dataset.signal,ev_band:this.getEvBand(e)})))}getEvBand(e){e=e.querySelector(".ev-pill");return e?e.classList.contains("ev-pill--strong")?"high":e.classList.contains("ev-pill--medium")?"medium":"low":"none"}shareGame(t){var e=this.data.unifiedGames.find(e=>e.datetime.getTime()===t);e&&(e=e.hasRecommendation?`🎯 ${e.recText} @ ${e.recOdds.toFixed(2)} odds (EV: ${(100*e.ev).toFixed(1)}%) - ${e.home} vs `+e.away:`⚽ ${e.home} vs ${e.away} - `+this.formatDateTime(e.datetime),navigator.share?navigator.share({title:"ParlayKing Betting Pick",text:e,url:window.location.href}):navigator.clipboard.writeText(e).then(()=>{alert("Shared text copied to clipboard!")}))}exportGame(t){var e,a=this.data.unifiedGames.find(e=>e.datetime.getTime()===t);a&&a.hasRecommendation&&(e=[["Date/Time","League","Match","Recommendation","Odds","EV (%)","Confidence","Analysis"],[this.formatDateTime(a.datetime),a.league,a.home+" vs "+a.away,a.recText,a.recOdds.toFixed(2),(100*a.ev).toFixed(1)+"%",a.confidence,a.kingsCall]].map(e=>e.join(",")).join("\n"),this.downloadCSV(e,`pick_${a.home.replace(/\s+/g,"")}_vs_${a.away.replace(/\s+/g,"")}.csv`))}formatNumber(e){return(new Intl.NumberFormat).format(e)}formatCurrency(e,t=!1){t=t&&0<=e?"+":"";return 1e3<=Math.abs(e)?t+(e/1e3).toFixed(1)+"k":t+e.toFixed(2)}formatDate(e){e=e instanceof Date?e:this.parseDateTimeSafe(e);return e?new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",timeZone:"Asia/Singapore"}).format(e):"--"}formatDateTime(e){e=e instanceof Date?e:this.parseDateTimeSafe(e);return e?new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"Asia/Singapore"}).format(e):"--"}formatTimeAgo(e){var t;return e?(e=new Date(e),t=new Date,(t=Math.floor((t-e)/36e5))<1?"Just now":t<24?t+"h ago":Math.floor(t/24)+"d ago"):"--"}showLoading(e){var t=document.getElementById("loading-overlay");e?t.classList.remove("hidden"):t.classList.add("hidden")}showError(e){console.error(e)}initAnalyticsPage(){this.showLoading(!0),this.loadAllData().then(()=>{var e=document.getElementById("tier-select"),e=(e&&e.addEventListener("change",()=>this.renderROIHeatmap()),document.querySelectorAll(".range-btn[data-min-bets]").forEach(e=>{e.addEventListener("click",e=>{document.querySelectorAll(".range-btn[data-min-bets]").forEach(e=>e.classList.remove("active")),e.currentTarget.classList.add("active"),this.renderROIHeatmap()})}),document.getElementById("segments-tier-select"));e&&e.addEventListener("change",()=>this.renderTopSegments()),document.querySelectorAll(".toggle-btn[data-view]").forEach(e=>{e.addEventListener("click",e=>{var t=e.currentTarget.parentElement;t&&(t.querySelectorAll(".toggle-btn").forEach(e=>e.classList.remove("active")),e.currentTarget.classList.add("active"),this.renderPnLChart())})}),this.renderROIHeatmap(),this.renderPnLChart(),this.renderTopSegments(),this.updateLastRunStatus(),this.showLoading(!1)}).catch(e=>{console.error("Failed to load analytics data:",e),this.showError("Failed to load analytics data"),this.showLoading(!1)})}renderROIHeatmap(){var e=document.getElementById("roi-heatmap");if(e){let t=parseInt(document.querySelector(".range-btn.active[data-min-bets]")?.dataset.minBets||"30",10),r=parseInt(document.getElementById("tier-select")?.value||"1",10);let d=(Array.isArray(this.data.roiHeatmap)&&0<this.data.roiHeatmap.length?this.data.roiHeatmap.map(e=>({tier:+e.tier,line:+e.line,roi_pct:+e.roi_pct,n:+e.n})):this.getBacktestROIHeatmapFallback()).filter(e=>e.tier===r&&e.n>=t);var a=[...new Set(d.map(e=>e.line))].sort((e,t)=>e-t);if(0===a.length)e.innerHTML='<div class="chart-placeholder">No segments meet the selected filters</div>';else if(a.length<4){let s='<div class="segments-pills">';a.forEach(t=>{var e=d.find(e=>e.line===t)||{roi_pct:0,n:0},a=e.roi_pct,i=this.classForRoi(a),n=this.createSparklineFromRoi(a,`hm-${r}-`+t);s+=`
                    <div class="segment-pill">
                        <div class="pill-top">
                            <span class="roi-pill ${i}">${a.toFixed(1)}%</span>
                            <span class="line-text">${0<=t?"+":""}${t.toFixed(2)}</span>
                        </div>
                        <div class="pill-bottom">${n}<span class="bets-text">${this.formatNumber(e.n)} bets</span></div>
                    </div>`}),s+="</div>",void(e.innerHTML=s)}else{let n=`<div class="heatmap-grid" style="grid-template-columns: repeat(${Math.max(a.length,1)}, 1fr);">`;a.forEach(t=>{var e=d.find(e=>e.line===t)||{roi_pct:0,n:0},a=e.roi_pct,i=10<=a?"heat-pos":3<=a?"heat-mid":"heat-neg";n+=`
                <div class="heatmap-cell ${i}">
                    <div class="heatmap-value">${a.toFixed(1)}%</div>
                    <div class="heatmap-meta">${0<=t?"+":""}${t.toFixed(2)} · ${this.formatNumber(e.n)} bets</div>
                </div>`}),n+="</div>",e.innerHTML=n}}}getBacktestROIHeatmapFallback(){return[{tier:1,line:-.5,roi:28.4,bets:67},{tier:1,line:-.25,roi:25.1,bets:54},{tier:1,line:0,roi:22.7,bets:89},{tier:1,line:.25,roi:19.8,bets:43},{tier:1,line:.5,roi:24.3,bets:31},{tier:2,line:-.5,roi:21.6,bets:39},{tier:2,line:-.25,roi:18.9,bets:45},{tier:2,line:0,roi:20.4,bets:67},{tier:2,line:.25,roi:17.2,bets:38},{tier:3,line:0,roi:15.8,bets:20}].map(e=>({tier:e.tier,line:e.line,roi_pct:e.roi,n:e.bets}))}renderPnLChart(){var c=document.getElementById("pnl-chart");if(c){let e=Array.isArray(this.data.pnlByMonth)&&0<this.data.pnlByMonth.length?this.data.pnlByMonth:[{month:"2024-03",league:"England Premier League",pnl:1247.32},{month:"2024-03",league:"Spain La Liga",pnl:891.45},{month:"2024-04",league:"England Premier League",pnl:1534.67},{month:"2024-04",league:"Germany Bundesliga",pnl:1123.89},{month:"2024-04",league:"Italy Serie A",pnl:678.23},{month:"2024-05",league:"England Premier League",pnl:1789.34},{month:"2024-05",league:"Spain La Liga",pnl:1345.78},{month:"2024-05",league:"France Ligue 1",pnl:867.89}];var u=[...new Set(e.map(e=>String(e.month)))].sort();let i=[...new Set(e.map(e=>String(e.league)))].map(t=>({league:t,total:e.filter(e=>e.league===t).reduce((e,t)=>e+(parseFloat(t.pnl)||0),0)})).sort((e,t)=>Math.abs(t.total)-Math.abs(e.total)).slice(0,6).map(e=>e.league);var v=u.map(t=>{let a={};return i.forEach(e=>a[e]=0),e.filter(e=>String(e.month)===t&&i.includes(String(e.league))).forEach(e=>{a[String(e.league)]+=parseFloat(e.pnl)||0}),{month:t,byLeague:a}});let n=0,s=0,a=(v.forEach(e=>{let t=0,a=0;Object.values(e.byLeague).forEach(e=>{0<=e?t+=e:a+=e}),s=Math.max(s,t),n=Math.min(n,a)}),0===s&&0===n&&(s=1),c.innerHTML="",document.createElementNS("http://www.w3.org/2000/svg","svg")),r=(a.setAttribute("class","chart-svg"),a.setAttribute("viewBox","0 0 800 400"),a.setAttribute("preserveAspectRatio","xMidYMid meet"),{top:20,right:24,bottom:48,left:64});var f=800-r.left-r.right;let d=400-r.top-r.bottom,m=f/Math.max(u.length,1),h=e=>r.top+d-(e-n)/(s-n)*d;var y=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e=0;e<=5;e++){var w=r.top+e/5*d,b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("x1",r.left),b.setAttribute("y1",w),b.setAttribute("x2",r.left+f),b.setAttribute("y2",w),b.setAttribute("class","chart-grid-line"),y.appendChild(b)}a.appendChild(y);let t=["#FF7A45","#3A7BD5","#2ECC71","#F39C12","#9B59B6","#00C2A8"],p=e=>t[i.indexOf(e)%t.length],l=document.querySelector(".toggle-btn.active[data-view]")?.dataset.view||"stacked",g=document.createElementNS("http://www.w3.org/2000/svg","g");v.forEach((o,e)=>{let c=r.left+e*m;if("separated"===l){let s=Math.max(6,(m-16)/Math.max(i.length,1));i.forEach((e,t)=>{var a=o.byLeague[e]||0,t=c+8+t*s,i=Math.min(h(0),h(a)),a=Math.abs(h(a)-h(0)),n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",t.toFixed(1)),n.setAttribute("y",i.toFixed(1)),n.setAttribute("width",Math.max(4,s-2).toFixed(1)),n.setAttribute("height",Math.max(0,a).toFixed(1)),n.setAttribute("fill",p(e)),n.setAttribute("rx","3"),g.appendChild(n)})}else{let r=Math.max(10,m-16),d=0,l=0;i.forEach(e=>{var t,a,i,n,s=o.byLeague[e]||0;0!==s&&(t=(a=0<=s?d:l)+s,a=h(a),i=h(t),(n=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("x",(c+(m-r)/2).toFixed(1)),n.setAttribute("y",Math.min(a,i).toFixed(1)),n.setAttribute("width",r.toFixed(1)),n.setAttribute("height",Math.abs(i-a).toFixed(1)),n.setAttribute("fill",p(e)),n.setAttribute("rx","4"),g.appendChild(n),0<=s?d=t:l=t)})}var e=document.createElementNS("http://www.w3.org/2000/svg","text"),t=(e.setAttribute("x",(c+m/2).toFixed(1)),e.setAttribute("y",(r.top+d+24).toFixed(1)),e.setAttribute("text-anchor","middle"),e.setAttribute("class","chart-axis-text"),new Date(o.month+"-01"));e.textContent=t.toLocaleString("en-US",{month:"short"}),a.appendChild(e)}),a.appendChild(g);var x=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e=0;e<=5;e++){var E=n+(s-n)*(e/5),L=r.top+d-e/5*d+4,$=document.createElementNS("http://www.w3.org/2000/svg","text");$.setAttribute("x",r.left-10),$.setAttribute("y",L),$.setAttribute("text-anchor","end"),$.setAttribute("class","chart-axis-text"),$.textContent=this.formatCurrency(E,!0),x.appendChild($)}a.appendChild(x),c.appendChild(a);let o=document.createElement("div");o.className="chart-legend",i.forEach(e=>{var t=document.createElement("div");t.className="legend-item",t.innerHTML=`<span class="legend-swatch" style="background:${p(e)}"></span><span class="legend-label">${e}</span>`,o.appendChild(t)}),c.appendChild(o)}}createBacktestPnLChart(e){var t=[{month:"2024-03",pnl:1247.32,league:"England Premier League"},{month:"2024-03",pnl:891.45,league:"Spain La Liga"},{month:"2024-04",pnl:1534.67,league:"England Premier League"},{month:"2024-04",pnl:1123.89,league:"Germany Bundesliga"},{month:"2024-04",pnl:678.23,league:"Italy Serie A"},{month:"2024-05",pnl:1789.34,league:"England Premier League"},{month:"2024-05",pnl:1345.78,league:"Spain La Liga"},{month:"2024-05",pnl:867.89,league:"France Ligue 1"}],a=t.reduce((e,t)=>(e[t.month]||(e[t.month]=0),e[t.month]+=t.pnl,e),{}),a=Object.entries(a).map(([e,t])=>({date:new Date(e+"-01"),value:t})).sort((e,t)=>e.date-t.date);let i=0,n=a.map(e=>(i+=e.value,{date:e.date,value:i}));e.innerHTML='<div id="backtest-pnl-chart" class="custom-chart" style="height: 300px;"></div>',setTimeout(()=>{this.createCustomChart("backtest-pnl-chart",n,{formatY:e=>this.formatCurrency(e,!0)})},100),e.innerHTML+=`
            <div style="padding: 16px; text-align: center; color: var(--muted); font-size: 0.9em;">
                📈 Cumulative P&L from Backtest Period (${t.length} leagues, 493 total bets)
            </div>
        `}seededRandom(t){let a=2166136261;for(let e=0;e<t.length;e++)a^=t.charCodeAt(e),a=Math.imul(a,16777619);return()=>{a+=1831565813;var e=Math.imul(a^a>>>15,1|a);return(((e^=e+Math.imul(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296}}createSparklineFromRoi(n,e){let s=this.seededRandom(String(e));e=Array.from({length:8},(e,t)=>{var a=.45+n/100*.3,i=.2*(s()-.5);return Math.max(.1,Math.min(.9,a+i))});let a=76/(e.length-1);var t=e.map((e,t)=>[2+t*a,22-20*e]);let i=`M ${t[0][0]} `+t[0][1];for(let e=1;e<t.length;e++)i+=` L ${t[e][0]} `+t[e][1];return`<svg class="spark-svg" width="80" height="24" viewBox="0 0 80 24" preserveAspectRatio="none" aria-hidden="true">
      <path d="${""+i+` L ${t[t.length-1][0]} 22 L ${t[0][0]} 22 Z`}" class="spark-area"></path>
      <path d="${i}" class="spark-line"></path>
    </svg>`}classForRoi(e){return 10<=e?"excellent":3<=e?"good":"moderate"}renderTopSegments(){let r=document.getElementById("segments-tbody");if(r){r.innerHTML="";let t=parseInt(document.getElementById("segments-tier-select")?.value||"1",10);this.data.topSegments&&0!==this.data.topSegments.length?this.data.topSegments.filter(e=>parseInt(e.tier)===t).sort((e,t)=>parseFloat(t.roi_pct)-parseFloat(e.roi_pct)).forEach(e=>{var t=document.createElement("tr"),a=parseFloat(e.roi_pct),i=parseFloat(e.line),n=this.classForRoi(a),s=this.createSparklineFromRoi(a,e.tier+"-"+i);t.innerHTML=`
                    <td>Tier ${e.tier}</td>
                    <td>${0<i?"+":""}${i.toFixed(2)}</td>
                    <td class="roi-cell"><span class="roi-pill ${n}">${a.toFixed(1)}%</span></td>
                    <td>${this.formatNumber(e.n)}</td>
                    <td>
                        <div class="row-performance">
                            ${s}
                            <span class="performance-badge ${10<a?"excellent":5<a?"good":"moderate"}">
                                ${10<a?"Excellent":5<a?"Good":"Moderate"}
                            </span>
                        </div>
                    </td>`,r.appendChild(t)}):this.renderBacktestTopSegments(r,t)}}renderBacktestTopSegments(r,t=1){[{tier:1,line:-.5,roi_pct:28.4,n:67},{tier:1,line:.5,roi_pct:24.3,n:31},{tier:1,line:-.25,roi_pct:25.1,n:54},{tier:1,line:0,roi_pct:22.7,n:89},{tier:2,line:-.5,roi_pct:21.6,n:39},{tier:2,line:0,roi_pct:20.4,n:67},{tier:1,line:.25,roi_pct:19.8,n:43},{tier:2,line:-.25,roi_pct:18.9,n:45},{tier:2,line:.25,roi_pct:17.2,n:38},{tier:3,line:0,roi_pct:15.8,n:20}].filter(e=>e.tier===t).sort((e,t)=>t.roi_pct-e.roi_pct).forEach(e=>{var t=document.createElement("tr"),a=parseFloat(e.roi_pct),i=parseFloat(e.line),n=this.classForRoi(a),s=this.createSparklineFromRoi(a,`bt-${e.tier}-`+i);t.innerHTML=`
                    <td>Tier ${e.tier}</td>
                    <td>${0<i?"+":""}${i.toFixed(2)}</td>
                    <td class="roi-cell"><span class="roi-pill ${n}">${a.toFixed(1)}%</span></td>
                    <td>${this.formatNumber(e.n)}</td>
                    <td>
                        <div class="row-performance">
                            ${s}
                            <span class="performance-badge ${20<a?"excellent":15<a?"good":"moderate"}">
                                ${20<a?"Excellent":15<a?"Good":"Moderate"}
                            </span>
                        </div>
                    </td>`,r.appendChild(t)})}renderRecommendationsCards(){let a=document.getElementById("recommendations-cards");a&&this.data.recommendations&&(a.innerHTML="",this.getFilteredRecommendations().sort((e,t)=>e.datetime.getTime()!==t.datetime.getTime()?e.datetime-t.datetime:parseFloat(t.ev)-parseFloat(e.ev)).forEach(e=>{var t=document.createElement("div");t.className="rec-card",t.innerHTML=`
                <div class="card-header">
                    <span class="card-date">${this.formatDateTime(e.datetime)}</span>
                    <span class="confidence-badge ${e.confidence.toLowerCase()}">${e.confidence}</span>
                </div>
                <h3 class="card-match">${e.home} vs ${e.away}</h3>
                <p class="card-league">League: ${e.league}</p>
                <p class="card-recommendation">Bet: ${e.recommendation}</p>
                <div class="card-odds">
                    <span>Odds: ${parseFloat(e.odds).toFixed(2)}</span>
                    <span class="ev ${0<e.ev?"positive":"negative"}">
                        EV: ${0<=e.ev?"+":""}${(100*parseFloat(e.ev)).toFixed(1)}%
                    </span>
                </div>
                <div class="card-actions">
                    <button class="action-btn-sm" onclick="parlayKing.shareRec('${e.home} vs ${e.away}', '${e.recommendation}')">Share</button>
                    <button class="action-btn-sm expand-btn">Show Analysis</button>
                </div>
                <div class="kings-call hidden">${e.kingsCall||"No additional insights available."}</div>
            `,a.appendChild(t)}),a.querySelectorAll(".expand-btn").forEach(t=>{t.addEventListener("click",e=>{e=e.target.closest(".rec-card").querySelector(".kings-call").classList.toggle("hidden");t.textContent=e?"Show Analysis":"Hide Analysis"})}))}initViewToggle(){let e=document.querySelector('[data-view="table"]'),t=document.querySelector('[data-view="cards"]'),a=document.getElementById("table-view"),i=document.getElementById("cards-view");e&&t&&a&&i?(e.addEventListener("click",()=>{e.classList.add("active"),t.classList.remove("active"),a.classList.remove("hidden"),i.classList.add("hidden")}),t.addEventListener("click",()=>{t.classList.add("active"),e.classList.remove("active"),i.classList.remove("hidden"),a.classList.add("hidden")})):console.warn("View toggle elements not found")}initRecommendationsPage(){this.showLoading(!0),this.loadAllData().then(()=>{var e;this.renderRecommendationsTable(),this.renderRecommendationsCards(),this.initRecommendationsFilters(),this.initViewToggle(),window.innerWidth<=768&&(e=document.querySelector('[data-view="cards"]'))&&e.click();let a=document.getElementById("toggle-more-filters");a&&a.addEventListener("click",()=>{let t="true"===a.getAttribute("aria-expanded");document.querySelectorAll(".optional-filter").forEach(e=>e.style.display=t?"none":""),a.setAttribute("aria-expanded",String(!t)),a.textContent=t?"More filters":"Fewer filters"}),this.updateLastRunStatus(),this.showLoading(!1)}).catch(e=>{console.error("Failed to load recommendations data:",e),this.showError("Failed to load recommendations data"),this.showLoading(!1)}),this.selectedRecs=[],document.querySelectorAll(".rec-select").forEach(e=>{e.addEventListener("change",e=>{let t=e.target.dataset.id;e.target.checked?this.selectedRecs.push(this.data.recommendations.find(e=>e.id===t)):this.selectedRecs=this.selectedRecs.filter(e=>e.id!==t),this.updateParlayCalculator()})}),document.querySelectorAll(".share-btn").forEach(e=>{e.addEventListener("click",t=>{var e=this.data.recommendations.find(e=>e.id===t.target.dataset.id),e=`Check out this betting recommendation: ${e.home} vs ${e.away} - ${e.rec_text} @ `+e.odds;navigator.share({text:e})})});let t=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(this.renderCharts(),t.unobserve(e.target))})});document.querySelectorAll(".chart-container").forEach(e=>t.observe(e))}renderRecommendationsTable(){let a=document.getElementById("recommendations-tbody-full");a&&this.data.recommendations&&(a.innerHTML="",this.getFilteredRecommendations().sort((e,t)=>e.datetime.getTime()!==t.datetime.getTime()?e.datetime-t.datetime:parseFloat(t.ev)-parseFloat(e.ev)).forEach(e=>{var t=document.createElement("tr");t.innerHTML=`
                <td data-label="Time">${this.formatDateTime(e.datetime||e.dt_gmt8)}</td>
                <td data-label="Match"><strong>${e.home}</strong> vs <strong>${e.away}</strong></td>
                <td data-label="League">${e.league}</td>
                <td data-label="Recommendation">${e.recommendation||e.rec_text||"N/A"}</td>
                <td data-label="Odds">${parseFloat(e.odds).toFixed(2)}</td>
                <td data-label="EV" class="${0<e.ev?"positive":"negative"}">${0<=e.ev?"+":""}${(100*parseFloat(e.ev)).toFixed(1)}%</td>
                <td data-label="Confidence">
                    <span class="confidence-badge ${e.confidence.toLowerCase()}">${e.confidence}</span>
                </td>
                <td data-label="Actions">
                    <button class="action-btn-sm share-btn" onclick="parlayKing.shareRec('${e.home} vs ${e.away}', '${e.recommendation}')">Share</button>
                </td>
            `,a.appendChild(t)}))}initRecommendationsFilters(){let e=((t,a)=>{let i;return(...e)=>{clearTimeout(i),i=setTimeout(()=>t(...e),a)}})(()=>{this.renderRecommendationsTable(),this.renderRecommendationsCards()},300);document.getElementById("date-range-recs").addEventListener("change",e),document.getElementById("league-filter-recs").addEventListener("change",e),document.getElementById("min-ev-recs").addEventListener("input",e),document.getElementById("confidence-filter-recs").addEventListener("change",e),document.getElementById("reset-filters-recs").addEventListener("click",()=>{this.resetFilters(),e()});var t=localStorage.getItem("recDateRange"),t=(t&&(document.getElementById("date-range-recs").value=t),localStorage.getItem("recLeagueFilter")),t=(t&&(document.getElementById("league-filter-recs").value=t),localStorage.getItem("recMinEVFilter")),t=(t&&(document.getElementById("min-ev-recs").value=t),localStorage.getItem("recConfidenceFilter"));t&&(document.getElementById("confidence-filter-recs").value=t)}renderFilterSummary(){var e,t=document.getElementById("filter-summary");t&&((e=[]).push({7:"Next 7 days",30:"Last 30 days",90:"Last 90 days",all:"All time"}[this.filters.dateRange]||"Selected"),e.push("all"===this.filters.league?"All leagues":this.filters.league),e.push("EV ≥ "+(this.filters.minEV||0)),e.push("all"===this.filters.confidence?"All":this.filters.confidence),t.innerHTML=e.length?`<span>${e.join(" • ")}</span><button class="edit-btn" id="edit-filters">Edit</button>`:"",t=document.getElementById("edit-filters"))&&(t.onclick=()=>document.getElementById("date-range-recs")?.scrollIntoView({behavior:"smooth",block:"center"}))}shareRec(e,t){var a=window.location.origin+"/recommendations.html#"+encodeURIComponent(e);navigator.share?navigator.share({title:e,text:t,url:a}):(navigator.clipboard.writeText(a),alert("Link copied!"))}updateParlayCalculator(){var e=this.selectedRecs.reduce((e,t)=>e*parseFloat(t.odds),1),t=100*e;document.getElementById("parlay-odds").textContent=e.toFixed(2),document.getElementById("parlay-payout").textContent=t.toFixed(2)}scheduleRender(e){this.renderQueue.push(e),this.isRendering||(this.isRendering=!0,requestAnimationFrame(()=>this.processRenderQueue()))}processRenderQueue(){for(var e=performance.now();0<this.renderQueue.length&&performance.now()-e<16;)this.renderQueue.shift()();0<this.renderQueue.length?requestAnimationFrame(()=>this.processRenderQueue()):this.isRendering=!1}switchDay(t){this.uiState.currentDay=t,document.querySelectorAll(".day-tab").forEach(e=>{e.classList.toggle("active",e.dataset.day===t)});let e=document.getElementById("unified-games-container");e&&(e.style.opacity="0.5",e.style.transform="translateY(10px)",setTimeout(()=>{this.renderUnifiedSchedule(),e.style.opacity="1",e.style.transform="translateY(0)"},150))}toggleAnalysis(e){var t=e.nextElementSibling,a="true"===e.getAttribute("aria-expanded");t.classList.toggle("hidden",a),e.setAttribute("aria-expanded",!a),e.innerHTML=a?"Show Analysis ▼":"Hide Analysis ▲"}toggleGameExpansion(e){var t=e.dataset.gameId;let a=e.querySelector(".expanded-details");var i=e.querySelector(".expand-btn");a&&i&&(this.uiState.expandedCards.has(t)?(this.uiState.expandedCards.delete(t),a.style.maxHeight="0",i.textContent="▼",e.setAttribute("data-expanded","false"),i.setAttribute("aria-expanded","false"),setTimeout(()=>{a.classList.add("hidden"),a.style.maxHeight=""},200)):(this.uiState.expandedCards.add(t),a.classList.remove("hidden"),i.textContent="▲",e.setAttribute("data-expanded","true"),i.setAttribute("aria-expanded","true"),a.style.maxHeight="0",a.style.overflow="hidden",requestAnimationFrame(()=>{a.style.maxHeight=a.scrollHeight+"px",a.style.overflow="visible"})))}}class FilterManager{constructor(e){this.filters=e}applyFilters(e,t=0){return e.filter(e=>this.matchesDateRange(e,this.filters.dateRange)).filter(e=>this.matchesLeague(e,this.filters.league)).filter(e=>this.matchesMinEV(e,this.filters.minEV)).filter(e=>this.matchesConfidence(e,this.filters.confidence))}matchesDateRange(e,t){var a;return"all"===t||(a=new Date,e=e.datetime||new Date,t=parseInt(t),Math.abs((e-a)/864e5)<=t)}matchesLeague(e,t){return"all"===t||e.league===t}matchesMinEV(e,t){return!e.hasRecommendation||!e.ev||t<=100*e.ev}matchesConfidence(e,t){return"all"===t||e.confidence===t}}class AnalyticsManager{constructor(e){this.data=e}renderROIHeatmap(e,t={}){if(!e)return;let{minBets:a=30,tier:i=1}=t;var t=(this.data.roiHeatmap||[]).filter(e=>e.tier===i&&e.n>=a);0===t.length?e.innerHTML='<div class="chart-placeholder">No data available</div>':(t=this.buildHeatmapHTML(t),e.innerHTML=t)}buildHeatmapHTML(n){var e=[...new Set(n.map(e=>e.line))].sort((e,t)=>e-t);let s=`<div class="heatmap-grid" style="grid-template-columns: repeat(${Math.max(e.length,1)}, 1fr);">`;return e.forEach(t=>{var e=n.find(e=>e.line===t)||{roi_pct:0,n:0},a=e.roi_pct,i=10<=a?"heat-pos":3<=a?"heat-mid":"heat-neg";s+=`
                <div class="heatmap-cell ${i}">
                    <div class="heatmap-value">${a.toFixed(1)}%</div>
                    <div class="heatmap-meta">${0<=t?"+":""}${t.toFixed(2)} · ${e.n} bets</div>
                </div>`}),s+="</div>"}}class GameCard{constructor(e,t={}){this.game=e,this.options={compact:t.compact??!0,showHints:t.showHints??!0,index:t.index??0},this.isExpandable=e.hasRecommendation||e.kingsCall}render(){return this.options.compact?this.renderCompact():this.renderExpanded()}renderCompact(){var e=this.formatTime(this.game.datetime),{homeChip:t,awayChip:a}=this.renderAhChips(),i=this.renderHint();return`
            <div class="game-card game-card--v3" 
                 data-game-id="${this.game.datetime.getTime()}"
                 data-expandable="${this.isExpandable}"
                 data-expanded="false">
                
                <div class="game-row">
                    <div class="game-time">${e}</div>
                    
                    <div class="game-matchup">
                        <div class="team-row">
                            <span class="team-name">${this.game.home}</span>
                            ${t}
                        </div>
                        <div class="vs-separator">vs</div>
                        <div class="team-row">
                            <span class="team-name">${this.game.away}</span>
                            ${a}
                        </div>
                    </div>
                    
                    <div class="game-actions">
                        ${i}
                        ${this.isExpandable?'<div class="expand-btn" role="button" tabindex="0">▼</div>':""}
                    </div>
                </div>
                
                ${this.isExpandable?this.renderExpansion():""}
            </div>
        `}renderExpansion(){var e="High"===this.game.confidence?"👑":"Medium"===this.game.confidence?"⭐":"⚪";return`
            <div class="expanded-details hidden">
                <div class="pick-section">
                    <div class="pick-main">
                        <strong>${this.game.recText}</strong> @ ${this.game.recOdds.toFixed(2)}
                    </div>
                    <div class="pick-meta">
                        <span class="ev-badge">EV ${(100*this.game.ev).toFixed(1)}%</span>
                        <span class="confidence-icon" title="${this.game.confidence}">${e}</span>
                    </div>
                </div>
                
                ${this.game.kingsCall?`
                    <button class="analysis-toggle" onclick="window.parlayKing.toggleAnalysis(this)" aria-expanded="false">
                        Show Analysis ▼
                    </button>
                    <div class="analysis-content hidden">
                        <p class="analysis-text">${this.game.kingsCall}</p>
                    </div>
                `:""}
            </div>
        `}renderAhChips(){var e,t,a;return this.game.hasAhData?(e=e=>0===e?"PK":0<e?"+"+e:(""+e).replace("-","−"),t=this.game.hasRecommendation&&this.game.recommendedTeam===this.game.home,a=this.game.hasRecommendation&&this.game.recommendedTeam===this.game.away,t=["ah-chip",this.game.homeLine<0?"ah-chip--neg":0<this.game.homeLine?"ah-chip--pos":"ah-chip--pk",t?"ah-chip--selected":""].filter(Boolean).join(" "),a=["ah-chip",this.game.awayLine<0?"ah-chip--neg":0<this.game.awayLine?"ah-chip--pos":"ah-chip--pk",a?"ah-chip--selected":""].filter(Boolean).join(" "),{homeChip:`<span class="${t}">${e(this.game.homeLine)}</span>`,awayChip:`<span class="${a}">${e(this.game.awayLine)}</span>`}):{homeChip:'<span class="ah-chip ah-chip--empty">—</span>',awayChip:'<span class="ah-chip ah-chip--empty">—</span>'}}renderHint(){return this.game.hasRecommendation&&0<this.game.ev?'<span class="game-hint" title="Recommendation available">💎</span>':""}formatTime(e){return e?e.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",hour12:!1}):"--:--"}}class DayNavigator{constructor(e){this.parlayKing=e,this.currentDay="today"}render(){var e=new Date,t=new Date(e),t=(t.setDate(t.getDate()+1),new Date(e));return t.setDate(t.getDate()+2),`
            <div class="day-navigator">
                <button class="day-tab ${"today"===this.currentDay?"active":""}" 
                        data-day="today" onclick="window.parlayKing.switchDay('today')">
                    Today
                </button>
                <button class="day-tab ${"tomorrow"===this.currentDay?"active":""}" 
                        data-day="tomorrow" onclick="window.parlayKing.switchDay('tomorrow')">
                    Tomorrow
                </button>
                <button class="day-tab ${"dayafter"===this.currentDay?"active":""}" 
                        data-day="dayafter" onclick="window.parlayKing.switchDay('dayafter')">
                    ${t.toLocaleDateString("en-US",{weekday:"short"})}
                </button>
            </div>
        `}}window.addEventListener("error",e=>{if(e.filename&&(e.filename.includes("extension")||e.filename.includes("evmAsk")||e.filename.includes("chrome-extension")||!e.filename.includes(window.location.host)))return e.preventDefault(),!0}),document.addEventListener("DOMContentLoaded",()=>{window.parlayKing=new ParlayKing;let e=window.location.pathname;setTimeout(()=>{e.includes("analytics.html")&&"function"==typeof window.parlayKing.initAnalyticsPage?window.parlayKing.initAnalyticsPage():e.includes("recommendations.html")&&"function"==typeof window.parlayKing.initRecommendationsPage?window.parlayKing.initRecommendationsPage():(e.includes("index.html")||"/"===e||""===e||e.endsWith("/"))&&setTimeout(()=>{window.parlayKing&&"function"==typeof window.parlayKing.initScheduleFilters&&window.parlayKing.initScheduleFilters()},100)},500)}),document.addEventListener("visibilitychange",()=>{!document.hidden&&window.parlayKing&&setTimeout(()=>{window.parlayKing.loadAllData()},1e3)}),document.querySelectorAll(".expand-btn").forEach(i=>{i.addEventListener("click",e=>{let t=e.target.closest(".rec-card");var a,e=t.querySelector(".kings-call");e.classList.toggle("hidden"),e.classList.contains("hidden")||e.textContent||(e.classList.add("loading"),e.textContent="",a=this.data.recommendations.find(e=>e.id===t.dataset.id),e.textContent=a?a.kingsCall:"No insights",e.classList.remove("loading")),i.textContent=e.classList.contains("hidden")?"Show Analysis":"Hide Analysis"})}),document.querySelectorAll(".analysis-toggle").forEach(a=>{a.addEventListener("click",e=>{var e=e.target.nextElementSibling,t="true"===a.getAttribute("aria-expanded");e.classList.toggle("hidden",t),a.setAttribute("aria-expanded",!t),a.textContent=t?"Show Analysis ▼":"Hide Analysis ▲"})});